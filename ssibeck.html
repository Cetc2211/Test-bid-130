<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluaci√≥n SSI - CBTa 130</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1c1e; }
    header { background: linear-gradient(135deg, #4527a0 0%, #7b1fa2 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #4527a0; text-align: center; margin-top: 0; border-bottom: 2px solid #e1bee7; padding-bottom: 10px; }
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 8px; }
    input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    
    .question-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
    .question-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; color: #2c0e58; }
    
    /* ALINEACI√ìN CORREGIDA */
    .option-label { display: flex; align-items: flex-start; padding: 10px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; }
    .option-label:hover { background-color: #f3e5f5; }
    .option-label input { margin-right: 12px; margin-top: 4px; width: 20px; height: 20px; flex-shrink: 0; }
    
    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .reset { background-color: #757575; }
    .btn-back { background-color: #78909c; }
    
    #result-area { display: none; text-align: center; margin-top: 20px; padding: 20px; background: #f3e5f5; border-radius: 10px; }
    #conditional-block { display: block; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em;">Escala de Ideaci√≥n (SSI)</span></header>
<div class="container">
    <div id="test-form">
        <h2>Datos del Alumno</h2>
        <div class="input-group"><label>Nombre:</label><input type="text" id="nombre" required></div>
        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha" required></div>
        <div style="background-color:#f3e5f5; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #7b1fa2;">
            <strong>Instrucciones:</strong> Elija la opci√≥n que mejor describa su actitud <strong>actual o m√°s reciente</strong>.
        </div>
        <form id="ssiForm">
            <div id="part1"></div>
            <div id="conditional-block">
                <div style="text-align:center; color:#7b1fa2; margin:20px 0; font-weight:bold;">--- DETALLES ---</div>
                <div id="part234"></div>
            </div>
            <div style="text-align:center; color:#7b1fa2; margin:20px 0; font-weight:bold;">--- ANTECEDENTES ---</div>
            <div id="part5"></div>
        </form>
        <div class="buttons">
            <button type="button" class="whatsapp" onclick="finalizarTest()">‚úÖ Finalizar</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar y Volver</button>
        </div>
    </div>
    <div id="result-area">
        <h3 style="color:#4527a0;">Resultados Listos</h3>
        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar WhatsApp</button>
            <button type="button" class="reset" onclick="location.reload()">üîÑ Nuevo</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Ir al Men√∫</button>
        </div>
    </div>
</div>
<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";

    const itemsP1 = [ 
        { t: "1. Deseo de vivir", o: ["0=Moderado a Fuerte", "1=D√©bil", "2=Ninguno"] }, 
        { t: "2. Deseo de morir", o: ["0=Ninguno", "1=D√©bil", "2=Mod/Fuerte"] }, 
        { t: "3. Razones vivir/morir", o: ["0=Vivir supera a Morir", "1=Iguales", "2=Morir supera a Vivir"] }, 
        { t: "4. Deseo de intento suicida activo", o: ["0=Ninguno", "1=D√©bil", "2=Mod/Fuerte"] }, 
        { t: "5. Deseo suicida pasivo", o: ["0=Tomar√≠a precauciones para vivir", "1=Dejar√≠a al azar", "2=Evitar√≠a pasos para vivir"] } 
    ];
    const itemsP234 = [ 
        { t: "6. Dimensi√≥n temporal", o: ["0=Breve, pasajero", "1=Per√≠odos largos", "2=Continuo"] }, 
        { t: "7. Frecuencia", o: ["0=Rara, ocasional", "1=Intermitente", "2=Persistente"] }, 
        { t: "8. Actitud hacia la ideaci√≥n", o: ["0=Rechazo", "1=Ambivalente", "2=Aceptaci√≥n"] }, 
        { t: "9. Control sobre la acci√≥n", o: ["0=Tiene control", "1=Inseguro", "2=No tiene control"] }, 
        { t: "10. Factores disuasivos", o: ["0=Familia/religi√≥n", "1=Cierta preocupaci√≥n", "2=M√≠nima preocupaci√≥n"] }, 
        { t: "11. Razones del intento", o: ["0=Manipular/Atenci√≥n", "1=Combinaci√≥n", "2=Escape/Finalizar"] }, 
        { t: "12. M√©todo: Planificaci√≥n", o: ["0=No considerado", "1=No elaborado", "2=Elaborado y detallado"] }, 
        { t: "13. M√©todo: Disponibilidad", o: ["0=No disponible", "1=Tiempo/Esfuerzo", "2=Disponible"] }, 
        { t: "14. Sentido de capacidad", o: ["0=Miedo/No valor", "1=Inseguro", "2=Seguro"] }, 
        { t: "15. Expectativa de intento", o: ["0=No", "1=Incierto", "2=S√≠"] }, 
        { t: "16. Preparaci√≥n real", o: ["0=Ninguna", "1=Parcial", "2=Completa"] }, 
        { t: "17. Nota suicida", o: ["0=No escrita", "1=Empezada", "2=Completa"] }, 
        { t: "18. Actos finales", o: ["0=Ninguno", "1=Pensamientos", "2=Arreglos definitivos"] }, 
        { t: "19. Enga√±o/Ocultamiento", o: ["0=Abierto", "1=Evit√≥ tema", "2=Enga√±√≥/Ocult√≥"] } 
    ];
    const itemsP5 = [ 
        { t: "20. Intentos previos", o: ["0=Ninguno", "1=Uno", "2=M√°s de uno"] }, 
        { t: "21. Intenci√≥n en √∫ltimo intento", o: ["0=Baja", "1=Moderada", "2=Alta"] } 
    ];
    
    function render(list, id, start) { 
        const div = document.getElementById(id); 
        list.forEach((item, i) => { 
            const num = start + i; 
            let html = `<div class="question-card"><div class="question-title">${num}. ${item.t}</div>`; 
            
            item.o.forEach((txt, idx) => { 
                // CORRECCI√ìN: Extraer valor (0,1,2) del texto "0=Texto"
                let v = txt.split('=')[0]; 
                
                // Evento para preguntas 4 y 5
                const ev = (num === 4 || num === 5) ? 'onchange="verificarSalto()"' : ''; 
                
                html += `<label class="option-label">
                            <input type="radio" name="item${num}" value="${v}" ${ev}> 
                            <span style="font-size:0.95em">${txt}</span>
                         </label>`; 
            }); 
            html += `</div>`; 
            div.innerHTML += html; 
        }); 
    }

    // Renderizar al cargar
    render(itemsP1, 'part1', 1); 
    render(itemsP234, 'part234', 6); 
    render(itemsP5, 'part5', 20); 
    
    document.getElementById('fecha').valueAsDate = new Date();

    function verificarSalto() { 
        const q4 = document.querySelector('input[name="item4"]:checked'); 
        const q5 = document.querySelector('input[name="item5"]:checked'); 
        const block = document.getElementById('conditional-block'); 
        
        if (q4 && q5 && q4.value === "0" && q5.value === "0") { 
            block.style.display = 'none'; 
            // Limpiar respuestas si se oculta
            block.querySelectorAll('input').forEach(i => i.checked = false); 
        } else { 
            block.style.display = 'block'; 
        } 
    }

    let datosFinales = null;

    function finalizarTest() { 
        const nombre = document.getElementById('nombre').value; 
        const fecha = document.getElementById('fecha').value; 
        if(!nombre) { alert("Por favor ingresa el nombre."); return; } 
        
        let total = 0, flags = [], skip = false; 
        
        // Revisar 4 y 5 primero
        const q4 = document.querySelector('input[name="item4"]:checked'); 
        const q5 = document.querySelector('input[name="item5"]:checked'); 
        
        if (!q4 || !q5) { alert("Por favor contesta al menos las primeras 5 preguntas."); return; } 
        
        if (q4.value === "0" && q5.value === "0") skip = true; 

        for(let i=1; i<=19; i++) { 
            if(skip && i>=6) continue; // Saltar 6-19 si aplica
            
            const el = document.querySelector(`input[name="item${i}"]:checked`); 
            if(el) { 
                let val = parseInt(el.value); 
                total += val; 
                
                // Flags de riesgo
                if((i===4||i===5) && val>=1) flags.push(`C${i}`); 
                if([12,13,15].includes(i) && val===2) flags.push(`C${i}`); 
            } else if (!skip) { 
                alert(`Falta responder la pregunta ${i}`); return; 
            } 
        } 
        
        const q20 = document.querySelector('input[name="item20"]:checked'); 
        if(!q20) { alert("Falta responder la pregunta 20"); return; } 
        if(parseInt(q20.value)>=1) flags.push("C20"); 

        const q21 = document.querySelector('input[name="item21"]:checked'); 
        if(!q21) { alert("Falta responder la pregunta 21"); return; }

        datosFinales = { nombre, fecha, total, flags }; 
        
        document.getElementById('test-form').style.display = 'none'; 
        document.getElementById('result-area').style.display = 'block'; 
        window.scrollTo(0,0); 
    }

    function guardarLocalmente() { 
        if(!datosFinales) return; 
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; 
        let up = { 
            ...cur, 
            nombre: datosFinales.nombre, 
            ssi: datosFinales.total, 
            ssiFlags: datosFinales.flags.join(',') 
        }; 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up)); 
        alert("‚úÖ Datos SSI guardados en el expediente."); 
    }

    function enviarWhatsApp(){ 
        if(!datosFinales) return; 
        let m = `üü£ *SSI*%0Aüë§ ${datosFinales.nombre}%0Aüìä Score: ${datosFinales.total}`; 
        if(datosFinales.flags.length > 0) m += `%0Aüö© Alertas: ${datosFinales.flags.join(',')}`; 
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank'); 
    }
</script>
</body>
</html>


