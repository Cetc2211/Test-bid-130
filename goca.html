<!DOCTYPE html>
<html lang="es"><!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOCA - Observaci√≥n Conductual</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; color: #1c1c1e; margin: 0; }
    header { background: linear-gradient(135deg, #ff8f00 0%, #ffb300 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #ff6f00; text-align: center; margin-top: 0; border-bottom: 2px solid #ffe082; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }
    input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    .section-title { 
        background: #fff8e1; color: #ff6f00; padding: 10px; font-weight: bold; 
        margin-top: 30px; border-left: 5px solid #ff8f00; border-radius: 4px;
    }
    
    /* TABLA FIJA PARA IPAD */
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 10px; 
        font-size: 0.85rem; 
        min-width: 800px; /* Asegura scroll horizontal si es necesario */
        table-layout: fixed; /* Fija los anchos */
    }
    
    th, td { padding: 8px 5px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
    
    /* Anchos de columna */
    th:first-child, td:first-child { width: 35%; text-align: left; padding-left: 10px; font-weight: 500; white-space: normal; } /* Conducta */
    th:nth-child(n+2):nth-child(-n+7), td:nth-child(n+2):nth-child(-n+7) { width: 8%; } /* Radio buttons */
    th:last-child, td:last-child { width: 17%; } /* Observaciones */
    
    th { background-color: #fff3e0; color: #e65100; font-weight: bold; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    input[type="radio"] { width: 20px; height: 20px; margin: 0 auto; display: block; cursor: pointer; accent-color: #ff8f00; }
    input.obs-input { width: 95%; border: none; border-bottom: 1px solid #ccc; background: transparent; font-size: 0.8rem; padding: 2px; }

    .results-panel { background: #e0f7fa; padding: 20px; border-radius: 10px; margin-top: 30px; display: none; border: 1px solid #00acc1; }
    .score-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; }
    
    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .btn-pdf { background-color: #ff8f00; }
    .btn-back { background-color: #78909c; }
    .reset { background-color: #757575; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Gu√≠a de Observaci√≥n Conductual (GOCA)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos de Identificaci√≥n</h2>
        <div class="input-group"><label>Estudiante:</label><input type="text" id="nombre"></div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Edad:</label><input type="number" id="edad"></div>
            <div style="flex:1"><label>Grupo/Sem:</label><input type="text" id="grupo"></div>
        </div>
        <div class="input-group"><label>Docente Observador:</label><input type="text" id="docente"></div>
        <div class="input-group"><label>Asignatura:</label><input type="text" id="asignatura"></div>
        <div class="input-group"><label>Fecha Reporte:</label><input type="date" id="fecha"></div>

        <div style="background:#fff3e0; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #ff6f00;">
            <strong>Instrucciones:</strong> Marque la frecuencia observada (0=Nunca, 4=Siempre). N/O = No Observado (cuenta como 0).
        </div>

        <form id="gocaForm">
            <div id="sections-container"></div>
            <div class="input-group" style="margin-top:30px;">
                <label>Observaciones Adicionales del Docente:</label>
                <textarea id="obsDocente" style="width:100%; height:100px; padding:10px; border:1px solid #ccc; border-radius:6px; font-family:inherit;"></textarea>
            </div>
        </form>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="calcularGOCA()">üìä Calcular Resultados</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar y Volver</button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="results-area" class="results-panel">
        <h3 style="color:#006064; text-align:center;">Resultados GOCA</h3>
        <div id="score-details"></div>
        <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
        <div id="interpretation" style="font-weight:bold; text-align:center; font-size:1.1em;"></div>
        <div id="critical-areas" style="margin-top:15px; color:#c62828;"></div>

        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="btn-pdf" onclick="generarPDFGOCA()">üìÑ Generar Reporte PDF</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar Resumen WhatsApp</button>
            <button type="button" class="reset" onclick="location.reload()">üîÑ Nueva Observaci√≥n</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Ir al Men√∫</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    // Nombres expl√≠citos 'name' para evitar errores de corte de texto
    const secciones = [
        { 
            id: 'I', title: 'I. ATENCI√ìN Y CONCENTRACI√ìN', name: 'ATENCI√ìN Y CONCENTRACI√ìN',
            items: [
                "1. Se distrae f√°cilmente con ruidos externos",
                "2. Necesita repetici√≥n de instrucciones",
                "3. Deja actividades incompletas",
                "4. Parece 'so√±ando despierto'",
                "5. Pierde materiales escolares",
                "6. Dificultad para seguir explicaciones largas",
                "7. Se levanta sin permiso",
                "8. Juega con objetos en clase"
            ]
        },
        { 
            id: 'II', title: 'II. PARTICIPACI√ìN Y MOTIVACI√ìN', name: 'PARTICIPACI√ìN Y MOTIVACI√ìN',
            items: [
                "9. Evita participar al preguntar",
                "10. No trae materiales necesarios",
                "11. Comentarios negativos sobre escuela",
                "12. Ap√°tico o desinteresado",
                "13. No completa tareas de casa",
                "14. Evita esfuerzo mental sostenido",
                "15. No toma apuntes",
                "16. Llega tarde sin justificaci√≥n"
            ]
        },
        { 
            id: 'III', title: 'III. EMOCIONALES Y CONDUCTUALES', name: 'EMOCIONALES Y CONDUCTUALES',
            items: [
                "17. Triste o cabizbajo",
                "18. Irritabilidad o enojo f√°cil",
                "19. Se a√≠sla en actividades grupales",
                "20. Signos de ansiedad (morder u√±as, etc)",
                "21. Cambios bruscos de humor",
                "22. Quejas de dolores f√≠sicos",
                "23. Llora o parece a punto de llorar",
                "24. Conductas agresivas"
            ]
        },
        { 
            id: 'IV', title: 'IV. RENDIMIENTO', name: 'RENDIMIENTO ACAD√âMICO',
            items: [
                "25. Disminuci√≥n calidad trabajos",
                "26. Dificultad comprender conceptos",
                "27. Errores por descuido",
                "28. Rendimiento inconsistente",
                "29. No termina ex√°menes a tiempo",
                "30. Evita preguntar dudas",
                "31. Calificaciones han bajado",
                "32. Copia trabajos"
            ]
        },
        { 
            id: 'V', title: 'V. F√çSICOS Y SALUD', name: 'F√çSICOS Y SALUD',
            items: [
                "33. Cansado o con sue√±o",
                "34. Aspecto descuidado/higiene",
                "35. No desayuna o come",
                "36. Signos consumo sustancias",
                "37. Problemas visi√≥n/audici√≥n",
                "38. Cambio peso significativo",
                "39. Lesiones visibles frecuentes",
                "40. Permisos ba√±o/enfermer√≠a"
            ]
        },
        { 
            id: 'VI', title: 'VI. FACTORES PROTECTORES (Positivos)', name: 'FACTORES PROTECTORES',
            items: [
                "41. Inter√©s en alg√∫n tema",
                "42. Tiene amigos cercanos",
                "43. Responde bien al elogio",
                "44. Muestra habilidades espec√≠ficas",
                "45. Busca ayuda si necesita"
            ]
        }
    ];

    const container = document.getElementById('sections-container');
    secciones.forEach(sec => {
        let html = `<div class="section-title">${sec.title}</div>
        <div class="table-container"><table><thead>
            <tr><th>Conducta</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>N/O</th><th>Obs</th></tr>
        </thead><tbody>`;
        
        sec.items.forEach((txt) => {
            let globalIdx = parseInt(txt.split('.')[0]); 
            html += `<tr>
                <td>${txt}</td>
                ${[0,1,2,3,4].map(v => `<td><input type="radio" name="g${globalIdx}" value="${v}"></td>`).join('')}
                <td><input type="radio" name="g${globalIdx}" value="0"></td> 
                <td><input type="text" class="obs-input" id="obs${globalIdx}"></td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
        container.innerHTML += html;
    });

    let resultados = null;

    function calcularGOCA() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Ingrese el nombre del estudiante"); return; }

        let scores = { I:0, II:0, III:0, IV:0, V:0, VI:0 };
        let totalRiesgo = 0;
        let criticos = [];

        secciones.forEach(sec => {
            let subtotal = 0;
            sec.items.forEach(txt => {
                let id = parseInt(txt.split('.')[0]);
                const el = document.querySelector(`input[name="g${id}"]:checked`);
                if(el) subtotal += parseInt(el.value);
            });
            scores[sec.id] = subtotal;
            
            if(sec.id !== 'VI') {
                totalRiesgo += subtotal;
                if(subtotal >= 20) criticos.push(sec.name); 
            }
        });

        let nivel = "";
        if(totalRiesgo <= 40) nivel = "Sin indicadores significativos";
        else if(totalRiesgo <= 80) nivel = "Alerta Moderada";
        else if(totalRiesgo <= 120) nivel = "RIESGO ALTO";
        else nivel = "SITUACI√ìN CR√çTICA";

        let prot = scores.VI;
        let nivelProt = prot <= 5 ? "Insuficientes" : prot <= 10 ? "Limitados" : prot <= 15 ? "Moderados" : "Fuertes";

        resultados = { nombre, scores, totalRiesgo, nivel, nivelProt, criticos };
        mostrarResultados();
    }

    function mostrarResultados() {
        document.getElementById('test-form').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        
        let html = "";
        for(let k in resultados.scores) {
            html += `<div class="score-row"><span>${k}:</span> <strong>${resultados.scores[k]} pts</strong></div>`;
        }
        document.getElementById('score-details').innerHTML = html;
        document.getElementById('interpretation').innerText = `Riesgo Global: ${resultados.totalRiesgo} (${resultados.nivel})`;
        
        if(resultados.criticos.length > 0) {
            document.getElementById('critical-areas').innerText = "‚ö†Ô∏è √ÅREAS CR√çTICAS: " + resultados.criticos.join(", ");
        }
        window.scrollTo(0,0);
    }

    function guardarLocalmente() {
        if(!resultados) return;
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let up = { 
            ...cur, nombre: resultados.nombre, goca: resultados.totalRiesgo, gocaNivel: resultados.nivel
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up));
        alert("‚úÖ GOCA guardado en expediente.");
    }

    function generarPDFGOCA() {
        if(!resultados) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        doc.setFont("helvetica", "bold"); doc.setFontSize(14);
        doc.text("GU√çA DE OBSERVACI√ìN CONDUCTUAL (GOCA)", 105, y, null, null, "center"); y+=10;
        
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        const docente = document.getElementById('docente').value;
        const asig = document.getElementById('asignatura').value;
        const fecha = document.getElementById('fecha').value;
        
        doc.text(`Estudiante: ${resultados.nombre}`, 15, y); 
        doc.text(`Fecha: ${fecha}`, 140, y); y+=6;
        doc.text(`Docente: ${docente}`, 15, y);
        doc.text(`Asignatura: ${asig}`, 140, y); y+=10;

        doc.setFillColor(230); doc.rect(15, y, 180, 8, 'F');
        doc.setFont("helvetica", "bold");
        doc.text("RESUMEN DE PUNTUACI√ìN", 20, y+5); y+=12;

        const addRow = (label, pts, max) => {
            let pct = Math.round((pts/max)*100);
            doc.text(label, 20, y);
            doc.text(`${pts} / ${max}`, 120, y);
            doc.text(`${pct}%`, 160, y);
            y+=7;
        };

        doc.setFont("helvetica", "normal");
        addRow("I. Atenci√≥n", resultados.scores.I, 32);
        addRow("II. Participaci√≥n", resultados.scores.II, 32);
        addRow("III. Emocional", resultados.scores.III, 32);
        addRow("IV. Rendimiento", resultados.scores.IV, 32);
        addRow("V. F√≠sicos/Salud", resultados.scores.V, 32);
        
        y+=2;
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL RIESGO: ${resultados.totalRiesgo} pts (${resultados.nivel})`, 20, y); y+=10;
        
        doc.setFont("helvetica", "normal");
        addRow("VI. Factores Protectores", resultados.scores.VI, 20);
        doc.text(`Nivel Protecci√≥n: ${resultados.nivelProt}`, 20, y); y+=10;

        if(resultados.criticos.length > 0) {
            doc.setTextColor(198, 40, 40);
            doc.text("√ÅREAS DE ATENCI√ìN PRIORITARIA:", 20, y); y+=6;
            resultados.criticos.forEach(c => { doc.text(`‚Ä¢ ${c}`, 25, y); y+=5; });
            doc.setTextColor(0);
        }

        y+=10;
        doc.setFont("helvetica", "bold"); doc.text("Observaciones del Docente:", 15, y); y+=6;
        doc.setFont("helvetica", "normal");
        const obs = document.getElementById('obsDocente').value;
        const lines = doc.splitTextToSize(obs, 180);
        doc.text(lines, 15, y);

        doc.save(`GOCA_${resultados.nombre}.pdf`);
    }

    function enviarWhatsApp() {
        if(!resultados) return;
        let m = `üè´ *REPORTE GOCA*%0Aüë§ Alumno: ${resultados.nombre}%0Aüìä Riesgo: ${resultados.totalRiesgo} (${resultados.nivel})%0Aüõ°Ô∏è Protectores: ${resultados.scores.VI}`;
        if(resultados.criticos.length > 0) m += `%0A‚ö†Ô∏è √Åreas Cr√≠ticas: ${resultados.criticos.join(', ')}`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank');
    }
</script>
</body>
</html>



<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOCA - Observaci√≥n Conductual</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; color: #1c1c1e; margin: 0; }
    /* Encabezado AMBAR/DORADO */
    header { background: linear-gradient(135deg, #ff8f00 0%, #ffb300 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #ff6f00; text-align: center; margin-top: 0; border-bottom: 2px solid #ffe082; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }
    input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    /* Secciones del Test */
    .section-title { 
        background: #fff8e1; color: #ff6f00; padding: 10px; font-weight: bold; 
        margin-top: 30px; border-left: 5px solid #ff8f00; border-radius: 4px;
    }
    
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; min-width: 700px; table-layout: fixed; }
    
    th, td { padding: 8px 5px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
    th:first-child, td:first-child { width: 40%; text-align: left; padding-left: 10px; font-weight: 500; white-space: normal; }
    th:last-child, td:last-child { width: 15%; } /* Observaciones */
    
    th { background-color: #fff3e0; color: #e65100; font-weight: bold; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    input[type="radio"] { width: 20px; height: 20px; margin: 0 auto; display: block; cursor: pointer; accent-color: #ff8f00; }
    input.obs-input { width: 90%; border: none; border-bottom: 1px solid #ccc; background: transparent; font-size: 0.8rem; }

    /* Resultados */
    .results-panel { background: #e0f7fa; padding: 20px; border-radius: 10px; margin-top: 30px; display: none; border: 1px solid #00acc1; }
    .score-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; }
    .critical { color: #c62828; font-weight: bold; }

    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .btn-pdf { background-color: #ff8f00; }
    .btn-back { background-color: #78909c; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Gu√≠a de Observaci√≥n Conductual (GOCA)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos de Identificaci√≥n</h2>
        <div class="input-group"><label>Estudiante:</label><input type="text" id="nombre"></div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Edad:</label><input type="number" id="edad"></div>
            <div style="flex:1"><label>Grupo/Sem:</label><input type="text" id="grupo"></div>
        </div>
        <div class="input-group"><label>Docente Observador:</label><input type="text" id="docente"></div>
        <div class="input-group"><label>Asignatura:</label><input type="text" id="asignatura"></div>
        <div class="input-group"><label>Fecha Reporte:</label><input type="date" id="fecha"></div>

        <div style="background:#fff3e0; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #ff6f00;">
            <strong>Instrucciones:</strong> Marque la frecuencia observada (0=Nunca, 4=Siempre). N/O = No Observado (cuenta como 0).
        </div>

        <form id="gocaForm">
            <!-- SECCIONES GENERADAS POR JS -->
            <div id="sections-container"></div>
            
            <div class="input-group" style="margin-top:30px;">
                <label>Observaciones Adicionales del Docente:</label>
                <textarea id="obsDocente" style="width:100%; height:100px; padding:10px; border:1px solid #ccc; border-radius:6px;"></textarea>
            </div>
        </form>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="calcularGOCA()">üìä Calcular Resultados</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar</button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="results-area" class="results-panel">
        <h3 style="color:#006064; text-align:center;">Resultados GOCA</h3>
        
        <div id="score-details"></div>
        
        <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
        <div id="interpretation" style="font-weight:bold; text-align:center; font-size:1.1em;"></div>
        <div id="critical-areas" style="margin-top:15px; color:#c62828;"></div>

        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="btn-pdf" onclick="generarPDFGOCA()">üìÑ Generar Reporte PDF</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar Resumen WhatsApp</button>
            <button type="button" class="btn-back" onclick="location.reload()">üîÑ Nueva Observaci√≥n</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    // Estructura de Datos con NOMBRES LIMPIOS para evitar errores de ortograf√≠a en PDF
    const secciones = [
        { 
            id: 'I', title: 'I. ATENCI√ìN Y CONCENTRACI√ìN', name: 'ATENCI√ìN Y CONCENTRACI√ìN',
            items: [
                "1. Se distrae f√°cilmente con ruidos externos",
                "2. Necesita repetici√≥n de instrucciones",
                "3. Deja actividades incompletas",
                "4. Parece 'so√±ando despierto'",
                "5. Pierde materiales escolares",
                "6. Dificultad para seguir explicaciones largas",
                "7. Se levanta sin permiso",
                "8. Juega con objetos en clase"
            ]
        },
        { 
            id: 'II', title: 'II. PARTICIPACI√ìN Y MOTIVACI√ìN', name: 'PARTICIPACI√ìN Y MOTIVACI√ìN',
            items: [
                "9. Evita participar al preguntar",
                "10. No trae materiales necesarios",
                "11. Comentarios negativos sobre escuela",
                "12. Ap√°tico o desinteresado",
                "13. No completa tareas de casa",
                "14. Evita esfuerzo mental sostenido",
                "15. No toma apuntes",
                "16. Llega tarde sin justificaci√≥n"
            ]
        },
        { 
            id: 'III', title: 'III. EMOCIONALES Y CONDUCTUALES', name: 'EMOCIONALES Y CONDUCTUALES',
            items: [
                "17. Triste o cabizbajo",
                "18. Irritabilidad o enojo f√°cil",
                "19. Se a√≠sla en actividades grupales",
                "20. Signos de ansiedad (morder u√±as, etc)",
                "21. Cambios bruscos de humor",
                "22. Quejas de dolores f√≠sicos",
                "23. Llora o parece a punto de llorar",
                "24. Conductas agresivas"
            ]
        },
        { 
            id: 'IV', title: 'IV. RENDIMIENTO', name: 'RENDIMIENTO ACAD√âMICO',
            items: [
                "25. Disminuci√≥n calidad trabajos",
                "26. Dificultad comprender conceptos",
                "27. Errores por descuido",
                "28. Rendimiento inconsistente",
                "29. No termina ex√°menes a tiempo",
                "30. Evita preguntar dudas",
                "31. Calificaciones han bajado",
                "32. Copia trabajos"
            ]
        },
        { 
            id: 'V', title: 'V. F√çSICOS Y SALUD', name: 'F√çSICOS Y SALUD',
            items: [
                "33. Cansado o con sue√±o",
                "34. Aspecto descuidado/higiene",
                "35. No desayuna o come",
                "36. Signos consumo sustancias",
                "37. Problemas visi√≥n/audici√≥n",
                "38. Cambio peso significativo",
                "39. Lesiones visibles frecuentes",
                "40. Permisos ba√±o/enfermer√≠a"
            ]
        },
        { 
            id: 'VI', title: 'VI. FACTORES PROTECTORES (Positivos)', name: 'FACTORES PROTECTORES',
            items: [
                "41. Inter√©s en alg√∫n tema",
                "42. Tiene amigos cercanos",
                "43. Responde bien al elogio",
                "44. Muestra habilidades espec√≠ficas",
                "45. Busca ayuda si necesita"
            ]
        }
    ];

    // Generar HTML
    const container = document.getElementById('sections-container');
    secciones.forEach(sec => {
        let html = `<div class="section-title">${sec.title}</div>
        <div class="table-container"><table><thead>
            <tr><th>Conducta</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>N/O</th><th>Obs</th></tr>
        </thead><tbody>`;
        
        sec.items.forEach((txt, idx) => {
            let globalIdx = parseInt(txt.split('.')[0]); 
            html += `<tr>
                <td>${txt}</td>
                ${[0,1,2,3,4].map(v => `<td><input type="radio" name="g${globalIdx}" value="${v}"></td>`).join('')}
                <td><input type="radio" name="g${globalIdx}" value="0"></td> 
                <td><input type="text" class="obs-input" id="obs${globalIdx}"></td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
        container.innerHTML += html;
    });

    let resultados = null;

    function calcularGOCA() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Ingrese el nombre del estudiante"); return; }

        let scores = { I:0, II:0, III:0, IV:0, V:0, VI:0 };
        let totalRiesgo = 0;
        let criticos = [];

        // Calcular por secci√≥n
        secciones.forEach(sec => {
            let subtotal = 0;
            sec.items.forEach(txt => {
                let id = parseInt(txt.split('.')[0]);
                const el = document.querySelector(`input[name="g${id}"]:checked`);
                if(el) subtotal += parseInt(el.value);
            });
            scores[sec.id] = subtotal;
            
            // Riesgo (I-V) y Protectores (VI)
            if(sec.id !== 'VI') {
                totalRiesgo += subtotal;
                // CORRECCI√ìN: Usamos 'sec.name' en lugar de cortar el string del t√≠tulo
                if(subtotal >= 20) criticos.push(sec.name); 
            }
        });

        // Interpretaci√≥n Riesgo
        let nivel = "";
        if(totalRiesgo <= 40) nivel = "Sin indicadores significativos";
        else if(totalRiesgo <= 80) nivel = "Alerta Moderada (Seguimiento)";
        else if(totalRiesgo <= 120) nivel = "RIESGO ALTO (Referir)";
        else nivel = "SITUACI√ìN CR√çTICA (Intervenci√≥n)";

        // Interpretaci√≥n Protectores
        let prot = scores.VI;
        let nivelProt = "";
        if(prot <= 5) nivelProt = "Insuficientes";
        else if(prot <= 10) nivelProt = "Limitados";
        else if(prot <= 15) nivelProt = "Moderados";
        else nivelProt = "Fuertes";

        resultados = { nombre, scores, totalRiesgo, nivel, nivelProt, criticos };
        mostrarResultados();
    }

    function mostrarResultados() {
        document.getElementById('test-form').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        
        let html = "";
        for(let k in resultados.scores) {
            html += `<div class="score-row"><span>${k}:</span> <strong>${resultados.scores[k]} pts</strong></div>`;
        }
        document.getElementById('score-details').innerHTML = html;
        document.getElementById('interpretation').innerText = `Riesgo Global: ${resultados.totalRiesgo} (${resultados.nivel})`;
        
        if(resultados.criticos.length > 0) {
            document.getElementById('critical-areas').innerText = "‚ö†Ô∏è √ÅREAS CR√çTICAS: " + resultados.criticos.join(", ");
        }
        window.scrollTo(0,0);
    }

    function guardarLocalmente() {
        if(!resultados) return;
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let up = { 
            ...cur, 
            nombre: resultados.nombre, 
            goca: resultados.totalRiesgo,
            gocaNivel: resultados.nivel
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up));
        alert("‚úÖ GOCA guardado en expediente.");
    }

    function generarPDFGOCA() {
        if(!resultados) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        doc.setFont("helvetica", "bold"); doc.setFontSize(14);
        doc.text("GU√çA DE OBSERVACI√ìN CONDUCTUAL (GOCA)", 105, y, null, null, "center"); y+=10;
        
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        const docente = document.getElementById('docente').value;
        const asig = document.getElementById('asignatura').value;
        const fecha = document.getElementById('fecha').value;
        
        doc.text(`Estudiante: ${resultados.nombre}`, 15, y); 
        doc.text(`Fecha: ${fecha}`, 140, y); y+=6;
        doc.text(`Docente: ${docente}`, 15, y);
        doc.text(`Asignatura: ${asig}`, 140, y); y+=10;

        // Tabla Resultados
        doc.setFillColor(230); doc.rect(15, y, 180, 8, 'F');
        doc.setFont("helvetica", "bold");
        doc.text("RESUMEN DE PUNTUACI√ìN", 20, y+5); y+=12;

        const addRow = (label, pts, max) => {
            let pct = Math.round((pts/max)*100);
            doc.text(label, 20, y);
            doc.text(`${pts} / ${max}`, 120, y);
            doc.text(`${pct}%`, 160, y);
            y+=7;
        };

        doc.setFont("helvetica", "normal");
        // Usar nombres limpios aqu√≠ tambi√©n
        addRow("I. Atenci√≥n", resultados.scores.I, 32);
        addRow("II. Participaci√≥n", resultados.scores.II, 32);
        addRow("III. Emocional", resultados.scores.III, 32);
        addRow("IV. Rendimiento", resultados.scores.IV, 32);
        addRow("V. F√≠sicos/Salud", resultados.scores.V, 32);
        
        y+=2;
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL RIESGO: ${resultados.totalRiesgo} pts (${resultados.nivel})`, 20, y); y+=10;
        
        doc.setFont("helvetica", "normal");
        addRow("VI. Factores Protectores", resultados.scores.VI, 20);
        doc.text(`Nivel Protecci√≥n: ${resultados.nivelProt}`, 20, y); y+=10;

        if(resultados.criticos.length > 0) {
            doc.setTextColor(198, 40, 40);
            doc.text("√ÅREAS DE ATENCI√ìN PRIORITARIA:", 20, y); y+=6;
            resultados.criticos.forEach(c => { doc.text(`‚Ä¢ ${c}`, 25, y); y+=5; });
            doc.setTextColor(0);
        }

        y+=10;
        doc.setFont("helvetica", "bold"); doc.text("Observaciones del Docente:", 15, y); y+=6;
        doc.setFont("helvetica", "normal");
        const obs = document.getElementById('obsDocente').value;
        const lines = doc.splitTextToSize(obs, 180);
        doc.text(lines, 15, y);

        doc.save(`GOCA_${resultados.nombre}.pdf`);
    }

    function enviarWhatsApp() {
        if(!resultados) return;
        let m = `üè´ *REPORTE GOCA*%0Aüë§ Alumno: ${resultados.nombre}%0Aüìä Riesgo: ${resultados.totalRiesgo} (${resultados.nivel})%0Aüõ°Ô∏è Protectores: ${resultados.scores.VI}`;
        if(resultados.criticos.length > 0) m += `%0A‚ö†Ô∏è √Åreas Cr√≠ticas: ${resultados.criticos.join(', ')}`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank');
    }
</script>
</body>
</html>

