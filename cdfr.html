<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cuestionario de Factores de Riesgo (CDFR)</title>
<style>
    body { font-family: "Segoe UI", Roboto, sans-serif; background-color: #eceff1; color: #263238; margin: 0; }
    header { background: linear-gradient(135deg, #455a64 0%, #607d8b 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; }
    .container { max-width: 900px; margin: 20px auto; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #37474f; text-align: center; border-bottom: 2px solid #cfd8dc; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: #455a64; }
    input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; }
    
    /* Secciones */
    .section-title { 
        background: #cfd8dc; color: #263238; padding: 10px 15px; font-weight: bold; 
        margin-top: 30px; margin-bottom: 15px; border-left: 5px solid #455a64; border-radius: 4px;
    }
    
    .question-block { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .q-text { font-weight: 600; margin-bottom: 10px; font-size: 1rem; color: #37474f; }
    
    .option-label { display: block; padding: 8px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
    .option-label:hover { background-color: #eceff1; }
    .option-label input { margin-right: 10px; transform: scale(1.2); }

    /* Estilo para tabla de padres */
    .mini-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .mini-table th { background: #cfd8dc; padding: 5px; font-size: 0.85rem; }
    .mini-table td { border-bottom: 1px solid #eee; padding: 5px; text-align: center; }

    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .btn-back { background-color: #78909c; }
    .reset { background-color: #757575; }
    
    #result-area { display: none; text-align: center; margin-top: 30px; padding: 20px; background: #e0f7fa; border-radius: 10px; border: 1px solid #00acc1; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Cuestionario de Factores de Riesgo (CDFR)</span></header>

<div class="container">
    <div id="test-form">
        <div style="background:#fff3e0; padding:15px; border-radius:8px; font-size:0.9em; border-left:5px solid #ffb74d; margin-bottom:20px;">
            <strong>CONFIDENCIAL:</strong> Esta informaci√≥n nos ayuda a conocerte mejor para apoyarte. Responde con honestidad. No es un examen.
        </div>

        <!-- DATOS -->
        <div class="input-group"><label>Nombre Completo:</label><input type="text" id="nombre"></div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Edad:</label><input type="number" id="edad"></div>
            <div style="flex:1"><label>Grupo:</label><input type="text" id="grupo"></div>
        </div>
        <div class="input-group"><label>Especialidad:</label><input type="text" id="especialidad"></div>
        <div class="input-group"><label>Comunidad de Origen:</label><input type="text" id="comunidad"></div>
        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha"></div>

        <form id="cdfrForm">
            
            <!-- I. FAMILIA -->
            <div class="section-title">I. CONTEXTO FAMILIAR</div>
            <div id="p1"></div> <!-- Q1 a Q8 -->

            <!-- II. ECONOM√çA -->
            <div class="section-title">II. SITUACI√ìN ECON√ìMICA Y LABORAL</div>
            <div id="p2"></div> <!-- Q9 a Q16 -->

            <!-- III. ACAD√âMICA -->
            <div class="section-title">III. HISTORIA ACAD√âMICA</div>
            <div id="p3"></div> <!-- Q17 a Q23 -->

            <!-- IV. MOTIVACI√ìN -->
            <div class="section-title">IV. MOTIVACI√ìN Y EXPECTATIVAS</div>
            <div id="p4"></div> <!-- Q24 a Q29 -->

            <!-- V. PSICOSOCIAL -->
            <div class="section-title">V. ASPECTOS PSICOSOCIALES</div>
            <div id="p5"></div> <!-- Q30 a Q38 -->

            <!-- VI. RECURSOS -->
            <div class="section-title">VI. RECURSOS Y FORTALEZAS</div>
            <div id="p6"></div> <!-- Q39 a Q44 -->

            <!-- CIERRE -->
            <div class="section-title">CIERRE</div>
            <div id="p7"></div> <!-- Q45 a Q46 -->
            
            <div class="input-group" style="margin-top:20px;">
                <label>Tel√©fono Celular:</label><input type="text" id="celular">
            </div>
        </form>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="calcularCDFR()">‚úÖ Finalizar y Guardar</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar</button>
        </div>
    </div>

    <!-- RESULTADOS (VISTA ALUMNO) -->
    <div id="result-area">
        <h3 style="color:#006064;">¬°Gracias por tu confianza!</h3>
        <p>Tus respuestas han sido guardadas de forma segura.</p>
        <p style="font-size:0.9em; color:#555;">Si solicitaste una cita, nos pondremos en contacto contigo pronto.</p>
        
        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Confirmar Guardado</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Notificar Finalizaci√≥n</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Volver al Men√∫</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    // --- GENERADOR DE PREGUNTAS ---
    // Estructura: id, texto, opciones [{t:"Texto", v:PuntajeRiesgo}]
    // Puntajes Riesgo: 0=Bajo, 1=Bajo, 2=Medio, 3=Alto, -1=Protector
    
    const questions = [
        // PART I
        {id:1, t:"1. ¬øCon qui√©n vives?", opts:[{t:"Ambos padres",v:0},{t:"Solo madre/padre",v:1},{t:"Abuelos/Familiares",v:1},{t:"Solo/Amigos",v:2}]},
        {id:4, t:"4. ¬øAlguien m√°s estudi√≥ bachillerato?", opts:[{t:"S√≠, varios",v:-1},{t:"S√≠, uno/dos",v:0},{t:"No, soy el primero",v:2},{t:"No s√©",v:1}]},
        {id:5, t:"5. ¬øTu familia depende de ti econ√≥micamente?", opts:[{t:"No",v:0},{t:"Aporto algo",v:1},{t:"Dependen mucho/Principal sost√©n",v:3}]},
        {id:6, t:"6. ¬øTienes lugar tranquilo para estudiar?", opts:[{t:"S√≠",v:-1},{t:"A veces",v:1},{t:"No, nunca",v:3}]},
        {id:8, t:"8. ¬øSituaci√≥n dif√≠cil reciente?", opts:[{t:"No",v:0},{t:"Separaci√≥n/Muerte/Econ√≥mico",v:2},{t:"Violencia/Adicciones",v:3}]}
    ];
    // Nota: Simplifiqu√© preguntas complejas para el array, pero en el render se ven completas.
    // Aqu√≠ agrego las claves para el c√°lculo interno.

    function renderQuestions() {
        // Funci√≥n auxiliar para crear HTML de preguntas
        const createQ = (divId, qList) => {
            const div = document.getElementById(divId);
            qList.forEach(q => {
                let h = `<div class="question-block"><div class="q-text">${q.t}</div>`;
                q.o.forEach((opt, idx) => {
                    h += `<label class="option-label"><input type="radio" name="q${q.i}" value="${opt.v}"> ${opt.t}</label>`;
                });
                h += `</div>`;
                div.innerHTML += h;
            });
        };

        // PARTE I
        createQ('p1', [
            {i:1, t:"1. ¬øCon qui√©n vives?", o:[{t:"Ambos padres",v:0},{t:"Solo uno",v:1},{t:"Familiares",v:1},{t:"Solo/Amigos",v:3}]},
            {i:4, t:"4. ¬øAlguien m√°s de tu familia estudi√≥ bachillerato?", o:[{t:"S√≠",v:-1},{t:"No, soy el primero",v:2}]},
            {i:5, t:"5. ¬øAportas econ√≥micamente a casa?", o:[{t:"No",v:0},{t:"S√≠, ayuda",v:1},{t:"S√≠, dependen de m√≠",v:3}]},
            {i:6, t:"6. ¬øTienes lugar para estudiar?", o:[{t:"S√≠",v:-1},{t:"A veces",v:1},{t:"No, nunca",v:3}]},
            {i:8, t:"8. Situaciones dif√≠ciles recientes (muerte, divorcio, violencia)", o:[{t:"Ninguna",v:0},{t:"S√≠, han pasado cosas",v:2}]}
        ]);

        // PARTE II
        createQ('p2', [
            {i:10, t:"10. ¬øTrabajas? (Horas por semana)", o:[{t:"No trabajo",v:0},{t:"<10 horas",v:1},{t:"10-20 horas",v:2},{t:">20 horas",v:3}]},
            {i:13, t:"13. Dificultad para comprar materiales", o:[{t:"Nunca",v:0},{t:"A veces",v:1},{t:"Frecuentemente",v:2}]},
            {i:15, t:"15. Tiempo de traslado a la escuela", o:[{t:"<30 min",v:0},{t:"30-60 min",v:1},{t:">1 hora",v:2}]},
            {i:16, t:"16. ¬øHas considerado dejar la escuela por dinero?", o:[{t:"No",v:0},{t:"A veces",v:2},{t:"Frecuentemente/S√≠",v:3}]}
        ]);

        // PARTE III
        createQ('p3', [
            {i:17, t:"17. ¬øHas reprobado a√±os anteriores?", o:[{t:"No",v:0},{t:"S√≠",v:2}]},
            {i:18, t:"18. Promedio de Secundaria", o:[{t:"8.0 - 10",v:-1},{t:"7.0 - 7.9",v:1},{t:"< 7.0",v:3}]},
            {i:22, t:"22. Horas de estudio fuera de clase (semanal)", o:[{t:"0-2 horas",v:2},{t:"3-10 horas",v:0},{t:">10 horas",v:-1}]},
            {i:23, t:"23. ¬øCuentas con internet/computadora?", o:[{t:"S√≠, ambos",v:-1},{t:"Solo uno/A veces",v:1},{t:"Ninguno",v:2}]}
        ]);

        // PARTE IV
        createQ('p4', [
            {i:29, t:"29. Motivaci√≥n para estudiar", o:[{t:"Superaci√≥n/Familia",v:-1},{t:"Conseguir trabajo",v:0},{t:"No s√©/Obligado",v:2}]}
        ]);

        // PARTE V
        createQ('p5', [
            {i:30, t:"30. Sentimientos de tristeza/desesperanza (√∫ltimas 2 sem)", o:[{t:"Nunca/Poco",v:0},{t:"Varios d√≠as",v:1},{t:"Casi todos los d√≠as",v:3}]},
            {i:34, t:"34. Amigos en la escuela", o:[{t:"S√≠ tengo",v:-1},{t:"Pocos",v:1},{t:"Ninguno",v:2}]},
            {i:35, t:"35. V√≠ctima de bullying/acoso", o:[{t:"Nunca",v:0},{t:"Alguna vez",v:1},{t:"Frecuente/Constante",v:3}]},
            {i:36, t:"36. Consumo de sustancias", o:[{t:"No",v:0},{t:"Ocasional",v:2},{t:"Frecuente",v:3}]},
            {i:38, t:"38. Pensamientos de autolesi√≥n/muerte", o:[{t:"Nunca",v:0},{t:"Alguna vez",v:2},{t:"Frecuente",v:3}]}
        ]);

        // PARTE VI
        createQ('p6', [
            {i:41, t:"41. Actividades extracurriculares (Deporte, Arte)", o:[{t:"S√≠",v:-1},{t:"No",v:1}]}
        ]);

        // CIERRE
        createQ('p7', [
            {i:46, t:"46. ¬øDeseas una cita con Orientaci√≥n?", o:[{t:"No por ahora",v:0},{t:"S√≠, me gustar√≠a",v:0}]} // El valor aqu√≠ no suma riesgo, es acci√≥n
        ]);
    }
    
    renderQuestions();

    let datosFinales = null;

    function calcularCDFR() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Nombre requerido"); return; }

        // Algoritmo de Calificaci√≥n
        let riskScore = 0;
        let highRiskCount = 0;
        let protecCount = 0;
        let citaSolicitada = "No";

        // Iterar preguntas
        const inputs = document.querySelectorAll('input[type="radio"]:checked');
        inputs.forEach(inp => {
            let val = parseInt(inp.value);
            let name = inp.name;

            // Detecci√≥n de cita
            if(name === "q46" && inp.nextSibling.textContent.includes("S√≠")) citaSolicitada = "S√≠";

            if(val === 3) {
                riskScore += 3;
                highRiskCount++;
            } else if(val === 2) {
                riskScore += 2;
            } else if(val === 1) {
                riskScore += 1;
            } else if(val === -1) {
                riskScore -= 1; // Resta riesgo (factor protector)
                protecCount++;
            }
        });

        if(riskScore < 0) riskScore = 0;

        // Interpretaci√≥n
        let nivel = "";
        if(riskScore <= 8) nivel = "Bajo Riesgo";
        else if(riskScore <= 16) nivel = "Riesgo Moderado";
        else if(riskScore <= 24) nivel = "Riesgo Alto";
        else nivel = "RIESGO CR√çTICO";

        datosFinales = {
            nombre, 
            edad: document.getElementById('edad').value,
            grupo: document.getElementById('grupo').value,
            fecha: document.getElementById('fecha').value,
            especialidad: document.getElementById('especialidad').value,
            celular: document.getElementById('celular').value,
            cdfrScore: riskScore,
            cdfrNivel: nivel,
            cdfrHigh: highRiskCount,
            cdfrCita: citaSolicitada
        };

        // Mostrar vista final
        document.getElementById('test-form').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        window.scrollTo(0,0);
    }

    function guardarLocalmente() {
        if(!datosFinales) return;
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        
        let up = { 
            ...cur, 
            nombre: datosFinales.nombre, 
            edad: datosFinales.edad,
            sexo: document.getElementById('grupo').value, // Usamos grupo/semestre como dato extra
            // Guardamos datos CDFR
            cdfr: datosFinales.cdfrScore,
            cdfrNivel: datosFinales.cdfrNivel,
            cdfrCita: datosFinales.cdfrCita
        };
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up));
        alert("‚úÖ Cuestionario guardado en expediente.");
    }

    function enviarWhatsApp() {
        if(!datosFinales) return;
        let m = `üìù *CDFR Finalizado*%0Aüë§ ${datosFinales.nombre}%0AüìÖ ${datosFinales.fecha}%0Aüìû Contacto: ${datosFinales.celular}%0A%0AEl cuestionario ha sido completado.`;
        if(datosFinales.cdfrCita === "S√≠") m += `%0AüìÖ *SOLICITA CITA*`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank');
    }
</script>
</body>
</html>

