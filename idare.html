<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluaci√≥n IDARE - CBTa 130</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1c1e; }
    /* Encabezado Gris Azulado para IDARE */
    header { background: linear-gradient(135deg, #37474f 0%, #455a64 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #37474f; text-align: center; margin-top: 0; border-bottom: 2px solid #cfd8dc; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 8px; color: #333; }
    input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    
    /* T√≠tulos de Secci√≥n Interna */
    .part-title { 
        background-color: #eceff1; color: #37474f; padding: 10px; border-left: 5px solid #37474f;
        font-weight: bold; margin-top: 30px; margin-bottom: 10px; border-radius: 4px;
    }

    /* Tabla Ajustada */
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; min-width: 600px; table-layout: fixed; }
    
    th, td { padding: 12px 5px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
    
    /* Anchos: Pregunta 50%, Opciones 12.5% */
    th:first-child, td:first-child { width: 50%; text-align: left; padding-left: 10px; font-weight: 500; white-space: normal; line-height: 1.3; }
    th:not(:first-child), td:not(:first-child) { width: 12.5%; }
    
    th { background-color: #cfd8dc; color: #263238; position: sticky; top: 0; font-weight: bold; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    input[type="radio"] { width: 20px; height: 20px; margin: 0 auto; display: block; cursor: pointer; accent-color: #37474f; }

    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
    button:active { transform: scale(0.98); }
    
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .reset { background-color: #757575; }
    .btn-back { background-color: #78909c; }
    
    #result-area { display: none; text-align: center; margin-top: 20px; padding: 20px; background: #eceff1; border-radius: 10px; border: 2px solid #b0bec5; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Inventario de Ansiedad (IDARE)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos del Alumno</h2>
        <div class="input-group"><label>Nombre Completo:</label><input type="text" id="nombre" required></div>
        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha" required></div>
        
        <div style="background-color:#eceff1; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #37474f;">
            <strong>Instrucciones:</strong> Lea cada frase y marque la opci√≥n que indique c√≥mo se siente.
        </div>

        <!-- PARTE 1: ESTADO -->
        <div class="part-title">PARTE 1: ¬øC√ìMO SE SIENTE AHORA MISMO?</div>
        <div class="table-container">
            <table>
                <thead><tr><th>√çtem</th><th>No (1)</th><th>Poco (2)</th><th>Bastante (3)</th><th>Mucho (4)</th></tr></thead>
                <tbody id="tabla-estado"></tbody>
            </table>
        </div>

        <!-- PARTE 2: RASGO -->
        <div class="part-title">PARTE 2: ¬øC√ìMO SE SIENTE GENERALMENTE?</div>
        <div class="table-container">
            <table>
                <thead><tr><th>√çtem</th><th>Casi Nunca (1)</th><th>A veces (2)</th><th>Frecuente (3)</th><th>Casi Siempre (4)</th></tr></thead>
                <tbody id="tabla-rasgo"></tbody>
            </table>
        </div>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="finalizarTest()">‚úÖ Finalizar</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar y Volver</button>
        </div>
    </div>

    <div id="result-area">
        <h3 style="color:#37474f;">üìä Resultados Listos</h3>
        <p>Seleccione una acci√≥n para continuar:</p>
        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar por WhatsApp</button>
            <button type="button" class="reset" onclick="location.reload()">üîÑ Nuevo Test</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Ir al Men√∫</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";

    // √çtems Parte 1 (Estado)
    const itemsE = [
        "1. Me siento calmado", "2. Me siento seguro", "3. Estoy tenso", "4. Estoy contrariado",
        "5. Me siento a gusto", "6. Me siento alterado", "7. Estoy preocupado por posibles desgracias",
        "8. Me siento descansado", "9. Me siento ansioso", "10. Me siento c√≥modo",
        "11. Me siento con confianza", "12. Me siento nervioso", "13. Estoy agitado",
        "14. Me siento a punto de explotar", "15. Me siento relajado", "16. Me siento satisfecho",
        "17. Estoy preocupado", "18. Me siento aturdido", "19. Me siento alegre", "20. Me siento bien"
    ];

    // √çtems Parte 2 (Rasgo) - (Numerados 21-40 para el sistema)
    const itemsR = [
        "21. Me siento bien", "22. Me canso r√°pidamente", "23. Siento ganas de llorar", "24. Quisiera ser tan feliz como otros",
        "25. Pierdo oportunidades por no decidir", "26. Me siento descansado", "27. Soy una persona tranquila",
        "28. Siento que las dificultades se amontonan", "29. Me preocupo demasiado por cosas sin importancia", "30. Soy feliz",
        "31. Tomo las cosas muy a pecho", "32. Me falta confianza en m√≠ mismo", "33. Me siento seguro",
        "34. Trato de evitar enfrentar crisis", "35. Me siento melanc√≥lico", "36. Me siento satisfecho",
        "37. Ideas poco importantes me molestan", "38. Me afectan tanto los desenga√±os", "39. Soy una persona estable",
        "40. Me pongo tenso cuando pienso en mis asuntos"
    ];

    // Renderizar Tabla Estado
    const tE = document.getElementById('tabla-estado');
    itemsE.forEach((t, i) => {
        tE.innerHTML += `<tr><td>${t}</td>${[1,2,3,4].map(v=>`<td><input type="radio" name="e${i+1}" value="${v}"></td>`).join('')}</tr>`;
    });

    // Renderizar Tabla Rasgo
    const tR = document.getElementById('tabla-rasgo');
    itemsR.forEach((t, i) => {
        tR.innerHTML += `<tr><td>${t}</td>${[1,2,3,4].map(v=>`<td><input type="radio" name="r${i+21}" value="${v}"></td>`).join('')}</tr>`;
    });

    document.getElementById('fecha').valueAsDate = new Date();
    let datosFinales = null;

    function finalizarTest() {
        try {
            const nombre = document.getElementById('nombre').value;
            const fecha = document.getElementById('fecha').value;
            if(!nombre) { alert("Por favor ingresa el nombre."); return; }

            let scoreEstado = 0, scoreRasgo = 0, count = 0;

            // --- CALCULAR ESTADO (1-20) ---
            // √çtems Inversos: 1, 2, 5, 8, 10, 11, 15, 16, 19, 20 (Se punt√∫an: 5 - valor)
            const invE = [1, 2, 5, 8, 10, 11, 15, 16, 19, 20];
            
            for(let i=1; i<=20; i++){
                const el = document.querySelector(`input[name="e${i}"]:checked`);
                if(el) {
                    let v = parseInt(el.value);
                    scoreEstado += invE.includes(i) ? (5 - v) : v;
                    count++;
                }
            }

            // --- CALCULAR RASGO (21-40) ---
            // √çtems Inversos: 21, 26, 27, 30, 33, 36, 39 (Se punt√∫an: 5 - valor)
            const invR = [21, 26, 27, 30, 33, 36, 39];
            
            for(let i=21; i<=40; i++){
                const el = document.querySelector(`input[name="r${i}"]:checked`);
                if(el) {
                    let v = parseInt(el.value);
                    scoreRasgo += invR.includes(i) ? (5 - v) : v;
                    count++;
                }
            }

            if(count < 40) { 
                alert(`Faltan preguntas por contestar (${count}/40).`); 
                return; 
            }

            datosFinales = { nombre, fecha, scoreEstado, scoreRasgo };

            document.getElementById('test-form').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
            window.scrollTo(0,0);

        } catch(e) {
            alert("Error: " + e.message);
        }
    }

    function guardarLocalmente() {
        if(!datosFinales) { alert("No hay datos."); return; }
        try {
            let current = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            let update = { 
                ...current, 
                nombre: datosFinales.nombre,
                fecha: datosFinales.fecha,
                idareE: datosFinales.scoreEstado, // Clave para Admin
                idareR: datosFinales.scoreRasgo   // Clave para Admin
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(update));
            alert("‚úÖ Datos IDARE guardados en expediente.");
        } catch (e) {
            alert("Error al guardar: " + e.message);
        }
    }

    function enviarWhatsApp(){
        if(!datosFinales) return;
        const msg = `üå´Ô∏è *IDARE*%0Aüë§ ${datosFinales.nombre}%0AüìÖ ${datosFinales.fecha}%0Aüìä Estado: ${datosFinales.scoreEstado}%0Aüìä Rasgo: ${datosFinales.scoreRasgo}`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${msg}`, '_blank');
    }
</script>
</body>
</html>


