<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Generador de Informes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 20px; }
    .card { background: white; max-width: 800px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h2 { color: #1b5e20; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
    .row { display: flex; gap: 15px; }
    .col { flex: 1; }
    
    .btn-generate { background-color: #1b5e20; color: white; border: none; width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 10px; cursor: pointer; margin-top: 20px; font-weight: bold; }
    .back-link { display: block; text-align: center; margin-top: 20px; color: #666; text-decoration: none; font-size: 0.9em; }
    
    .section-box { background:#fafafa; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid #ccc; }
    .header-sec { margin-top:0; font-size:1rem; display:flex; justify-content:space-between; }
    
    /* Panel de Memoria */
    .memory-panel { background: #fff3e0; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .mem-text { color: #e65100; font-size: 0.9rem; }
    .btn-clear { background: #c62828; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
    
    /* Colores Secciones */
    .s-phq { border-left-color: #00695c; } .s-phq h3 { color: #00695c; }
    .s-gad { border-left-color: #e65100; } .s-gad h3 { color: #e65100; }
    .s-bai { border-left-color: #2e7d32; } .s-bai h3 { color: #2e7d32; }
    .s-idare { border-left-color: #37474f; } .s-idare h3 { color: #37474f; }
    .s-bdi { border-left-color: #1565C0; } .s-bdi h3 { color: #1565C0; }
    .s-hads { border-left-color: #880e4f; } .s-hads h3 { color: #880e4f; }
    .s-ssi { border-left-color: #7b1fa2; } .s-ssi h3 { color: #7b1fa2; }
    .s-bhs { border-left-color: #212121; } .s-bhs h3 { color: #212121; }
    .s-cssrs { border-left-color: #c62828; } .s-cssrs h3 { color: #c62828; }
    .s-plut { border-left-color: #5d4037; } .s-plut h3 { color: #5d4037; }
</style>
</head>
<body>

<div class="card">
    <h2>üè• Generador Integral (V4 - Memoria)</h2>
    
    <!-- PANEL DE MEMORIA -->
    <div id="memoryPanel" class="memory-panel" style="display:none;">
        <div class="mem-text">
            <strong>üìÇ Datos recuperados del dispositivo</strong><br>
            Se cargaron autom√°ticamente los resultados pendientes.
        </div>
        <button class="btn-clear" onclick="borrarMemoria()">üóëÔ∏è Borrar / Nuevo Paciente</button>
    </div>

    <div class="row">
        <div class="col"><label>Nombre:</label><input type="text" id="nombre"></div>
        <div class="col"><label>Edad:</label><input type="number" id="edad"></div>
        <div class="col"><label>Sexo (H/M):</label><input type="text" id="sexo"></div>
        <div class="col"><label>Fecha:</label><input type="date" id="fecha"></div>
    </div>
    <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">

    <!-- TAMIZAJE -->
    <div class="row">
        <div class="col section-box s-phq">
            <h3 class="header-sec">PHQ-9</h3>
            <input type="number" id="scorePHQ" placeholder="Total">
            <input type="number" id="flagPHQ" placeholder="√çtem 9" style="margin-top:5px">
        </div>
        <div class="col section-box s-gad">
            <h3 class="header-sec">GAD-7</h3>
            <input type="number" id="scoreGAD" placeholder="Total">
        </div>
        <div class="col section-box s-hads">
            <h3 class="header-sec">HADS</h3>
            <input type="number" id="hadsA" placeholder="Ansiedad">
            <input type="number" id="hadsD" placeholder="Depresi√≥n" style="margin-top:5px">
        </div>
    </div>

    <!-- ANSIEDAD -->
    <div class="row">
        <div class="col section-box s-bai">
            <h3 class="header-sec">BAI (Beck)</h3>
            <input type="number" id="scoreBAI" placeholder="Total">
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="number" id="f1" placeholder="F1"><input type="number" id="f2" placeholder="F2">
                <input type="number" id="f3" placeholder="F3"><input type="number" id="f4" placeholder="F4">
            </div>
        </div>
        <div class="col section-box s-idare">
            <h3 class="header-sec">IDARE</h3>
            <input type="number" id="idareE" placeholder="Estado">
            <input type="number" id="idareR" placeholder="Rasgo" style="margin-top:5px">
        </div>
    </div>

    <!-- DEPRESI√ìN & DESESPERANZA -->
    <div class="row">
        <div class="col section-box s-bdi">
            <h3 class="header-sec">BDI-II</h3>
            <input type="number" id="scoreBDI" placeholder="Total">
        </div>
        <div class="col section-box s-bhs">
            <h3 class="header-sec">BHS</h3>
            <input type="number" id="scoreBHS" placeholder="Total">
        </div>
    </div>

    <!-- RIESGO ALTO -->
    <div class="row">
        <div class="col section-box s-ssi">
            <h3 class="header-sec">SSI</h3>
            <input type="number" id="scoreSSI" placeholder="Total">
            <input type="text" id="flagsSSI" placeholder="Flags" style="margin-top:5px">
        </div>
        <div class="col section-box s-plut">
            <h3 class="header-sec">Plutchik</h3>
            <input type="number" id="scorePlut" placeholder="Total">
        </div>
    </div>

    <div class="section-box s-cssrs">
        <h3 class="header-sec">Columbia (C-SSRS)</h3>
        <div class="row">
            <div class="col"><label>Idea (1-5)</label><select id="cssrsId"><option value="0">No</option><option value="1">S√≠</option></select></div>
            <div class="col"><label>Plan (4-5)</label><select id="cssrsPlan"><option value="0">No</option><option value="1">S√≠</option></select></div>
            <div class="col"><label>Conducta</label><select id="cssrsCond"><option value="0">No</option><option value="1">S√≠</option></select></div>
            <div class="col"><label>Reciente</label><select id="cssrsRec"><option value="0">No</option><option value="1">S√≠</option></select></div>
        </div>
    </div>
    
    <button class="btn-generate" onclick="generarReporte()">üìÑ Descargar Expediente Integrado</button>
    <a href="index.html" class="back-link">‚Üê Volver al Men√∫ Principal</a>
</div>

<script>
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    // --- CARGA AUTOM√ÅTICA AL ABRIR ---
    window.addEventListener('DOMContentLoaded', () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
            const data = JSON.parse(raw);
            document.getElementById('memoryPanel').style.display = 'flex';
            
            // Cargar Datos Generales
            if(data.nombre) document.getElementById('nombre').value = data.nombre;
            if(data.edad) document.getElementById('edad').value = data.edad;
            if(data.sexo) document.getElementById('sexo').value = data.sexo;

            // Cargar Scores (Solo si existen)
            const setVal = (id, val) => { if(val !== undefined) document.getElementById(id).value = val; };
            
            setVal('scorePHQ', data.phq); setVal('flagPHQ', data.phqFlag);
            setVal('scoreGAD', data.gad);
            setVal('hadsA', data.hadsA); setVal('hadsD', data.hadsD);
            setVal('scoreBAI', data.bai); setVal('f1', data.f1); setVal('f2', data.f2); setVal('f3', data.f3); setVal('f4', data.f4);
            setVal('idareE', data.idareE); setVal('idareR', data.idareR);
            setVal('scoreBDI', data.bdi);
            setVal('scoreBHS', data.bhs);
            setVal('scoreSSI', data.ssi); setVal('flagsSSI', data.ssiFlags);
            setVal('scorePlut', data.plut);
            
            setVal('cssrsId', data.cId); setVal('cssrsPlan', data.cPlan); 
            setVal('cssrsCond', data.cCond); setVal('cssrsRec', data.cRec);
        }
    });

    function borrarMemoria() {
        if(confirm("¬øSeguro que deseas borrar los datos guardados? Esto iniciar√° un expediente nuevo.")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function generarReporte() {
        const d = {
            nombre: document.getElementById('nombre').value,
            edad: parseInt(document.getElementById('edad').value),
            sexo: document.getElementById('sexo').value.toUpperCase(),
            fecha: document.getElementById('fecha').value,
            // Scores
            phq: document.getElementById('scorePHQ').value, flagPHQ: document.getElementById('flagPHQ').value,
            gad: document.getElementById('scoreGAD').value,
            hadsA: document.getElementById('hadsA').value, hadsD: document.getElementById('hadsD').value,
            bai: document.getElementById('scoreBAI').value, f1: document.getElementById('f1').value, f2: document.getElementById('f2').value, f3: document.getElementById('f3').value, f4: document.getElementById('f4').value,
            idareE: document.getElementById('idareE').value, idareR: document.getElementById('idareR').value,
            bdi: document.getElementById('scoreBDI').value,
            bhs: document.getElementById('scoreBHS').value,
            ssi: document.getElementById('scoreSSI').value, flagsSSI: document.getElementById('flagsSSI').value,
            plut: document.getElementById('scorePlut').value,
            cId: document.getElementById('cssrsId').value, cPlan: document.getElementById('cssrsPlan').value,
            cCond: document.getElementById('cssrsCond').value, cRec: document.getElementById('cssrsRec').value
        };

        if(!d.nombre) { alert("Falta nombre"); return; }
        
        const img = new Image(); img.src = "logo.jpg";
        img.onload = () => createPDF(d, img);
        img.onerror = () => createPDF(d, null);
    }

    function createPDF(d, img) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Encabezado
        doc.setFillColor(27, 94, 32); doc.rect(0, 0, 210, 40, 'F');
        if (img) doc.addImage(img, 'JPEG', 10, 7, 25, 25);
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("Centro de Bachillerato Tecnol√≥gico Agropecuario No. 130", 105, 25, null, null, "center");
        
        doc.setTextColor(0); doc.setFontSize(14); doc.text("Informe Psicopedag√≥gico Integral", 105, 55, null, null, "center");
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Paciente: ${d.nombre} | Edad: ${d.edad} | Fecha: ${d.fecha}`, 20, 65);
        doc.line(20, 70, 190, 70);

        let yPos = 80;
        
        const drawRow = (title, score, interp, colorRisk = false) => {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFont("helvetica", "bold");
            doc.text(title, 20, yPos);
            doc.setFont("helvetica", "normal");
            doc.text(score ? score.toString() : "-", 80, yPos);
            if(colorRisk) doc.setTextColor(200,0,0);
            doc.text(interp, 100, yPos);
            doc.setTextColor(0);
            doc.line(20, yPos+2, 190, yPos+2);
            yPos += 8;
        };

        // 1. TAMIZAJE
        doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(0, 105, 92);
        doc.text("1. ESCALAS DE TAMIZAJE", 20, yPos); yPos += 10;
        doc.setFontSize(9); doc.setTextColor(0);

        if(d.phq) {
            let v=parseInt(d.phq), n=""; if(v<=4)n="M√≠nima";else if(v<=9)n="Leve";else if(v<=14)n="Moderada";else if(v<=19)n="Mod-Sev";else n="Severa";
            if(d.flagPHQ>0) n+=" (ALERTA I9)";
            drawRow("PHQ-9 (Dep)", d.phq, n, v>=10);
        }
        if(d.gad) {
            let v=parseInt(d.gad), n=""; if(v<=4)n="M√≠nima";else if(v<=9)n="Leve";else if(v<=14)n="Moderada";else n="Severa";
            drawRow("GAD-7 (Ans)", d.gad, n, v>=10);
        }
        if(d.hadsA) {
            let v=parseInt(d.hadsA), n=""; if(v<=7)n="Normal";else if(v<=10)n="Dudoso";else n="Caso Cl√≠nico";
            drawRow("HADS-A (Ans)", d.hadsA, n, v>=11);
        }
        if(d.hadsD) {
            let v=parseInt(d.hadsD), n=""; if(v<=7)n="Normal";else if(v<=10)n="Dudoso";else n="Caso Cl√≠nico";
            drawRow("HADS-D (Dep)", d.hadsD, n, v>=11);
        }
        yPos += 5;

        // 2. PROFUNDIZACI√ìN
        doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(21, 101, 192);
        doc.text("2. EVALUACI√ìN PROFUNDA", 20, yPos); yPos += 10;
        doc.setFontSize(9); doc.setTextColor(0);

        if(d.bai) {
            let v=parseInt(d.bai), n=""; if(v<=7)n="Normal";else if(v<=15)n="Leve";else if(v<=25)n="Moderada";else n="Severa";
            drawRow("BAI (Beck)", d.bai, n, v>15);
        }
        if(d.bdi) {
            let v=parseInt(d.bdi), n=""; if(v<=12)n="Sin dep";else if(v<=18)n="Leve";else if(v<=27)n="Moderada";else n="Severa";
            drawRow("BDI-II", d.bdi, n, v>=19);
        }
        if(d.idareE) {
            let v=parseInt(d.idareE), n="Media"; if(v<32)n="Baja"; if(v>45)n="Alta";
            drawRow("IDARE-E", d.idareE, n, v>45);
        }
        if(d.bhs) {
            let v=parseInt(d.bhs), n=""; if(v<=3)n="Normal";else if(v<=8)n="Leve";else if(v<=14)n="Moderada";else n="Severa";
            drawRow("BHS (Desesp)", d.bhs, n, v>=9);
        }
        yPos += 5;

        // 3. RIESGO SUICIDA
        doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(198, 40, 40);
        doc.text("3. EVALUACI√ìN DE RIESGO", 20, yPos); yPos += 10;
        doc.setFontSize(9); doc.setTextColor(0);

        if(d.ssi) {
            let v=parseInt(d.ssi), n=""; if(v<=5)n="Bajo";else if(v<=9)n="Moderado";else if(v<=14)n="Alto";else n="Muy Alto";
            drawRow("SSI", d.ssi, n, v>=6);
        }
        if(d.plut) {
            let v=parseInt(d.plut), n=""; if(v<=4)n="Sin riesgo";else if(v<=6)n="Leve";else if(v<=8)n="Moderado";else n="Alto";
            drawRow("Plutchik", d.plut, n, v>=6);
        }
        
        if(d.cId === "1" || d.cCond === "1") {
            let risk = "Bajo";
            if(d.cId==="1") risk="Ideaci√≥n Presente";
            if(d.cPlan==="1") risk="ALTO (Con Plan)";
            if(d.cCond==="1") risk="ALTO (Historial)";
            if(d.cRec==="1") risk="MUY ALTO (Reciente)";
            drawRow("C-SSRS", "Positivo", risk, true);
        }

        yPos += 20;
        doc.rect(20, yPos, 170, 40);
        doc.text("Observaciones Cl√≠nicas:", 22, yPos+5);

        doc.save(`Expediente_${d.nombre}.pdf`);
    }
</script>
</body>
</html>


