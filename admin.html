<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Generador de Informes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 20px; }
    .card { background: white; max-width: 700px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h2 { color: #1b5e20; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
    input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
    .row { display: flex; gap: 15px; }
    .col { flex: 1; }
    .btn-generate { background-color: #1b5e20; color: white; border: none; width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 10px; cursor: pointer; margin-top: 20px; font-weight: bold; }
    .back-link { display: block; text-align: center; margin-top: 20px; color: #666; text-decoration: none; font-size: 0.9em; }
    
    /* Estilos de Secciones */
    .section-box { background:#fafafa; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid #ccc; }
    .header-sec { margin-top:0; font-size:1rem; display:flex; justify-content:space-between; }
    
    .s-bai { border-left-color: #2e7d32; } .s-bai h3 { color: #2e7d32; }
    .s-bdi { border-left-color: #1565C0; } .s-bdi h3 { color: #1565C0; }
    .s-ssi { border-left-color: #7b1fa2; } .s-ssi h3 { color: #7b1fa2; }
    .s-phq { border-left-color: #00695c; } .s-phq h3 { color: #00695c; }
    .s-gad { border-left-color: #e65100; } .s-gad h3 { color: #e65100; }
</style>
</head>
<body>

<div class="card">
    <h2>üè• Generador de Informes Cl√≠nicos</h2>
    
    <div class="form-group"><label>Nombre del Paciente:</label><input type="text" id="nombre"></div>
    <div class="row">
        <div class="col form-group"><label>Edad:</label><input type="number" id="edad"></div>
        <div class="col form-group"><label>Fecha:</label><input type="date" id="fecha"></div>
    </div>
    
    <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
    <div style="font-size:0.8rem; color:#666; margin-bottom:15px;">*Llena solo los campos de los tests aplicados.</div>

    <!-- PHQ-9 -->
    <div class="section-box s-phq">
        <h3 class="header-sec">PHQ-9 (Depresi√≥n) <span>Tamizaje</span></h3>
        <div class="row">
            <div class="col"><input type="number" id="scorePHQ" placeholder="Total (0-27)"></div>
            <div class="col"><input type="number" id="flagPHQ" placeholder="Valor √çtem 9 (0-3)"></div>
        </div>
    </div>

    <!-- GAD-7 -->
    <div class="section-box s-gad">
        <h3 class="header-sec">GAD-7 (Ansiedad) <span>Tamizaje</span></h3>
        <div class="form-group"><input type="number" id="scoreGAD" placeholder="Total (0-21)"></div>
    </div>

    <!-- BAI -->
    <div class="section-box s-bai">
        <h3 class="header-sec">Ansiedad (BAI) <span>Profundizaci√≥n</span></h3>
        <div class="form-group"><input type="number" id="scoreBAI" placeholder="Total (0-63)"></div>
        <div class="row">
            <div class="col"><input type="number" id="f1" placeholder="F1 Subj"></div>
            <div class="col"><input type="number" id="f2" placeholder="F2 Neuro"></div>
            <div class="col"><input type="number" id="f3" placeholder="F3 Auto"></div>
            <div class="col"><input type="number" id="f4" placeholder="F4 P√°nic"></div>
        </div>
    </div>

    <!-- BDI -->
    <div class="section-box s-bdi">
        <h3 class="header-sec">Depresi√≥n (BDI-II) <span>Profundizaci√≥n</span></h3>
        <div class="form-group"><input type="number" id="scoreBDI" placeholder="Total (0-63)"></div>
    </div>

    <!-- SSI -->
    <div class="section-box s-ssi">
        <h3 class="header-sec">Ideaci√≥n (SSI) <span>Riesgo</span></h3>
        <div class="row">
            <div class="col"><input type="number" id="scoreSSI" placeholder="Total (0-38)"></div>
            <div class="col"><input type="text" id="flagsSSI" placeholder="Flags (Ej: C4, C20)"></div>
        </div>
    </div>
    
    <button class="btn-generate" onclick="generarReporte()">üìÑ Descargar Expediente Integrado</button>
    <a href="index.html" class="back-link">‚Üê Volver al Men√∫ Principal</a>
</div>

<script>
    document.getElementById('fecha').valueAsDate = new Date();

    function generarReporte() {
        const d = {
            nombre: document.getElementById('nombre').value,
            edad: parseInt(document.getElementById('edad').value),
            fecha: document.getElementById('fecha').value,
            bai: document.getElementById('scoreBAI').value,
            bdi: document.getElementById('scoreBDI').value,
            ssi: document.getElementById('scoreSSI').value,
            ssiFlags: document.getElementById('flagsSSI').value,
            phq: document.getElementById('scorePHQ').value,
            phqFlag: document.getElementById('flagPHQ').value,
            gad: document.getElementById('scoreGAD').value,
            f1: document.getElementById('f1').value,
            f2: document.getElementById('f2').value,
            f3: document.getElementById('f3').value,
            f4: document.getElementById('f4').value
        };

        if(!d.nombre || !d.edad) { alert("Faltan datos del paciente"); return; }
        
        const img = new Image(); img.src = "logo.jpg";
        img.onload = () => createPDF(d, img);
        img.onerror = () => createPDF(d, null);
    }

    function createPDF(d, img) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 1. Encabezado
        doc.setFillColor(27, 94, 32); doc.rect(0, 0, 210, 40, 'F');
        if (img) doc.addImage(img, 'JPEG', 10, 7, 25, 25);
        doc.setTextColor(255); doc.setFontSize(18); doc.setFont("helvetica", "bold");
        doc.text("Centro de Bachillerato Tecnol√≥gico", 105, 18, null, null, "center");
        doc.text("Agropecuario No. 130", 105, 28, null, null, "center");

        doc.setTextColor(0); doc.setFontSize(16); doc.text("Informe Psicopedag√≥gico Multidimensional", 105, 55, null, null, "center");
        
        doc.setFontSize(11); doc.setFont("helvetica", "normal");
        doc.text(`Paciente: ${d.nombre}`, 20, 70);
        doc.text(`Edad: ${d.edad} a√±os`, 120, 70);
        doc.text(`Fecha: ${d.fecha}`, 20, 80);
        doc.line(20, 85, 190, 85);

        let yPos = 95;
        
        // Funci√≥n auxiliar para dibujar filas
        const drawRow = (title, score, interp, colorRisk = false) => {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFont("helvetica", "bold"); doc.setFontSize(10);
            doc.text(title, 20, yPos);
            doc.setFont("helvetica", "normal");
            doc.text(score.toString(), 80, yPos);
            
            if(colorRisk) doc.setTextColor(200,0,0);
            doc.text(interp, 100, yPos);
            doc.setTextColor(0);
            
            doc.setDrawColor(220);
            doc.line(20, yPos+2, 190, yPos+2);
            yPos += 10;
        };

        // --- SECCI√ìN 1: TAMIZAJE ---
        doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.setTextColor(27, 94, 32);
        doc.text("1. ESCALAS DE TAMIZAJE (Screening)", 20, yPos);
        yPos += 10;

        // PHQ-9
        if(d.phq) {
            const val = parseInt(d.phq);
            let nivel = "";
            if (val <= 4) nivel = "M√≠nima / Monitoreo";
            else if (val <= 9) nivel = "Leve / Seguimiento";
            else if (val <= 14) nivel = "Moderada / Considerar Tx";
            else if (val <= 19) nivel = "Mod-Severa / Tx Activo";
            else nivel = "Severa / Tx Inmediato";
            
            if(d.phqFlag > 0) nivel += " (ALERTA: Ideaci√≥n +)";
            
            drawRow("Depresi√≥n (PHQ-9)", d.phq, nivel, (val >= 10 || d.phqFlag > 0));
        }

        // GAD-7
        if(d.gad) {
            const val = parseInt(d.gad);
            let nivel = "";
            if (val <= 4) nivel = "M√≠nima";
            else if (val <= 9) nivel = "Leve";
            else if (val <= 14) nivel = "Moderada";
            else nivel = "Severa";
            
            drawRow("Ansiedad (GAD-7)", d.gad, nivel, val >= 10);
        }

        yPos += 5;

        // --- SECCI√ìN 2: PROFUNDIZACI√ìN ---
        doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.setTextColor(21, 101, 192);
        doc.text("2. ESCALAS DE PROFUNDIZACI√ìN", 20, yPos);
        yPos += 10;

        // BAI
        if(d.bai) {
            const val = parseInt(d.bai);
            let nivel = "";
            if (val <= 7) nivel = "M√≠nima / Normal";
            else if (val <= 15) nivel = "Leve";
            else if (val <= 25) nivel = "Moderada";
            else nivel = "Severa";
            
            drawRow("Ansiedad (BAI)", d.bai, nivel, val > 15);
            
            // Factores BAI
            if(d.f1) {
                doc.setFontSize(8); doc.setTextColor(100);
                doc.text(`Subj: ${d.f1} | Neuro: ${d.f2} | Auto: ${d.f3} | P√°nico: ${d.f4}`, 25, yPos-4);
                doc.setFontSize(10); doc.setTextColor(0);
            }
        }

        // BDI
        if(d.bdi) {
            const val = parseInt(d.bdi);
            const esAdol = (d.edad >= 15 && d.edad <= 19);
            let nivel = "";
            if (esAdol) {
                if (val <= 12) nivel = "Sin depresi√≥n"; else if (val <= 18) nivel = "Leve"; else if (val <= 27) nivel = "Moderada"; else nivel = "Severa";
            } else {
                if (val <= 13) nivel = "M√≠nima"; else if (val <= 19) nivel = "Leve"; else if (val <= 28) nivel = "Moderada"; else nivel = "Severa";
            }
            drawRow("Depresi√≥n (BDI-II)", d.bdi, nivel, val >= 19);
        }

        yPos += 5;

        // --- SECCI√ìN 3: RIESGO ---
        doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.setTextColor(123, 31, 162);
        doc.text("3. EVALUACI√ìN DE RIESGO", 20, yPos);
        yPos += 10;

        // SSI
        if(d.ssi) {
            const val = parseInt(d.ssi);
            let nivel = "";
            if (val <= 5) nivel = "Riesgo Bajo";
            else if (val <= 9) nivel = "Riesgo Moderado";
            else if (val <= 14) nivel = "Riesgo Alto";
            else nivel = "Riesgo Muy Alto";

            if(d.ssiFlags) nivel += " (FLAGS: " + d.ssiFlags + ")";
            
            drawRow("Ideaci√≥n (SSI)", d.ssi, nivel, val >= 6);
        }

        // --- OBSERVACIONES ---
        yPos += 15;
        if (yPos > 250) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold"); doc.setTextColor(0); 
        doc.text("Integraci√≥n Diagn√≥stica y Plan de Acci√≥n:", 20, yPos);
        doc.setDrawColor(150); doc.rect(20, yPos+5, 170, 50);

        yPos += 80;
        doc.line(70, yPos, 140, yPos);
        doc.setFontSize(10);
        doc.text("Firma del Evaluador", 105, yPos+5, null, null, "center");

        doc.save(`Expediente_Integral_${d.nombre}.pdf`);
    }
</script>
</body>
</html>


