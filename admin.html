<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Evaluaciones - Suite Integral</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background-color: #f4f6f8; padding: 20px; margin: 0; }
    
    /* BARRA SUPERIOR */
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .top-title { font-size: 1.2rem; font-weight: 800; color: #263238; margin: 0; }
    .btn-home { background-color: #eceff1; color: #455a64; text-decoration: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; transition: 0.2s; }
    .btn-home:hover { background-color: #cfd8dc; }

    .main-container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
    
    /* COLUMNA IZQUIERDA (CAPTURA) */
    .panel-captura { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; }
    .panel-title { color: #e91e63; font-size: 1rem; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 12px; }
    label { display: block; font-size: 0.75rem; font-weight: bold; color: #546e7a; margin-bottom: 4px; text-transform: uppercase; }
    input, select { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; box-sizing: border-box; background: #fafafa; transition: 0.2s; }
    input:focus { border-color: #e91e63; background: white; outline: none; }

    /* COLUMNA DERECHA (TABLA) */
    .panel-tabla { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 500px; }
    
    .student-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .student-table th { text-align: left; font-size: 0.75rem; color: #90a4ae; text-transform: uppercase; padding: 10px; border-bottom: 1px solid #eee; }
    .student-table td { padding: 15px 10px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; }
    .student-table tr:hover { background-color: #f9fafb; cursor: pointer; }
    
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; display: inline-block; margin-right: 5px; margin-bottom: 2px; }
    .bg-gray { background: #eceff1; color: #455a64; }
    .bg-red { background: #ffebee; color: #c62828; }
    .bg-orange { background: #fff3e0; color: #ef6c00; }
    .bg-blue { background: #e3f2fd; color: #1565C0; }
    .bg-purple { background: #f3e5f5; color: #7b1fa2; }

    /* BOTONES */
    .btn-action { width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-open { background: #e3f2fd; color: #1976D2; margin-right: 5px; }
    .btn-open:hover { background: #1976D2; color: white; }
    .btn-del { background: #ffebee; color: #c62828; }
    .btn-del:hover { background: #c62828; color: white; }

    .btn-main { background: #e91e63; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); }
    .btn-main:active { transform: scale(0.98); }

    /* MODAL SIMPLIFICADO */
    .scores-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f5f5f5; padding: 10px; border-radius: 8px; margin-top: 10px; }

    /* Responsive */
    @media (max-width: 800px) {
        .main-container { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<div class="top-bar">
    <div style="display:flex; align-items:center; gap:15px;">
        <div style="width:40px; height:40px; background:#e91e63; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">SI</div>
        <div>
            <h1 class="top-title">Gestor de Evaluaciones</h1>
            <span style="font-size:0.8rem; color:#78909c;">Suite Integral v12.0</span>
        </div>
    </div>
    <a href="index.html" class="btn-home">‚¨Ö Volver al Men√∫</a>
</div>

<div class="main-container">
    
    <!-- PANEL IZQUIERDO: FORMULARIO DE EDICI√ìN -->
    <div class="panel-captura">
        <div class="panel-title">üìù Datos del Expediente</div>
        
        <input type="hidden" id="id_exp"> <!-- ID Oculto -->
        
        <div class="form-group">
            <label>Nombre del Alumno</label>
            <input type="text" id="nombre" placeholder="Ej. Juan P√©rez">
        </div>
        
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1">
                <label>Edad</label>
                <input type="number" id="edad">
            </div>
            <div class="form-group" style="flex:1">
                <label>Fecha</label>
                <input type="date" id="fecha">
            </div>
        </div>
        
        <div class="form-group">
            <label>Grupo / Semestre</label>
            <input type="text" id="grupo" placeholder="Ej. 6A Programaci√≥n">
        </div>

        <div style="border-top:1px dashed #ccc; margin:15px 0;"></div>
        <div class="panel-title" style="color:#455a64; font-size:0.9rem;">üìä Resultados Cargados</div>

        <div class="scores-grid">
            <div><label>PHQ-9</label><input type="number" id="scorePHQ"></div>
            <div><label>GAD-7</label><input type="number" id="scoreGAD"></div>
            <div><label>BAI</label><input type="number" id="scoreBAI"></div>
            <div><label>BDI-II</label><input type="number" id="scoreBDI"></div>
            <div><label>IPA</label><input type="number" id="penTotal"></div>
            <div><label>GOCA</label><input type="number" id="scoreGOCA"></div>
            <div><label>LIRA</label><input type="number" id="scoreLIRA"></div>
            <div><label>SSI</label><input type="number" id="scoreSSI"></div>
        </div>
        
        <!-- Campos Ocultos para PDF -->
        <div style="display:none;">
            <input id="sexo"><input id="hadsA"><input id="hadsD"><input id="idareE"><input id="idareR"><input id="scoreBHS"><input id="ebmaIAR"><input id="scoreCDFR"><input id="scorePlut">
            <!-- Factores -->
            <input id="f1"><input id="f2"><input id="f3"><input id="f4">
            <input id="flagPHQ"><input id="ssiFlags"><input id="gocaNivel">
            <input id="liraCrisis"><input id="cdfrCita"><input id="ebmaPerfil">
            <input id="cssrsId"><input id="cssrsPlan"><input id="cssrsCond">
            <!-- IPA F -->
            <input id="penF1"><input id="penF2"><input id="penF3"><input id="penF4"><input id="penF5"><input id="penF6"><input id="penF7"><input id="penF8"><input id="penF9"><input id="penF10"><input id="penF11"><input id="penF12"><input id="penF13"><input id="penF14"><input id="penF15">
        </div>

        <div style="margin-top:20px;">
            <button onclick="guardarExpediente()" class="btn-main">üíæ Guardar Cambios</button>
            <button onclick="generarPDF()" class="btn-main" style="background:#37474f; margin-top:10px;">üìÑ Generar PDF</button>
            <button onclick="limpiarFormulario()" style="background:transparent; color:#78909c; border:none; width:100%; padding:10px; cursor:pointer; margin-top:5px;">Limpiar / Nuevo</button>
        </div>
    </div>

    <!-- PANEL DERECHO: LISTA DE EXPEDIENTES -->
    <div class="panel-tabla">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.1rem; color:#263238;">Expedientes Activos</h2>
            <span id="counter" style="background:#eceff1; padding:5px 10px; border-radius:10px; font-size:0.8rem; font-weight:bold;">0</span>
        </div>
        <input type="text" id="searchBox" placeholder="üîç Buscar alumno..." style="margin-top:15px; padding:12px;" onkeyup="renderTable()">

        <table class="student-table">
            <thead>
                <tr>
                    <th>Alumno / Grupo</th>
                    <th>Resultados Clave</th>
                    <th style="text-align:right;">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- JS llena esto -->
            </tbody>
        </table>
    </div>

</div>

<script>
    const DB_KEY = "cbta_db_expedientes";
    const TEMP_KEY = "cbta_paciente_temp"; 
    document.getElementById('fecha').valueAsDate = new Date();

    window.addEventListener('DOMContentLoaded', () => {
        cargarDesdeTemp();
        renderTable();
    });

    // 1. TABLA (El coraz√≥n del sistema)
    function renderTable() {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const tbody = document.getElementById('tableBody');
        const filtro = document.getElementById('searchBox').value.toLowerCase();
        
        document.getElementById('counter').innerText = db.length;
        tbody.innerHTML = "";

        if(db.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px; color:#90a4ae;">No hay expedientes guardados a√∫n.</td></tr>`;
            return;
        }

        db.filter(x => (x.nombre || "").toLowerCase().includes(filtro)).forEach(x => {
            // Crear Badges de Resultados
            let badges = "";
            if(x.scoreBAI) badges += `<span class="badge bg-gray">BAI:${x.scoreBAI}</span>`;
            if(x.scoreBDI) badges += `<span class="badge bg-blue">BDI:${x.scoreBDI}</span>`;
            if(x.penTotal) badges += `<span class="badge bg-purple">IPA:${x.penTotal}</span>`;
            if(x.scoreGOCA) badges += `<span class="badge bg-orange">GOCA:${x.scoreGOCA}</span>`;
            if(x.scoreSSI >= 1) badges += `<span class="badge bg-red">SSI:${x.scoreSSI}</span>`;

            let row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div style="font-weight:bold; color:#263238;">${x.nombre}</div>
                    <div style="font-size:0.75rem; color:#78909c;">${x.grupo || 'Sin grupo'} ‚Ä¢ ${x.fechaReg || ''}</div>
                </td>
                <td>${badges || '<span style="color:#cfd8dc; font-size:0.8rem;">Sin datos</span>'}</td>
                <td style="text-align:right; display:flex; justify-content:flex-end; gap:5px;">
                    <button class="btn-action btn-open" title="Abrir Expediente" onclick="cargarExpediente('${x.id_exp}')">üìÇ</button>
                    <button class="btn-action btn-del" title="Eliminar" onclick="borrarExpediente('${x.id_exp}')">üóëÔ∏è</button>
                </td>
            `;
            // Evento para clic en fila (excepto botones)
            row.addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') cargarExpediente(x.id_exp);
            });
            tbody.appendChild(row);
        });
    }

    // 2. CARGAR DATOS AL FORMULARIO
    function cargarExpediente(id) {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const record = db.find(x => x.id_exp === id);
        if(record) {
            llenarFormulario(record);
            // Efecto visual para indicar carga
            document.querySelector('.panel-captura').style.backgroundColor = "#fffde7";
            setTimeout(() => { document.querySelector('.panel-captura').style.backgroundColor = "white"; }, 300);
        }
    }

    function llenarFormulario(d) {
        const set = (id, val) => { 
            const el = document.getElementById(id);
            if(el) el.value = (val !== undefined && val !== null) ? val : ""; 
        };
        
        // Generales
        set('nombre', d.nombre); set('edad', d.edad); set('fecha', d.fecha); set('grupo', d.grupo); set('sexo', d.sexo);
        set('id_exp', d.id_exp);

        // Scores
        set('scorePHQ', d.phq); set('flagPHQ', d.phqFlag); set('scoreGAD', d.gad);
        set('hadsA', d.hadsA); set('hadsD', d.hadsD);
        set('scoreBAI', d.bai); set('f1', d.f1); set('f2', d.f2); set('f3', d.f3); set('f4', d.f4);
        set('idareE', d.idareE); set('idareR', d.idareR);
        set('scoreBDI', d.bdi); set('scoreBHS', d.bhs);
        set('scoreSSI', d.ssi); set('ssiFlags', d.ssiFlags);
        set('scorePlut', d.plut); set('scoreGOCA', d.goca); set('gocaNivel', d.gocaNivel);
        set('scoreLIRA', d.lira); set('liraCrisis', d.liraCrisis);
        set('scoreCDFR', d.cdfr); set('cdfrCita', d.cdfrCita);
        set('ebmaIAR', d.ebmaIAR); set('ebmaPerfil', d.ebmaPerfil);
        set('penTotal', d.penTotal);

        // Columbia & IPA Factors
        set('cssrsId', d.cId); set('cssrsPlan', d.cPlan); set('cssrsCond', d.cCond);
        for(let i=1; i<=15; i++) set(`penF${i}`, d[`penF${i}`]);
    }

    function cargarDesdeTemp() {
        const raw = localStorage.getItem(TEMP_KEY);
        if(raw) {
            const d = JSON.parse(raw);
            // Solo cargar autom√°ticamente si no hay conflicto, o preguntar
            if(confirm(`üì• Recibidos datos nuevos de: ${d.nombre}. ¬øCargar al formulario?`)) {
                llenarFormulario(d);
            }
        }
    }

    // 3. GUARDAR
    function guardarExpediente() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("El nombre es obligatorio para guardar."); return; }

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let id = document.getElementById('id_exp').value;
        
        // Capturar todos los inputs
        const inputs = document.querySelectorAll('input, select');
        let record = {};
        inputs.forEach(i => record[i.id] = i.value);
        
        // Datos calculados o de sistema
        record.fechaReg = new Date().toLocaleDateString();
        // Asegurar compatibilidad de nombres de variables
        record.bai = document.getElementById('scoreBAI').value;
        record.bdi = document.getElementById('scoreBDI').value;
        record.penTotal = document.getElementById('penTotal').value;

        if(id) {
            const index = db.findIndex(x => x.id_exp === id);
            if(index !== -1) db[index] = record;
        } else {
            record.id_exp = Date.now().toString();
            db.push(record);
            document.getElementById('id_exp').value = record.id_exp;
        }

        localStorage.setItem(DB_KEY, JSON.stringify(db));
        localStorage.removeItem(TEMP_KEY); // Limpiar temp
        
        renderTable();
        alert("‚úÖ Expediente guardado exitosamente.");
    }

    function borrarExpediente(id) {
        if(confirm("¬øEliminar permanentemente este expediente?")) {
            let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            db = db.filter(x => x.id_exp !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderTable();
            limpiarFormulario();
        }
    }

    function limpiarFormulario() {
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.getElementById('fecha').valueAsDate = new Date();
    }

    // 4. PDF GENERATOR (Minimizado para brevedad, funcional)
    function generarPDF() {
        const val = (id) => document.getElementById(id).value;
        const d = { nombre: val('nombre'), edad: val('edad'), fecha: val('fecha'), grupo: val('grupo') };
        // Mapear scores para reporte
        d.bai = val('scoreBAI'); d.bdi = val('scoreBDI'); d.pen = val('penTotal'); d.goca = val('scoreGOCA');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(233, 30, 99); doc.rect(0, 0, 210, 30, 'F'); // Encabezado rosa/rojo
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("CBTa No. 130 - Informe Integral", 105, 18, null, null, "center");
        
        doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica", "normal");
        doc.text(`Estudiante: ${d.nombre}`, 20, 45);
        doc.text(`Edad: ${d.edad} | Grupo: ${d.grupo} | Fecha: ${d.fecha}`, 20, 52);
        doc.line(20, 58, 190, 58);

        let y = 70;
        const addR = (lbl, v) => {
            if(v) {
                doc.text(lbl, 20, y);
                doc.setFont("helvetica", "bold");
                doc.text(v.toString(), 160, y);
                doc.setFont("helvetica", "normal");
                doc.line(20, y+2, 190, y+2);
                y+=10;
            }
        };

        doc.setFontSize(12); doc.setTextColor(38, 50, 56);
        doc.text("RESUMEN DE RESULTADOS", 20, y); y+=10;
        doc.setFontSize(10);

        addR("Inventario de Ansiedad (BAI)", d.bai);
        addR("Inventario de Depresi√≥n (BDI-II)", d.bdi);
        addR("Pensamientos Autom√°ticos (IPA)", d.pen);
        addR("Observaci√≥n Conductual (GOCA)", d.goca);
        // Agregar m√°s aqu√≠...

        doc.save(`Reporte_${d.nombre}.pdf`);
    }
</script>
</body>
</html>


