<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Evaluaciones - Suite Integral</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
    /* ESTILO PROFESIONAL (Basado en tu imagen) */
    :root { --primary: #d81b60; --primary-dark: #ad1457; --bg: #f4f6f8; --text: #263238; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    
    /* HEADER */
    .top-bar { background: white; padding: 15px 25px; border-radius: 16px; box-shadow: 0 2px 15px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand-icon { width: 40px; height: 40px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
    .brand-text h1 { font-size: 1.1rem; font-weight: 800; margin: 0; }
    .brand-text p { font-size: 0.8rem; color: #90a4ae; margin: 0; }
    
    /* LAYOUT GRID */
    .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; max-width: 1400px; margin: 0 auto; }
    
    /* PANELES */
    .panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); height: fit-content; }
    
    /* FORMULARIOS */
    .section-title { font-size: 0.9rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .input-group { margin-bottom: 15px; }
    label { display: block; font-size: 0.75rem; font-weight: 700; color: #546e7a; margin-bottom: 5px; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 12px; border: 2px solid #eceff1; border-radius: 10px; font-size: 0.9rem; transition: 0.2s; box-sizing: border-box; }
    input:focus { border-color: var(--primary); outline: none; background: #fff; }

    /* LISTA DE PRUEBAS (Izquierda) */
    .test-list { display: flex; flex-direction: column; gap: 8px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
    .test-item { display: flex; align-items: center; padding: 12px; border: 2px solid #f0f2f5; border-radius: 12px; transition: 0.2s; background: white; }
    .test-item:hover { border-color: #e0e0e0; background: #fafafa; }
    .test-item input { width: 20px; height: 20px; margin: 0 10px 0 0; accent-color: var(--primary); cursor: pointer; border: 2px solid #ddd; }
    
    .test-info { flex: 1; cursor: help; } /* Cursor de ayuda para indicar tooltip */
    .test-name { font-weight: 600; font-size: 0.9rem; color: #37474f; }
    .test-desc { font-size: 0.7rem; color: #90a4ae; }
    
    .btn-preview { background: #e3f2fd; color: #1565C0; border: none; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; margin-left: 5px; }
    .btn-preview:hover { background: #1565C0; color: white; }

    /* BOT√ìN GENERAR */
    .btn-generate { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 15px rgba(216, 27, 96, 0.3); transition: transform 0.2s; }
    .btn-generate:active { transform: scale(0.98); }

    /* TABLA EXPEDIENTES (Derecha) */
    .student-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .student-table th { text-align: left; font-size: 0.75rem; color: #b0bec5; font-weight: 800; padding: 0 15px; text-transform: uppercase; }
    .student-table td { background: #fcfcfc; padding: 15px; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
    .student-table td:first-child { border-left: 1px solid #f0f0f0; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    .student-table td:last-child { border-right: 1px solid #f0f0f0; border-top-right-radius: 12px; border-bottom-right-radius: 12px; text-align: right; }
    
    .user-avatar { width: 35px; height: 35px; background: #eceff1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #546e7a; font-size: 0.8rem; margin-right: 10px; }
    .user-info { display: flex; align-items: center; }
    
    .badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; font-weight: 700; background: #eceff1; color: #546e7a; margin-right: 4px; }
    .badge.alert { background: #ffebee; color: #c62828; }
    
    .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-icon { width: 36px; height: 36px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-edit { background: #e3f2fd; color: #1976D2; }
    .btn-edit:hover { background: #1976D2; color: white; }
    .btn-del { background: #fff; border: 1px solid #ffcdd2; color: #e53935; }

    /* MODAL EDICI√ìN (Overlay) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 20px; padding: 30px; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    
    .close-modal { float: right; cursor: pointer; font-size: 1.5rem; color: #90a4ae; }
    
    /* Grilla de Inputs en Modal */
    .scores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; background: #f5f5f5; padding: 15px; border-radius: 12px; }
    .score-item label { font-size: 0.7rem; margin-bottom: 2px; }
    .score-item input { padding: 8px; text-align: center; font-weight: bold; color: #37474f; }

    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">
        <div class="brand-icon">üìä</div>
        <div class="brand-text">
            <h1>Gestor de Evaluaciones</h1>
            <p>Suite Integral v13.0</p>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="window.location.href='index.html'" class="btn-preview" style="width:auto; padding:0 15px; font-weight:bold;">üè† Ir al Men√∫ Principal</button>
    </div>
</div>

<div class="dashboard-grid">
    
    <!-- PANEL IZQUIERDO: DISPATCHER (Enviar Pruebas) -->
    <div class="panel">
        <div class="section-title">üöÄ Nueva Bater√≠a</div>
        <p style="font-size:0.85rem; color:#78909c; margin-bottom:20px;">Selecciona las pruebas y genera el enlace para el alumno.</p>

        <div class="test-list">
            <!-- LISTA COMPLETA DE PRUEBAS -->
            <!-- Funci√≥n auxiliar para generar items -->
            <script>
                const tests = [
                    {id:'chkPHQ', n:'PHQ-9', t:'Cuestionario de Salud (Depresi√≥n)', f:'phq9.html'},
                    {id:'chkGAD', n:'GAD-7', t:'Escala de Ansiedad Generalizada', f:'gad7.html'},
                    {id:'chkBAI', n:'BAI', t:'Inventario de Ansiedad de Beck', f:'ansiedadbeck.html'},
                    {id:'chkBDI', n:'BDI-II', t:'Inventario de Depresi√≥n de Beck', f:'depbeck.html'},
                    {id:'chkHADS', n:'HADS', t:'Escala Hospitalaria de Ansiedad y Depresi√≥n', f:'hads.html'},
                    {id:'chkIDARE', n:'IDARE', t:'Inventario de Ansiedad Rasgo-Estado', f:'idare.html'},
                    {id:'chkPEN', n:'PenAuto (IPA)', t:'Inventario de Pensamientos Autom√°ticos', f:'penauto.html'},
                    {id:'chkSSI', n:'SSI', t:'Escala de Ideaci√≥n Suicida', f:'ssibeck.html'},
                    {id:'chkBHS', n:'BHS', t:'Escala de Desesperanza de Beck', f:'bhs.html'},
                    {id:'chkPlut', n:'Plutchik', t:'Escala de Riesgo Suicida', f:'plutchik.html'},
                    {id:'chkCSS', n:'Columbia', t:'Escala de Severidad Suicida', f:'columbia.html'},
                    {id:'chkGOCA', n:'GOCA', t:'Gu√≠a de Observaci√≥n Conductual (Docente)', f:'goca.html'},
                    {id:'chkLIRA', n:'LIRA', t:'Lista de Riesgo Acad√©mico (Docente)', f:'lira.html'},
                    {id:'chkCDFR', n:'CDFR', t:'Cuestionario de Factores de Riesgo', f:'cdfr.html'},
                    {id:'chkEBMA', n:'EBMA', t:'Escala de Motivaci√≥n Acad√©mica', f:'ebma.html'}
                ];

                tests.forEach(t => {
                    document.write(`
                        <div class="test-item">
                            <input type="checkbox" id="${t.id}">
                            <div class="test-info" title="${t.t}">
                                <div class="test-name">${t.n}</div>
                                <div class="test-desc">${t.t.substring(0, 28)}...</div>
                            </div>
                            <button class="btn-preview" title="Ver prueba" onclick="window.open('${t.f}', '_blank')">üëÅÔ∏è</button>
                        </div>
                    `);
                });
            </script>
        </div>

        <button class="btn-generate" onclick="generarLink()">üîó Generar Link √önico</button>
    </div>

    <!-- PANEL DERECHO: DATABASE (Expedientes) -->
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div class="section-title" style="margin:0;">üìÇ Expedientes Activos</div>
            <input type="text" id="search" placeholder="üîç Buscar alumno..." style="padding:8px; width:200px; border-radius:8px; border:1px solid #ddd;" onkeyup="renderTable()">
        </div>

        <table class="student-table">
            <thead>
                <tr>
                    <th>Alumno / Grupo</th>
                    <th>Resultados Clave</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Se llena con JS -->
            </tbody>
        </table>
        
        <div id="empty-msg" style="text-align:center; color:#b0bec5; margin-top:40px;">
            <div style="font-size:3rem; margin-bottom:10px;">üì≠</div>
            No hay expedientes guardados.<br>Realiza una prueba y gu√°rdala.
        </div>
    </div>
</div>

<!-- MODAL DE EDICI√ìN / VISUALIZACI√ìN -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 style="color:#37474f; margin-top:0;">üìù Detalle del Expediente</h2>
        
        <input type="hidden" id="id_exp">
        
        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div><label>Nombre</label><input type="text" id="nombre"></div>
            <div><label>Edad</label><input type="number" id="edad"></div>
            <div><label>Grupo</label><input type="text" id="grupo"></div>
            <div><label>Fecha</label><input type="date" id="fecha"></div>
        </div>

        <div class="section-title">üìä Resultados Cl√≠nicos</div>
        <div class="scores-grid">
            <div class="score-item"><label>PHQ-9</label><input type="number" id="scorePHQ"></div>
            <div class="score-item"><label>GAD-7</label><input type="number" id="scoreGAD"></div>
            <div class="score-item"><label>BAI</label><input type="number" id="scoreBAI"></div>
            <div class="score-item"><label>BDI-II</label><input type="number" id="scoreBDI"></div>
            <div class="score-item"><label>HADS-A</label><input type="number" id="hadsA"></div>
            <div class="score-item"><label>HADS-D</label><input type="number" id="hadsD"></div>
            <div class="score-item"><label>IPA</label><input type="number" id="penTotal"></div>
            <div class="score-item"><label>IDARE-E</label><input type="number" id="idareE"></div>
        </div>

        <div class="section-title" style="margin-top:20px; color:#7b1fa2;">üö® Riesgo y Psicopedagog√≠a</div>
        <div class="scores-grid" style="background:#f3e5f5;">
            <div class="score-item"><label>SSI</label><input type="number" id="scoreSSI"></div>
            <div class="score-item"><label>BHS</label><input type="number" id="scoreBHS"></div>
            <div class="score-item"><label>GOCA</label><input type="number" id="scoreGOCA"></div>
            <div class="score-item"><label>LIRA</label><input type="number" id="scoreLIRA"></div>
            <div class="score-item"><label>EBMA(IAR)</label><input type="number" id="ebmaIAR"></div>
        </div>

        <!-- Campos Ocultos para PDF -->
        <div style="display:none;">
            <input id="sexo"><input id="idareR"><input id="scoreCDFR"><input id="scorePlut">
            <input id="f1"><input id="f2"><input id="f3"><input id="f4">
            <input id="flagPHQ"><input id="ssiFlags"><input id="gocaNivel">
            <input id="liraCrisis"><input id="cdfrCita"><input id="ebmaPerfil">
            <input id="cssrsId"><input id="cssrsPlan"><input id="cssrsCond">
            <!-- IPA F -->
            <input id="penF1"><input id="penF2"><input id="penF3"><input id="penF4"><input id="penF5"><input id="penF6"><input id="penF7"><input id="penF8"><input id="penF9"><input id="penF10"><input id="penF11"><input id="penF12"><input id="penF13"><input id="penF14"><input id="penF15">
        </div>

        <div style="margin-top:25px; display:flex; gap:10px;">
            <button class="btn-generate" style="background:#1976D2;" onclick="guardarCambios()">üíæ Guardar Cambios</button>
            <button class="btn-generate" style="background:#37474f;" onclick="generarPDF()">üìÑ Descargar PDF</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY = "cbta_db_expedientes";
    const TEMP_KEY = "cbta_paciente_temp";
    const NUMERO_DESTINO = "523111477413";
    const ipaNames = ["Filtraje", "Pens. Polarizado", "Sobregeneralizaci√≥n", "Int. Pensamiento", "Visi√≥n Catastr√≥fica", "Personalizaci√≥n", "Falacia Control", "Falacia Justicia", "Raz. Emocional", "Falacia Cambio", "Etiquetas Globales", "Culpabilidad", "Los Deber√≠as", "Falacia Raz√≥n", "Falacia Recompensa"];

    document.addEventListener('DOMContentLoaded', () => {
        renderTable();
        checkTempData();
    });

    // --- FUNCI√ìN 1: TABLA DE EXPEDIENTES ---
    function renderTable() {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const tbody = document.getElementById('tableBody');
        const filtro = document.getElementById('search').value.toLowerCase();
        const emptyMsg = document.getElementById('empty-msg');
        
        tbody.innerHTML = "";
        let count = 0;

        db.forEach(x => {
            if((x.nombre || "").toLowerCase().includes(filtro)) {
                count++;
                let badges = "";
                // Badges inteligentes (solo si hay dato)
                if(x.bai) badges += `<span class="badge">BAI:${x.bai}</span>`;
                if(x.bdi) badges += `<span class="badge">BDI:${x.bdi}</span>`;
                if(x.goca) badges += `<span class="badge">GOCA:${x.goca}</span>`;
                if(x.ssi > 0) badges += `<span class="badge alert">SSI:${x.ssi}</span>`;

                let row = `<tr>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${x.nombre.charAt(0)}</div>
                            <div>
                                <div style="font-weight:700; font-size:0.9rem;">${x.nombre}</div>
                                <div style="font-size:0.75rem; color:#90a4ae;">${x.grupo || 'Sin Grupo'} ‚Ä¢ ${x.fechaReg}</div>
                            </div>
                        </div>
                    </td>
                    <td>${badges || '<span style="color:#cfd8dc; font-size:0.7rem;">Sin datos</span>'}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-icon btn-edit" onclick="abrirExpediente('${x.id_exp}')" title="Abrir / Editar">‚úèÔ∏è</button>
                            <button class="btn-icon btn-del" onclick="borrarExpediente('${x.id_exp}')" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            }
        });
        
        emptyMsg.style.display = count === 0 ? 'block' : 'none';
    }

    // --- FUNCI√ìN 2: ABRIR MODAL Y CARGAR ---
    function abrirExpediente(id) {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const record = db.find(x => x.id_exp === id);
        if(record) {
            llenarFormulario(record);
            document.getElementById('editModal').style.display = 'flex';
        }
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function llenarFormulario(d) {
        const set = (id, val) => { 
            const el = document.getElementById(id);
            if(el) el.value = (val !== undefined && val !== null) ? val : ""; 
        };
        // Datos Generales
        set('id_exp', d.id_exp); set('nombre', d.nombre); set('edad', d.edad); 
        set('grupo', d.grupo); set('fecha', d.fecha); set('sexo', d.sexo);
        
        // Scores
        set('scorePHQ', d.phq); set('scoreGAD', d.gad); set('scoreBAI', d.bai);
        set('scoreBDI', d.bdi); set('hadsA', d.hadsA); set('hadsD', d.hadsD);
        set('penTotal', d.penTotal); set('idareE', d.idareE); set('idareR', d.idareR);
        set('scoreSSI', d.ssi); set('scoreBHS', d.bhs); set('scoreGOCA', d.goca);
        set('scoreLIRA', d.lira); set('ebmaIAR', d.ebmaIAR);
        
        // Ocultos
        set('flagPHQ', d.phqFlag); set('ssiFlags', d.ssiFlags);
        set('gocaNivel', d.gocaNivel); set('liraCrisis', d.liraCrisis);
        set('ebmaPerfil', d.ebmaPerfil); set('cdfrCita', d.cdfrCita);
        set('cssrsId', d.cId); set('cssrsPlan', d.cPlan); set('cssrsCond', d.cCond);
        
        // IPA Factores
        for(let i=1; i<=15; i++) set(`penF${i}`, d[`penF${i}`]);
    }

    // --- FUNCI√ìN 3: GUARDAR DESDE MODAL ---
    function guardarCambios() {
        const id = document.getElementById('id_exp').value;
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        
        // Recopilar datos del modal
        const inputs = document.querySelectorAll('#editModal input, #editModal select');
        let newData = {};
        inputs.forEach(i => newData[i.id] = i.value);
        newData.fechaReg = new Date().toLocaleDateString();

        // Actualizar
        const index = db.findIndex(x => x.id_exp === id);
        if(index !== -1) {
            db[index] = { ...db[index], ...newData }; // Merge
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            alert("‚úÖ Expediente actualizado.");
            renderTable();
            closeModal();
        }
    }

    // --- FUNCI√ìN 4: DETECTAR DATOS NUEVOS DE TEST ---
    function checkTempData() {
        const raw = localStorage.getItem(TEMP_KEY);
        if(raw) {
            const d = JSON.parse(raw);
            if(confirm(`üì• Se han recibido datos de: ${d.nombre}\n¬øDeseas crear o actualizar su expediente?`)) {
                // Guardar directo en DB y borrar temp
                let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
                
                // Buscar si ya existe por nombre (simple match)
                let existingIndex = db.findIndex(x => x.nombre === d.nombre);
                
                if(existingIndex !== -1) {
                    // Actualizar existente
                    db[existingIndex] = { ...db[existingIndex], ...d };
                    alert("üîÑ Expediente existente actualizado.");
                } else {
                    // Crear nuevo
                    d.id_exp = Date.now().toString();
                    d.fechaReg = new Date().toLocaleDateString();
                    db.push(d);
                    alert("‚ú® Nuevo expediente creado.");
                }
                
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                localStorage.removeItem(TEMP_KEY);
                renderTable();
            }
        }
    }

    // --- FUNCI√ìN 5: GENERAR LINK WHATSAPP (Panel Izquierdo) ---
    function generarLink() {
        const base = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
        let msg = "Hola, por favor contesta las siguientes evaluaciones:%0A%0A";
        let c = 0;
        
        tests.forEach(t => {
            if(document.getElementById(t.id).checked) {
                c++;
                msg += `*${c}. ${t.n}:*%0A${base + t.f}%0A%0A`;
            }
        });
        msg += "Env√≠a los resultados al finalizar. ¬°Gracias!";
        
        if(c===0) alert("Selecciona al menos una prueba.");
        else window.open(`https://wa.me/${NUMERO_DESTINO}?text=${msg}`, '_blank');
    }

    // --- FUNCI√ìN 6: BORRAR ---
    function borrarExpediente(id) {
        if(confirm("¬øEst√°s seguro de borrar este expediente?")) {
            let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            db = db.filter(x => x.id_exp !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderTable();
        }
    }

    // --- FUNCI√ìN 7: GENERAR PDF ---
    function generarPDF() {
        const val = (id) => document.getElementById(id).value;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(216, 27, 96); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("CBTa No. 130 - Informe Integral", 105, 20, null, null, "center");
        
        doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Estudiante: ${val('nombre')}`, 20, 50);
        doc.text(`Edad: ${val('edad')} | Grupo: ${val('grupo')}`, 140, 50);
        doc.line(20, 55, 190, 55);

        let y = 65;
        const addR = (l, v, i, alert=false) => {
            if(y>270){doc.addPage();y=20;}
            doc.setFont("helvetica", "bold"); doc.text(l, 20, y);
            doc.setFont("helvetica", "normal"); doc.text(v ? v.toString() : "-", 90, y);
            if(alert) doc.setTextColor(200,0,0);
            doc.text(i || "", 120, y);
            doc.setTextColor(0);
            doc.line(20, y+2, 190, y+2); y+=8;
        };

        // Cl√≠nica
        addR("PHQ-9 (Dep)", val('scorePHQ'), val('scorePHQ')>=10?"ALERTA":"", val('scorePHQ')>=10);
        addR("GAD-7 (Ans)", val('scoreGAD'), val('scoreGAD')>=10?"ALERTA":"", val('scoreGAD')>=10);
        addR("BAI (Ans)", val('scoreBAI'), val('scoreBAI')>15?"Alto":"", val('scoreBAI')>15);
        addR("BDI-II (Dep)", val('scoreBDI'), val('scoreBDI')>18?"Alto":"", val('scoreBDI')>18);
        
        // IPA Detalle
        if(val('penTotal')) {
            addR("IPA (Pensamientos)", val('penTotal'), val('penTotal')>45?"Alto":"", val('penTotal')>90);
            y+=2; doc.setFontSize(8); doc.setTextColor(100);
            let highs = [];
            for(let i=1; i<=15; i++) { if(val(`penF${i}`) >= 7) highs.push(ipaNames[i-1]); }
            if(highs.length > 0) doc.text("Altos en: " + highs.join(", "), 20, y);
            y+=6; doc.setFontSize(10); doc.setTextColor(0);
        }

        // Riesgo
        addR("SSI (Suicida)", val('scoreSSI'), val('scoreSSI')>5?"RIESGO":"", true);
        addR("GOCA (Aula)", val('scoreGOCA'), val('scoreGOCA')>80?"Alerta":"", val('scoreGOCA')>80);
        addR("EBMA (IAR)", val('ebmaIAR'), val('ebmaPerfil'));

        y+=10; doc.rect(20, y, 170, 40); doc.text("Observaciones:", 22, y+5);
        doc.save(`Expediente_${val('nombre')}.pdf`);
    }
</script>
</body>
</html>


