<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Expedientes - CBTa 130</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background-color: #eceff1; padding: 20px; margin: 0; }
    .main-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
    
    /* NAV TABS */
    .nav-tabs { display: flex; background: #263238; }
    .nav-tab { flex: 1; padding: 20px; text-align: center; color: #b0bec5; cursor: pointer; font-weight: bold; border-bottom: 4px solid transparent; transition: all 0.3s; }
    .nav-tab:hover { background: #37474f; color: white; }
    .nav-tab.active { background: #37474f; color: white; border-bottom-color: #00acc1; }

    /* CONTENIDO */
    .tab-content { padding: 30px; display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* FORMULARIOS */
    .header-section { 
        background: #f5f5f5; padding: 10px 15px; border-left: 5px solid #546e7a; 
        font-weight: bold; margin: 25px 0 15px 0; color: #37474f; text-transform: uppercase; font-size: 0.9rem; display: flex; justify-content: space-between;
    }
    .header-clinica { border-left-color: #1565C0; background: #e3f2fd; color: #0d47a1; }
    .header-pedag { border-left-color: #00695c; background: #e0f2f1; color: #004d40; }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    .input-wrapper { margin-bottom: 5px; }
    label { font-size: 0.8rem; font-weight: bold; display: block; color: #546e7a; margin-bottom: 3px; }
    input, select { width: 100%; padding: 8px; border: 1px solid #cfd8dc; border-radius: 4px; box-sizing: border-box; }
    
    /* EXPEDIENTES TABLE */
    .search-bar { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #cfd8dc; border-radius: 8px; margin-bottom: 20px; }
    .student-table { width: 100%; border-collapse: collapse; }
    .student-table th { background: #eceff1; padding: 12px; text-align: left; color: #455a64; }
    .student-table td { padding: 12px; border-bottom: 1px solid #eee; }
    .student-table tr:hover { background: #f5f5f5; }
    .action-btn { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
    .btn-edit { background: #1976D2; color: white; }
    .btn-del { background: #c62828; color: white; }

    /* BOTONES ACCI√ìN */
    .btn-main { background: #00897b; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; }
    .btn-save-db { background: #1565C0; }
    .btn-clear { background: #78909c; margin-top: 10px; }
</style>
</head>
<body>

<div class="main-container">
    <!-- NAVEGACI√ìN -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('tab-captura')">üìù Captura / Edici√≥n</div>
        <div class="nav-tab" onclick="switchTab('tab-expedientes')">üìÇ Base de Datos (Expedientes)</div>
    </div>

    <!-- PESTA√ëA 1: CAPTURA -->
    <div id="tab-captura" class="tab-content active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:#37474f;">Ficha del Estudiante</h2>
            <button onclick="limpiarFormulario()" class="action-btn btn-del">Limpiar Todo</button>
        </div>

        <!-- DATOS GENERALES -->
        <div class="header-section">Datos de Identificaci√≥n</div>
        <div class="form-grid">
            <div class="input-wrapper"><label>Nombre Completo:</label><input type="text" id="nombre"></div>
            <div class="input-wrapper"><label>Edad:</label><input type="number" id="edad"></div>
            <div class="input-wrapper"><label>Sexo:</label><select id="sexo"><option value="">--</option><option value="M">Masculino</option><option value="F">Femenino</option></select></div>
            <div class="input-wrapper"><label>Fecha:</label><input type="date" id="fecha"></div>
            <div class="input-wrapper"><label>ID Expediente (Auto):</label><input type="text" id="id_exp" readonly style="background:#eee;"></div>
        </div>

        <!-- √ÅREA CL√çNICA -->
        <div class="header-section header-clinica">√ÅREA CL√çNICA (Psicolog√≠a)</div>
        
        <!-- Tamizaje -->
        <div class="form-grid">
            <div class="input-wrapper"><label style="color:#00695c">PHQ-9 (Total):</label><input type="number" id="phq"></div>
            <div class="input-wrapper"><label style="color:#00695c">PHQ-9 (√çtem 9):</label><input type="number" id="phqFlag"></div>
            <div class="input-wrapper"><label style="color:#e65100">GAD-7 (Total):</label><input type="number" id="gad"></div>
            <div class="input-wrapper"><label style="color:#880e4f">HADS (Ans):</label><input type="number" id="hadsA"></div>
            <div class="input-wrapper"><label style="color:#880e4f">HADS (Dep):</label><input type="number" id="hadsD"></div>
        </div>

        <!-- Profundizaci√≥n -->
        <div class="form-grid" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
            <div class="input-wrapper"><label style="color:#2e7d32">BAI (Total):</label><input type="number" id="bai"></div>
            <div class="input-wrapper"><label style="color:#37474f">IDARE (Estado):</label><input type="number" id="idareE"></div>
            <div class="input-wrapper"><label style="color:#37474f">IDARE (Rasgo):</label><input type="number" id="idareR"></div>
            <div class="input-wrapper"><label style="color:#1565C0">BDI-II (Total):</label><input type="number" id="bdi"></div>
            <div class="input-wrapper"><label style="color:#212121">BHS (Total):</label><input type="number" id="bhs"></div>
        </div>
        
        <!-- Factores BAI Ocultos para PDF -->
        <div style="display:none;">
            <input id="f1"><input id="f2"><input id="f3"><input id="f4">
        </div>

        <!-- Riesgo -->
        <div class="form-grid" style="margin-top:15px; background:#ffebee; padding:10px; border-radius:5px;">
            <div class="input-wrapper"><label style="color:#c62828">SSI (Total):</label><input type="number" id="ssi"></div>
            <div class="input-wrapper"><label style="color:#c62828">SSI (Flags):</label><input type="text" id="ssiFlags"></div>
            <div class="input-wrapper"><label style="color:#5d4037">Plutchik:</label><input type="number" id="plut"></div>
            <div class="input-wrapper"><label style="color:#b71c1c">Columbia (Positivo):</label>
                <select id="cssrs">
                    <option value="0">Negativo</option>
                    <option value="1">Ideaci√≥n</option>
                    <option value="2">Plan/Conducta</option>
                </select>
            </div>
        </div>

        <!-- √ÅREA PSICOPEDAG√ìGICA -->
        <div class="header-section header-pedag">√ÅREA PSICOPEDAG√ìGICA</div>
        <div class="form-grid">
            <div class="input-wrapper"><label style="color:#ff6f00">GOCA (Riesgo):</label><input type="number" id="goca"></div>
            <div class="input-wrapper"><label style="color:#ff6f00">GOCA (Nivel):</label><input type="text" id="gocaNivel"></div>
            <div class="input-wrapper"><label style="color:#00838f">Entrevista (Folio):</label><input type="text" id="entrevFolio" placeholder="Si existe"></div>
        </div>

        <!-- ACCIONES -->
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="guardarExpediente()" class="btn-main btn-save-db">üíæ Guardar/Actualizar Expediente</button>
            <button onclick="generarPDF()" class="btn-main" style="background:#bf360c;">üìÑ Generar PDF Integral</button>
        </div>
    </div>

    <!-- PESTA√ëA 2: EXPEDIENTES -->
    <div id="tab-expedientes" class="tab-content">
        <h2>Base de Datos de Estudiantes</h2>
        <input type="text" id="searchBox" class="search-bar" placeholder="üîç Buscar por nombre..." onkeyup="renderTable()">
        
        <div style="overflow-x:auto;">
            <table class="student-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Edad</th>
                        <th>Fecha Reg.</th>
                        <th>Riesgo (SSI/GOCA)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Se llena con JS -->
                </tbody>
            </table>
        </div>
        <p style="text-align:center; color:#888; font-size:0.8rem; margin-top:20px;">Nota: Los datos se guardan en este dispositivo (iPad/PC). Si borras el cach√©, se pierden.</p>
    </div>
</div>

<div style="text-align:center; margin-top:20px;">
    <a href="index.html" style="color:#546e7a; text-decoration:none;">‚Üê Volver al Panel Principal</a>
</div>

<script>
    const DB_KEY = "cbta_db_expedientes";
    const TEMP_KEY = "cbta_paciente_temp"; // Para leer lo que llega de los tests
    
    // Al iniciar
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('fecha').valueAsDate = new Date();
        cargarDesdeTemp();
        renderTable();
    });

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        // Activar estilo en bot√≥n
        event.target.classList.add('active');
        
        if(tabId === 'tab-expedientes') renderTable();
    }

    // 1. CARGAR DATOS TEMPORALES (Si vienes de hacer un test)
    function cargarDesdeTemp() {
        const raw = localStorage.getItem(TEMP_KEY);
        if(raw) {
            const d = JSON.parse(raw);
            if(confirm("üì• Se detectaron datos nuevos de un test reciente. ¬øDeseas cargarlos al formulario?")) {
                llenarFormulario(d);
                // No borramos temp a√∫n por seguridad
            }
        }
    }

    function llenarFormulario(d) {
        const set = (id, val) => { if(val !== undefined) document.getElementById(id).value = val; };
        
        set('nombre', d.nombre); set('edad', d.edad); set('sexo', d.sexo);
        if(d.id) set('id_exp', d.id); // Si ya ten√≠a ID

        // Cl√≠nica
        set('phq', d.phq); set('phqFlag', d.phqFlag); set('gad', d.gad);
        set('hadsA', d.hadsA); set('hadsD', d.hadsD);
        set('bai', d.bai); set('f1', d.f1); set('f2', d.f2); set('f3', d.f3); set('f4', d.f4);
        set('idareE', d.idareE); set('idareR', d.idareR);
        set('bdi', d.bdi); set('bhs', d.bhs);
        
        // Riesgo
        set('ssi', d.ssi); set('ssiFlags', d.ssiFlags); set('plut', d.plut);
        if(d.cId === "1" || d.cCond === "1") document.getElementById('cssrs').value = "2"; // Simplificado
        else if(d.cId === "1") document.getElementById('cssrs').value = "1";

        // Pedag√≥gica
        set('goca', d.goca); set('gocaNivel', d.gocaNivel);
    }

    // 2. GUARDAR EN BASE DE DATOS (Array en LocalStorage)
    function guardarExpediente() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("El nombre es obligatorio"); return; }

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let id = document.getElementById('id_exp').value;
        
        // Objeto con TODOS los campos
        const inputs = document.querySelectorAll('input, select');
        let record = {};
        inputs.forEach(i => record[i.id] = i.value);
        record.fechaReg = new Date().toLocaleDateString();

        if(id) {
            // Actualizar existente
            const index = db.findIndex(x => x.id_exp === id);
            if(index !== -1) db[index] = record;
        } else {
            // Nuevo
            record.id_exp = Date.now().toString(); // ID √∫nico basado en tiempo
            db.push(record);
            document.getElementById('id_exp').value = record.id_exp;
        }

        localStorage.setItem(DB_KEY, JSON.stringify(db));
        // Limpiar temp para evitar confusiones
        localStorage.removeItem(TEMP_KEY);
        
        alert("‚úÖ Expediente guardado/actualizado correctamente.");
        renderTable();
    }

    // 3. TABLA DE EXPEDIENTES
    function renderTable() {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const tbody = document.getElementById('tableBody');
        const filtro = document.getElementById('searchBox').value.toLowerCase();
        
        tbody.innerHTML = "";

        db.filter(x => x.nombre.toLowerCase().includes(filtro)).forEach(x => {
            let row = `<tr>
                <td><strong>${x.nombre}</strong></td>
                <td>${x.edad || '-'}</td>
                <td>${x.fechaReg}</td>
                <td>
                    ${x.ssi ? '<span style="color:#c62828">SSI:'+x.ssi+'</span>' : ''} 
                    ${x.goca ? '<span style="color:#e65100">GOCA:'+x.goca+'</span>' : ''}
                </td>
                <td>
                    <button class="action-btn btn-edit" onclick="cargarExpediente('${x.id_exp}')">‚úèÔ∏è Ver/Editar</button>
                    <button class="action-btn btn-del" onclick="borrarExpediente('${x.id_exp}')">üóëÔ∏è</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function cargarExpediente(id) {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const record = db.find(x => x.id_exp === id);
        if(record) {
            llenarFormulario(record);
            switchTab('tab-captura');
        }
    }

    function borrarExpediente(id) {
        if(confirm("¬øEst√°s seguro de eliminar este expediente? No se puede deshacer.")) {
            let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            db = db.filter(x => x.id_exp !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderTable();
        }
    }

    function limpiarFormulario() {
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.getElementById('fecha').valueAsDate = new Date();
    }

    // 4. GENERACI√ìN DE PDF (Tu funci√≥n existente, adaptada)
    function generarPDF() {
        // Recopilamos datos directo del formulario (que ya est√° lleno)
        const val = (id) => document.getElementById(id).value;
        const d = {
            nombre: val('nombre'), edad: val('edad'), fecha: val('fecha'),
            phq: val('phq'), flagPHQ: val('phqFlag'), gad: val('gad'),
            bai: val('bai'), bdi: val('bdi'), bhs: val('bhs'),
            ssi: val('ssi'), goca: val('goca'), gocaNivel: val('gocaNivel'),
            hadsA: val('hadsA'), hadsD: val('hadsD'),
            idareE: val('idareE'), idareR: val('idareR'),
            plut: val('plut')
        };

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFillColor(38, 50, 56); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("CBTa No. 130 - Informe Integral", 105, 20, null, null, "center");
        doc.setFontSize(12);
        doc.text("√Årea Cl√≠nica y Psicopedag√≥gica", 105, 30, null, null, "center");

        // Datos
        doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Estudiante: ${d.nombre}`, 20, 50);
        doc.text(`Edad: ${d.edad} a√±os`, 140, 50);
        doc.text(`Fecha: ${d.fecha}`, 140, 55);
        doc.line(20, 60, 190, 60);

        let y = 70;
        
        const section = (title, color) => {
            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.setTextColor(color[0], color[1], color[2]);
            doc.text(title, 20, y); y+=8;
            doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        };

        const row = (lbl, val, interp) => {
            if(y>270){doc.addPage(); y=20;}
            doc.text(lbl, 25, y);
            doc.text(val ? val.toString() : "-", 80, y);
            doc.text(interp || "", 100, y);
            doc.setDrawColor(230); doc.line(25, y+2, 185, y+2);
            y+=8;
        };

        // CLINICA
        section("I. EVALUACI√ìN CL√çNICA", [13, 71, 161]); // Azul
        if(d.phq) row("Depresi√≥n (PHQ-9)", d.phq, d.phq>=10?"ALERTA":"Bajo");
        if(d.gad) row("Ansiedad (GAD-7)", d.gad, d.gad>=10?"ALERTA":"Bajo");
        if(d.bai) row("Ansiedad (BAI)", d.bai, d.bai>15?"Significativo":"Bajo");
        if(d.bdi) row("Depresi√≥n (BDI)", d.bdi, d.bdi>18?"Significativo":"Bajo");
        if(d.idareE) row("IDARE (Estado)", d.idareE, "");
        if(d.hadsA) row("HADS", `A:${d.hadsA} D:${d.hadsD}`, "");

        y+=5;
        section("II. RIESGO SUICIDA", [198, 40, 40]); // Rojo
        if(d.ssi) row("SSI (Ideaci√≥n)", d.ssi, d.ssi>5?"RIESGO":"Bajo");
        if(d.bhs) row("BHS (Desesperanza)", d.bhs, d.bhs>8?"Riesgo":"Bajo");
        if(d.plut) row("Plutchik", d.plut, "");

        y+=5;
        section("III. PSICOPEDAGOG√çA", [0, 105, 92]); // Verde
        if(d.goca) row("GOCA (Aula)", d.goca, d.gocaNivel);

        y+=15;
        doc.rect(20, y, 170, 40);
        doc.text("Conclusiones y Recomendaciones:", 22, y+5);

        doc.save(`Expediente_${d.nombre}.pdf`);
    }
</script>
</body>
</html>


