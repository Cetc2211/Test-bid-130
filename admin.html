<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaluaciÃ³n PHQ-9 - CBTa 130</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1c1e; }
    header { background: linear-gradient(135deg, #00695c 0%, #00897b 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #00695c; text-align: center; margin-top: 0; border-bottom: 2px solid #b2dfdb; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 8px; color: #333; }
    input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    
    /* TABLA CORREGIDA */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; min-width: 600px; table-layout: fixed; }
    th, td { padding: 10px 5px; border-bottom: 1px solid #eee; vertical-align: middle; }
    th:first-child, td:first-child { width: 50%; text-align: left; padding-left: 10px; font-weight: 500; white-space: normal; }
    th:not(:first-child), td:not(:first-child) { width: 12.5%; text-align: center; }
    th { background-color: #e0f2f1; color: #004d40; position: sticky; top: 0; font-weight: bold; }
    tr:nth-child(even) { background-color: #fafafa; }
    input[type="radio"] { width: 24px; height: 24px; margin: 0 auto; display: block; cursor: pointer; }

    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; margin-top: 10px; } /* BotÃ³n Azul */
    .reset { background-color: #757575; }
    #result-area { display: none; text-align: center; margin-top: 20px; padding: 20px; background: #e0f2f1; border-radius: 10px; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Cuestionario de Salud (PHQ-9)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos del Alumno</h2>
        <div class="input-group"><label>Nombre Completo:</label><input type="text" id="nombre" required></div>
        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha" required></div>
        
        <div style="background-color:#e0f2f1; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #00695c;">
            <strong>Instrucciones:</strong> Durante las <strong>Ãºltimas 2 semanas</strong>, Â¿quÃ© tan seguido ha tenido molestias por los siguientes problemas?
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Problema</th><th>Nunca<br>(0)</th><th>Varios dÃ­as<br>(1)</th><th>+Mitad dÃ­as<br>(2)</th><th>Casi todos<br>(3)</th></tr>
                </thead>
                <tbody id="tabla-preguntas"></tbody>
            </table>
        </div>

        <div style="margin-top:20px; padding:15px; background:#fafafa; border-radius:10px;">
            <p style="font-weight:bold; color:#333;">10. Dificultad funcional:</p>
            <label style="display:block; margin-bottom:5px;"><input type="radio" name="item10" value="Ninguna" style="display:inline-block; vertical-align:middle; margin:0 5px 0 0;"> Ninguna dificultad</label>
            <label style="display:block; margin-bottom:5px;"><input type="radio" name="item10" value="Algo" style="display:inline-block; vertical-align:middle; margin:0 5px 0 0;"> Algo de dificultad</label>
            <label style="display:block; margin-bottom:5px;"><input type="radio" name="item10" value="Mucha" style="display:inline-block; vertical-align:middle; margin:0 5px 0 0;"> Mucha dificultad</label>
            <label style="display:block; margin-bottom:5px;"><input type="radio" name="item10" value="Extrema" style="display:inline-block; vertical-align:middle; margin:0 5px 0 0;"> Extrema dificultad</label>
        </div>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="finalizarTest()">âœ… Finalizar y Ver Opciones</button>
        </div>
    </div>

    <div id="result-area">
        <h3 style="color:#00695c;">Resultados Listos</h3>
        <p>Seleccione quÃ© desea hacer con los datos:</p>
        <div class="buttons">
            <!-- BOTÃ“N PARA DISPOSITIVO FIJO -->
            <button type="button" class="local-save" onclick="guardarLocalmente()">ðŸ’¾ Guardar en Expediente Local</button>
            
            <!-- BOTÃ“N PARA WHATSAPP -->
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">ðŸ“² Enviar por WhatsApp</button>
            
            <button type="button" class="reset" onclick="location.reload()">ðŸ”„ Nuevo Test</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp"; // Clave compartida con el Admin

    const preguntas = [
        "1. Poco interÃ©s o placer en hacer cosas",
        "2. Se ha sentido decaÃ­do, deprimido o sin esperanzas",
        "3. Dificultad para dormir o dormir demasiado",
        "4. Cansado o con poca energÃ­a",
        "5. Sin apetito o ha comido en exceso",
        "6. Sentirse mal consigo mismo (fracaso)",
        "7. Dificultad para concentrarse (leer, TV)",
        "8. Moverse muy lento o muy inquieto/agitado",
        "9. Pensamientos de estar mejor muerto o lastimarse"
    ];

    const tbody = document.getElementById('tabla-preguntas');
    preguntas.forEach((p, i) => {
        let html = `<tr><td>${p}</td>${[0,1,2,3].map(v=>`<td><input type="radio" name="item${i+1}" value="${v}"></td>`).join('')}</tr>`;
        tbody.innerHTML += html;
    });
    document.getElementById('fecha').valueAsDate = new Date();

    let datosFinales = null;

    function finalizarTest() {
        const nombre = document.getElementById('nombre').value;
        const edad = prompt("Por favor confirma la EDAD del alumno (para el expediente):"); // Pedir edad aquÃ­ si no estÃ¡ en el form
        const fecha = document.getElementById('fecha').value;
        if(!nombre) { alert("Nombre requerido"); return; }

        let total = 0, count = 0, item9 = 0;
        for(let i=1; i<=9; i++){
            const el = document.querySelector(`input[name="item${i}"]:checked`);
            if(el) { 
                let val = parseInt(el.value);
                total += val; count++; 
                if(i===9) item9 = val;
            }
        }
        if(count < 9) { alert(`Faltan preguntas (${count}/9)`); return; }

        const func = document.querySelector(`input[name="item10"]:checked`);
        const funcionalidad = func ? func.value : "No contestÃ³";
        
        // DATOS LISTOS
        datosFinales = { 
            nombre: nombre, 
            edad: edad, // Se guarda para el Admin
            fecha: fecha, 
            phq: total, 
            phqFlag: item9 
        };

        document.getElementById('test-form').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        window.scrollTo(0,0);
    }

    // --- FUNCIÃ“N NUEVA: GUARDAR EN DISPOSITIVO ---
    function guardarLocalmente() {
        if(!datosFinales) return;
        
        // 1. Leer lo que ya hay guardado
        let currentData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        
        // 2. Mezclar con los nuevos datos (sin borrar lo anterior)
        let updatedData = { ...currentData, ...datosFinales };
        
        // 3. Guardar de nuevo
        localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedData));
        
        alert("âœ… Datos guardados en este iPad.\nPuedes abrir el Panel de Admin para verlos.");
        // Opcional: Redirigir al menÃº
        // window.location.href = 'index.html';
    }

    function enviarWhatsApp(){
        if(!datosFinales) return;
        let m = `ðŸŒ¿ *DATOS PHQ-9*%0AðŸ‘¤ ${datosFinales.nombre}%0AðŸ“… ${datosFinales.fecha}%0AðŸ“Š Score: ${datosFinales.phq}`;
        if(datosFinales.phqFlag > 0) m += `%0AðŸš© Flag I9: ${datosFinales.phqFlag}`;
        window.location.href = `https://wa.me/${NUMERO_DESTINO}?text=${m}`;
    }
</script>
</body>
</html>


