<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Evaluaciones - Suite Integral</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background-color: #f4f6f8; padding: 20px; margin: 0; }
    
    /* BARRA SUPERIOR */
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .top-title { font-size: 1.2rem; font-weight: 800; color: #263238; margin: 0; }
    .btn-home { background-color: #eceff1; color: #455a64; text-decoration: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; transition: 0.2s; }
    .btn-home:hover { background-color: #cfd8dc; }

    .main-container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 400px 1fr; gap: 20px; }
    
    /* COLUMNA IZQUIERDA (CAPTURA) */
    .panel-captura { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; max-height: 90vh; overflow-y: auto; }
    .panel-title { color: #e91e63; font-size: 1rem; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid #fce4ec; padding-bottom: 5px; }
    
    .form-group { margin-bottom: 10px; }
    label { display: block; font-size: 0.75rem; font-weight: bold; color: #546e7a; margin-bottom: 3px; text-transform: uppercase; }
    input, select { width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; background: #fafafa; transition: 0.2s; }
    input:focus { border-color: #e91e63; background: white; outline: none; }

    /* GRID DE RESULTADOS */
    .scores-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .mini-label { font-size: 0.7rem; color: #78909c; font-weight: bold; }
    
    /* SECCIONES ESPEC√çFICAS */
    .sec-ipa { border-left: 4px solid #c2185b; background: #fce4ec; padding: 10px; margin-top: 10px; border-radius: 4px; }
    .ipa-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .ipa-item label { font-size: 0.6rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    /* COLUMNA DERECHA (TABLA) */
    .panel-tabla { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 500px; }
    
    .student-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .student-table th { text-align: left; font-size: 0.75rem; color: #90a4ae; text-transform: uppercase; padding: 10px; border-bottom: 1px solid #eee; }
    .student-table td { padding: 12px 10px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; font-size: 0.9rem; }
    .student-table tr:hover { background-color: #f9fafb; }
    
    /* BADGES */
    .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-right: 3px; margin-bottom: 2px; }
    .bg-gray { background: #eceff1; color: #455a64; }
    .bg-red { background: #ffebee; color: #c62828; }
    .bg-pink { background: #fce4ec; color: #880e4f; } /* IPA */

    /* BOTONES ACCI√ìN */
    .btn-action { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-view { background: #e3f2fd; color: #1565C0; }
    .btn-view:hover { background: #1565C0; color: white; }
    .btn-del { background: white; color: #ef5350; border: 1px solid #ef5350; }
    .btn-del:hover { background: #ef5350; color: white; }

    .btn-main { background: #e91e63; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); }
    
    /* Responsive */
    @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="top-bar">
    <div style="display:flex; align-items:center; gap:15px;">
        <div style="width:40px; height:40px; background:#e91e63; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">SI</div>
        <div>
            <h1 class="top-title">Gestor de Evaluaciones</h1>
            <span style="font-size:0.8rem; color:#78909c;">Base de Datos Local</span>
        </div>
    </div>
    <a href="index.html" class="btn-home">‚¨Ö Volver al Men√∫</a>
</div>

<div class="main-container">
    
    <!-- PANEL IZQUIERDO: FORMULARIO -->
    <div class="panel-captura">
        <div class="panel-title">üë§ Datos del Estudiante</div>
        <input type="hidden" id="id_exp">
        
        <div class="form-group"><label>Nombre Completo</label><input type="text" id="nombre"></div>
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1"><label>Edad</label><input type="number" id="edad"></div>
            <div class="form-group" style="flex:1"><label>Sexo</label><select id="sexo"><option value="">-</option><option value="H">Hombre</option><option value="M">Mujer</option></select></div>
        </div>
        <div class="form-group"><label>Grupo / Semestre</label><input type="text" id="grupo"></div>
        <div class="form-group"><label>Fecha</label><input type="date" id="fecha"></div>

        <div class="panel-title" style="margin-top:20px; color:#455a64; border-color:#eceff1;">üìä Resultados</div>
        
        <!-- Scores Generales -->
        <div class="scores-grid">
            <div><label>BAI</label><input type="number" id="bai"></div>
            <div><label>BDI-II</label><input type="number" id="bdi"></div>
            <div><label>PHQ-9</label><input type="number" id="phq"></div>
            <div><label>GAD-7</label><input type="number" id="gad"></div>
            <div><label>GOCA</label><input type="number" id="goca"></div>
            <div><label>LIRA</label><input type="number" id="lira"></div>
            <div><label>SSI</label><input type="number" id="ssi"></div>
            <div><label>BHS</label><input type="number" id="bhs"></div>
        </div>

        <!-- SECCI√ìN IPA (NUEVA) -->
        <div class="sec-ipa">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <label style="color:#880e4f;">üß† IPA (PENAUTO)</label>
                <input type="number" id="penTotal" placeholder="Total" style="width:60px; text-align:center; font-weight:bold;">
            </div>
            <div class="ipa-grid">
                <!-- 15 Factores -->
                <div class="ipa-item"><label>1.Filt</label><input type="number" id="penF1"></div>
                <div class="ipa-item"><label>2.Pol</label><input type="number" id="penF2"></div>
                <div class="ipa-item"><label>3.Sobre</label><input type="number" id="penF3"></div>
                <div class="ipa-item"><label>4.Int</label><input type="number" id="penF4"></div>
                <div class="ipa-item"><label>5.Cat</label><input type="number" id="penF5"></div>
                <div class="ipa-item"><label>6.Pers</label><input type="number" id="penF6"></div>
                <div class="ipa-item"><label>7.Cont</label><input type="number" id="penF7"></div>
                <div class="ipa-item"><label>8.Just</label><input type="number" id="penF8"></div>
                <div class="ipa-item"><label>9.Emoc</label><input type="number" id="penF9"></div>
                <div class="ipa-item"><label>10.Cam</label><input type="number" id="penF10"></div>
                <div class="ipa-item"><label>11.Eti</label><input type="number" id="penF11"></div>
                <div class="ipa-item"><label>12.Cul</label><input type="number" id="penF12"></div>
                <div class="ipa-item"><label>13.Deb</label><input type="number" id="penF13"></div>
                <div class="ipa-item"><label>14.Raz</label><input type="number" id="penF14"></div>
                <div class="ipa-item"><label>15.Rec</label><input type="number" id="penF15"></div>
            </div>
        </div>

        <!-- Campos Ocultos (Resto de variables) -->
        <div style="display:none;">
            <input id="hadsA"><input id="hadsD"><input id="idareE"><input id="idareR">
            <input id="ebmaIAR"><input id="ebmaPerfil"><input id="scoreCDFR">
            <input id="f1"><input id="f2"><input id="f3"><input id="f4"> <!-- BAI Factors -->
            <input id="flagPHQ"><input id="ssiFlags"><input id="gocaNivel">
            <input id="cssrsId"><input id="cssrsPlan"><input id="cssrsCond">
        </div>

        <div style="margin-top:20px;">
            <button onclick="guardarExpediente()" class="btn-main">üíæ Guardar Cambios</button>
            <button onclick="generarPDF()" class="btn-main" style="background:#37474f; margin-top:10px;">üìÑ Generar PDF</button>
            <button onclick="limpiar()" style="background:transparent; color:#ef5350; border:none; width:100%; padding:10px; cursor:pointer; margin-top:5px;">Borrar Formulario</button>
        </div>
    </div>

    <!-- PANEL DERECHO: TABLA -->
    <div class="panel-tabla">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size:1.1rem; color:#263238;">Expedientes Activos</h2>
            <input type="text" id="search" placeholder="üîç Buscar..." style="width:200px; padding:8px;" onkeyup="renderTable()">
        </div>

        <table class="student-table">
            <thead>
                <tr>
                    <th>Estudiante</th>
                    <th>Resultados Recientes</th>
                    <th style="text-align:right;">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Se llena con JS -->
            </tbody>
        </table>
        
        <div id="empty-msg" style="text-align:center; color:#90a4ae; padding:40px; display:none;">
            No hay expedientes. Realiza un test y guarda los datos para verlos aqu√≠.
        </div>
    </div>

</div>

<script>
    const DB_KEY = "cbta_db_expedientes";
    const TEMP_KEY = "cbta_paciente_temp";
    
    // Nombres de factores IPA para el PDF
    const ipaNames = [
        "Filtraje", "Pens. Polarizado", "Sobregeneralizaci√≥n", "Int. Pensamiento", "Visi√≥n Catastr√≥fica",
        "Personalizaci√≥n", "Falacia Control", "Falacia Justicia", "Raz. Emocional", "Falacia Cambio",
        "Etiquetas Globales", "Culpabilidad", "Los Deber√≠as", "Falacia Raz√≥n", "Falacia Recompensa"
    ];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('fecha').valueAsDate = new Date();
        cargarDesdeTemp();
        renderTable();
    });

    // 1. RENDERIZAR TABLA
    function renderTable() {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const tbody = document.getElementById('tableBody');
        const filtro = document.getElementById('search').value.toLowerCase();
        const emptyMsg = document.getElementById('empty-msg');
        
        tbody.innerHTML = "";
        let visibleCount = 0;

        db.forEach(x => {
            if((x.nombre || "").toLowerCase().includes(filtro)) {
                visibleCount++;
                let badges = "";
                // Mostrar etiquetas si hay datos
                if(x.bai) badges += `<span class="badge bg-gray">BAI:${x.bai}</span>`;
                if(x.bdi) badges += `<span class="badge bg-blue">BDI:${x.bdi}</span>`;
                if(x.penTotal) badges += `<span class="badge bg-pink">IPA:${x.penTotal}</span>`;
                if(x.goca) badges += `<span class="badge bg-orange">GOCA:${x.goca}</span>`;
                if(x.ssi) badges += `<span class="badge bg-red">SSI:${x.ssi}</span>`;

                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold; color:#37474f;">${x.nombre}</div>
                        <div style="font-size:0.75rem; color:#90a4ae;">${x.grupo || 'Sin grupo'} ‚Ä¢ ${x.fechaReg || ''}</div>
                    </td>
                    <td>${badges || '-'}</td>
                    <td style="text-align:right;">
                        <button class="btn-action btn-view" onclick="cargarExpediente('${x.id_exp}')">
                            üëÅÔ∏è VER
                        </button>
                        <button class="btn-action btn-del" onclick="borrarExpediente('${x.id_exp}')">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });

        emptyMsg.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // 2. CARGAR EXPEDIENTE (Al hacer clic en VER)
    function cargarExpediente(id) {
        const db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const record = db.find(x => x.id_exp === id);
        if(record) {
            llenarFormulario(record);
            // Scroll suave hacia arriba (m√≥vil)
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function llenarFormulario(d) {
        const set = (id, val) => { 
            const el = document.getElementById(id);
            if(el) el.value = (val !== undefined && val !== null) ? val : ""; 
        };

        set('nombre', d.nombre); set('edad', d.edad); set('sexo', d.sexo); 
        set('grupo', d.grupo); set('fecha', d.fecha); set('id_exp', d.id_exp);

        // Scores B√°sicos
        set('scorePHQ', d.phq); set('flagPHQ', d.phqFlag); set('scoreGAD', d.gad);
        set('hadsA', d.hadsA); set('hadsD', d.hadsD);
        set('scoreBAI', d.bai); set('f1', d.f1); set('f2', d.f2); set('f3', d.f3); set('f4', d.f4);
        set('idareE', d.idareE); set('idareR', d.idareR);
        set('scoreBDI', d.bdi); set('scoreBHS', d.bhs);
        
        // IPA
        set('penTotal', d.penTotal);
        for(let i=1; i<=15; i++) set(`penF${i}`, d[`penF${i}`]);

        // Riesgo y Pedag√≥gico
        set('scoreSSI', d.ssi); set('ssiFlags', d.ssiFlags);
        set('scorePlut', d.plut); set('scoreGOCA', d.goca); set('gocaNivel', d.gocaNivel);
        set('scoreLIRA', d.lira); set('liraCrisis', d.liraCrisis);
        set('scoreCDFR', d.cdfr); set('cdfrCita', d.cdfrCita);
        set('ebmaIAR', d.ebmaIAR); set('ebmaPerfil', d.ebmaPerfil);
        set('cssrsId', d.cId); set('cssrsPlan', d.cPlan); set('cssrsCond', d.cCond);
    }

    function cargarDesdeTemp() {
        const raw = localStorage.getItem(TEMP_KEY);
        if(raw) {
            const d = JSON.parse(raw);
            if(confirm(`üì• Datos temporales encontrados de: ${d.nombre}\n¬øDeseas cargarlos para guardar?`)) {
                llenarFormulario(d);
            }
        }
    }

    // 3. GUARDAR
    function guardarExpediente() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Ingresa un nombre"); return; }

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let id = document.getElementById('id_exp').value;
        
        const inputs = document.querySelectorAll('input, select');
        let record = {};
        inputs.forEach(i => record[i.id] = i.value);
        record.fechaReg = new Date().toLocaleDateString();

        // L√≥gica especial para IPA (asegurar que se guarden los factores)
        record.penTotal = document.getElementById('penTotal').value;
        for(let i=1; i<=15; i++) record[`penF${i}`] = document.getElementById(`penF${i}`).value;

        if(id) {
            const index = db.findIndex(x => x.id_exp === id);
            if(index !== -1) db[index] = record;
        } else {
            record.id_exp = Date.now().toString();
            db.push(record);
            document.getElementById('id_exp').value = record.id_exp;
        }

        localStorage.setItem(DB_KEY, JSON.stringify(db));
        localStorage.removeItem(TEMP_KEY); // Limpiar temp
        renderTable();
        alert("‚úÖ Guardado correctamente.");
    }

    function borrarExpediente(id) {
        if(confirm("¬øEliminar este expediente permanentemente?")) {
            let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            db = db.filter(x => x.id_exp !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderTable();
        }
    }

    function limpiar() {
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.getElementById('fecha').valueAsDate = new Date();
    }

    // 4. GENERAR PDF (Con IPA Detallado)
    function generarPDF() {
        const val = (id) => document.getElementById(id).value;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFillColor(233, 30, 99); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("CBTa No. 130 - Informe Integral", 105, 20, null, null, "center");
        doc.setFontSize(12); doc.text("Perfil Cl√≠nico y Psicopedag√≥gico", 105, 30, null, null, "center");

        // Datos
        doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Nombre: ${val('nombre')}`, 20, 50);
        doc.text(`Edad: ${val('edad')} | Grupo: ${val('grupo')}`, 140, 50);
        doc.line(20, 55, 190, 55);

        let y = 65;
        const addRow = (t, s, i, color=false) => {
            if(y>270){doc.addPage();y=20;}
            doc.setFont("helvetica", "bold"); doc.text(t, 20, y);
            doc.setFont("helvetica", "normal"); doc.text(s ? s.toString() : "-", 80, y);
            if(color) doc.setTextColor(200,0,0);
            doc.text(i || "", 100, y);
            doc.setTextColor(0);
            doc.line(20, y+2, 190, y+2); y+=8;
        };

        // Resultados Generales
        if(val('scorePHQ')) addRow("PHQ-9 (Depresi√≥n)", val('scorePHQ'), val('scorePHQ')>=10?"ALERTA":"Bajo", val('scorePHQ')>=10);
        if(val('scoreGAD')) addRow("GAD-7 (Ansiedad)", val('scoreGAD'), val('scoreGAD')>=10?"ALERTA":"Bajo", val('scoreGAD')>=10);
        if(val('scoreBAI')) addRow("BAI (Ansiedad)", val('scoreBAI'), val('scoreBAI')>15?"Significativo":"Bajo", val('scoreBAI')>15);
        if(val('scoreBDI')) addRow("BDI-II (Depresi√≥n)", val('scoreBDI'), val('scoreBDI')>18?"Significativo":"Bajo", val('scoreBDI')>18);
        if(val('scoreSSI')) addRow("SSI (Riesgo)", val('scoreSSI'), val('scoreSSI')>5?"RIESGO":"Bajo", true);

        // SECCI√ìN IPA (TABLA DETALLADA)
        if(val('penTotal')) {
            y+=5;
            doc.setFillColor(252, 228, 236); doc.rect(20, y-5, 170, 8, 'F'); // Fondo rosa suave
            doc.setFont("helvetica", "bold"); doc.setTextColor(136, 14, 79);
            doc.text(`INVENTARIO DE PENSAMIENTOS (IPA) - Total: ${val('penTotal')}`, 25, y);
            y+=10; doc.setTextColor(0); doc.setFontSize(9);

            // Tabla 3 columnas
            let xCol = 20;
            for(let i=0; i<15; i++) {
                let score = val(`penF${i+1}`);
                if(score) {
                    let nivel = score<=3 ? "Bajo" : score<=6 ? "Medio" : "ALTO";
                    if(nivel === "ALTO") doc.setTextColor(198, 40, 40); // Rojo para altos
                    doc.text(`${ipaNames[i]}: ${score} (${nivel})`, xCol, y);
                    doc.setTextColor(0);
                    
                    y+=6;
                    if((i+1)%5 === 0) { // Salto columna cada 5 items
                        y -= 30; 
                        xCol += 60;
                    }
                }
            }
            y += 35; // Espacio despu√©s de la tabla IPA
            doc.setFontSize(10);
        }

        // Otros
        if(val('scoreGOCA')) addRow("GOCA (Aula)", val('scoreGOCA'), val('scoreGOCA')>80?"Alerta":"Bajo");
        if(val('scoreLIRA')) addRow("LIRA (Acad√©mico)", val('scoreLIRA'), val('scoreLIRA')>=5?"REFERIR":"-");

        y+=10;
        doc.rect(20, y, 170, 30);
        doc.text("Observaciones:", 22, y+5);

        doc.save(`Expediente_${val('nombre')}.pdf`);
    }
</script>
</body>
</html>


