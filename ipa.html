<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluaci√≥n IPA - CBTa 130</title>
<style>
    body { font-family: "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; color: #1c1c1e; margin: 0; }
    /* Encabezado FUCSIA */
    header { background: linear-gradient(135deg, #c2185b 0%, #880e4f 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #ad1457; text-align: center; margin-top: 0; border-bottom: 2px solid #f8bbd0; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }
    input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    /* Tabla Fija */
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; min-width: 800px; table-layout: fixed; }
    
    th, td { padding: 8px 5px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
    th:first-child, td:first-child { width: 50%; text-align: left; padding-left: 10px; font-weight: 500; white-space: normal; }
    th:not(:first-child), td:not(:first-child) { width: 12.5%; }
    
    th { background-color: #fce4ec; color: #880e4f; font-weight: bold; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    input[type="radio"] { width: 20px; height: 20px; margin: 0 auto; display: block; cursor: pointer; accent-color: #c2185b; }

    .results-panel { background: #fce4ec; padding: 20px; border-radius: 10px; margin-top: 30px; display: none; border: 1px solid #880e4f; }
    
    /* Grilla de Resultados de Factores */
    .factors-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-bottom: 15px; }
    .factor-item { background: white; padding: 10px; border-radius: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; border-left: 4px solid #ccc; }
    .level-bajo { border-left-color: #2e7d32; color: #2e7d32; }
    .level-medio { border-left-color: #f57f17; color: #f57f17; }
    .level-alto { border-left-color: #c62828; color: #c62828; font-weight: bold; }

    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .btn-back { background-color: #78909c; }
    .reset { background-color: #757575; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Inventario de Pensamientos (IPA)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos del Estudiante</h2>
        <div class="input-group"><label>Nombre:</label><input type="text" id="nombre"></div>
        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha"></div>

        <div style="background:#fce4ec; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #c2185b;">
            <strong>Instrucciones:</strong> Valore la frecuencia con que suele tener estos pensamientos (0=Nunca, 3=Con mucha frecuencia).
        </div>

        <form id="ipaForm">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Pensamiento</th>
                            <th>0<br>Nunca</th>
                            <th>1<br>A veces</th>
                            <th>2<br>Bastantes</th>
                            <th>3<br>Frecuente</th>
                        </tr>
                    </thead>
                    <tbody id="questions-body"></tbody>
                </table>
            </div>
        </form>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="calcularIPA()">üß† Calcular Distorsiones</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar</button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="results-area" class="results-panel">
        <h3 style="color:#880e4f; text-align:center; margin-top:0;">Perfil Cognitivo (IPA)</h3>
        
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:1.2em;">Puntuaci√≥n Global:</span>
            <span id="total-score" style="font-size:1.5em; font-weight:bold;"></span>
            <br>
            <span id="total-level" style="font-weight:bold; padding:3px 10px; border-radius:10px; color:white;"></span>
        </div>

        <h4 style="margin:0 0 10px 0; color:#c2185b;">Desglose de Distorsiones:</h4>
        <div id="factors-container" class="factors-grid"></div>

        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar Resumen</button>
            <button type="button" class="reset" onclick="location.reload()">üîÑ Nueva Evaluaci√≥n</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Ir al Men√∫</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    const items = [
        "1. No puedo soportar ciertas cosas que me pasan.",
        "2. Solamente me pasan cosas malas.",
        "3. Todo lo que hago me sale mal.",
        "4. S√© que piensan mal de m√≠.",
        "5. ¬øY si tengo alguna enfermedad grave?.",
        "6. Soy inferior a la gente en casi todo.",
        "7. Si otros cambiaran su actitud yo me sentir√≠a mejor.",
        "8. ¬°No hay derecho a que me traten as√≠!.",
        "9. Si me siento triste es porque soy un enfermo mental.",
        "10. Mis problemas dependen de los que me rodean.",
        "11. Soy un desastre como persona.",
        "12. Yo tengo la culpa de todo lo que me pasa.",
        "13. Deber√≠a de estar bien y no tener estos problemas.",
        "14. S√© que tengo la raz√≥n y no me entienden.",
        "15. Aunque ahora sufra, alg√∫n d√≠a tendr√© mi recompensa.",
        "16. Es horrible que me pase esto.",
        "17. Mi vida es un continuo fracaso.",
        "18. Siempre tendr√© este problema.",
        "19. S√© que me est√°n mintiendo y enga√±ando.",
        "20. ¬øY si me vuelvo loco y pierdo la cabeza?.",
        "21. Soy superior a la gente en casi todo.",
        "22. Yo soy responsable del sufrimiento de los que me rodean.",
        "23. Si me quisieran de verdad no me tratar√≠an as√≠.",
        "24. Me siento culpable, y es porque he hecho algo malo.",
        "25. Si tuviera m√°s apoyo no tendr√≠a estos problemas.",
        "26. Alguien que conozco es un imb√©cil.",
        "27. Otros tienen la culpa de lo que me pasa.",
        "28. No deber√≠a de cometer estos errores.",
        "29. No quiere reconocer que estoy en lo cierto.",
        "30. Ya vendr√°n mejores tiempos.",
        "31. Es insoportable, no puedo aguantar m√°s.",
        "32. Soy incompetente e in√∫til.",
        "33. Nunca podr√© salir de esta situaci√≥n.",
        "34. Quieren hacerme da√±o.",
        "35. ¬øY si les pasa algo malo a las personas a quienes quiero?.",
        "36. La gente hace las cosas mejor que yo.",
        "37. Soy una v√≠ctima de mis circunstancias.",
        "38. No me tratan como deber√≠an hacerlo y me merezco.",
        "39. Si tengo estos s√≠ntomas es porque soy un enfermo.",
        "40. Si tuviera mejor situaci√≥n econ√≥mica no tendr√≠a estos problemas.",
        "41. Soy un neur√≥tico.",
        "42. Lo que me pasa es un castigo que merezco.",
        "43. Deber√≠a recibir m√°s atenci√≥n y cari√±o de otros.",
        "44. Tengo raz√≥n, y voy a hacer lo que me da la gana.",
        "45. Tarde o temprano me ir√°n las cosas mejor."
    ];

    const factoresNombres = [
        "Filtraje", "Pensamiento Polarizado", "Sobregeneralizaci√≥n", "Interpretaci√≥n Pensamiento",
        "Visi√≥n Catastr√≥fica", "Personalizaci√≥n", "Falacia de Control", "Falacia de Justicia",
        "Razonamiento Emocional", "Falacia de Cambio", "Etiquetas Globales", "Culpabilidad",
        "Los Deber√≠as", "Falacia de Raz√≥n", "Falacia Recompensa Divina"
    ];

    // Renderizar Tabla
    const tbody = document.getElementById('questions-body');
    items.forEach((txt, idx) => {
        let id = idx + 1;
        let html = `<tr>
            <td>${txt}</td>
            ${[0,1,2,3].map(v => `<td><input type="radio" name="i${id}" value="${v}"></td>`).join('')}
        </tr>`;
        tbody.innerHTML += html;
    });

    let resultados = null;

    function calcularIPA() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Nombre requerido"); return; }

        let total = 0;
        let factorScores = new Array(15).fill(0);
        let count = 0;

        // Calcular Factores: Factor K usa items K, K+15, K+30
        // En c√≥digo (base 0): factorIndex usa itemIndex, itemIndex+15, itemIndex+30
        
        // Primero leemos todos los valores
        let itemValues = [];
        for(let i=1; i<=45; i++) {
            const el = document.querySelector(`input[name="i${i}"]:checked`);
            if(el) {
                itemValues[i] = parseInt(el.value);
                count++;
                total += parseInt(el.value);
            }
        }

        if(count < 45) { alert(`Faltan preguntas (${count}/45)`); return; }

        // Sumar Factores
        for(let f=0; f<15; f++) {
            // Item ids (base 1): f+1, f+16, f+31
            let v1 = itemValues[f+1];
            let v2 = itemValues[f+16];
            let v3 = itemValues[f+31];
            factorScores[f] = v1 + v2 + v3;
        }

        // Interpretar
        let nivelTotal = total <= 45 ? "BAJO" : total <= 90 ? "MEDIO" : "ALTO";
        let factorDetails = factorScores.map((score, idx) => {
            let nivel = score <= 3 ? "Bajo" : score <= 6 ? "Medio" : "Alto";
            return { name: factoresNombres[idx], score, nivel };
        });

        resultados = { nombre, total, nivelTotal, factorDetails };
        mostrarResultados();
    }

    function mostrarResultados() {
        document.getElementById('test-form').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        
        // Global
        const totEl = document.getElementById('total-level');
        document.getElementById('total-score').innerText = resultados.total;
        totEl.innerText = resultados.nivelTotal;
        totEl.style.backgroundColor = resultados.nivelTotal === "BAJO" ? "#2e7d32" : resultados.nivelTotal === "MEDIO" ? "#f57f17" : "#c62828";

        // Factores
        const grid = document.getElementById('factors-container');
        grid.innerHTML = "";
        resultados.factorDetails.forEach((f, i) => {
            // Mostrar solo si es Medio o Alto para no saturar, o todos con estilo?
            // Mostremos todos ordenados.
            let cls = f.nivel === "Bajo" ? "level-bajo" : f.nivel === "Medio" ? "level-medio" : "level-alto";
            grid.innerHTML += `
                <div class="factor-item ${cls}">
                    <span>${i+1}. ${f.name}</span>
                    <span>${f.score} (${f.nivel})</span>
                </div>
            `;
        });
        window.scrollTo(0,0);
    }

    function guardarLocalmente() {
        if(!resultados) return;
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        
        // Guardar los 15 puntajes individuales
        let factorObj = {};
        resultados.factorDetails.forEach((f, i) => {
            factorObj[`ipaF${i+1}`] = f.score;
        });

        let up = { 
            ...cur, 
            nombre: resultados.nombre,
            ipaTotal: resultados.total,
            ...factorObj
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up));
        alert("‚úÖ IPA guardado en expediente.");
    }

    function enviarWhatsApp() {
        if(!resultados) return;
        // Filtrar los altos para el resumen
        let altos = resultados.factorDetails.filter(f => f.nivel === "Alto").map(f => f.name);
        let m = `üß† *IPA REPORT*%0Aüë§ ${resultados.nombre}%0Aüìä Total: ${resultados.total} (${resultados.nivelTotal})`;
        if(altos.length > 0) m += `%0A‚ö†Ô∏è Distorsiones Altas: ${altos.join(', ')}`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank');
    }
</script>
</body>
</html>

