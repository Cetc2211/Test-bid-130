<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluaci√≥n EBMA - CBTa 130</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; color: #1c1c1e; margin: 0; }
    header { background: linear-gradient(135deg, #00897b 0%, #004d40 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #00695c; text-align: center; margin-top: 0; border-bottom: 2px solid #b2dfdb; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }
    input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    .section-title { 
        background: #e0f2f1; color: #00695c; padding: 10px; font-weight: bold; 
        margin-top: 30px; border-left: 5px solid #00897b; border-radius: 4px;
    }
    
    /* TABLA MEJORADA PARA TEXTO LARGO */
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 10px; 
        font-size: 0.85rem; 
        min-width: 900px; /* M√°s ancho para que quepa el texto */
        table-layout: fixed; 
    }
    
    th, td { padding: 10px 5px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
    
    /* Columna Pregunta m√°s ancha (50%) para texto completo */
    th:first-child, td:first-child { 
        width: 50%; 
        text-align: left; 
        padding-left: 10px; 
        font-weight: 500; 
        white-space: normal; /* Permite saltos de l√≠nea */
        line-height: 1.3;
    }
    
    /* Columnas de opciones (10% cada una) */
    th:not(:first-child), td:not(:first-child) { width: 10%; }
    
    th { background-color: #e0f2f1; color: #00695c; font-weight: bold; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    input[type="radio"] { width: 20px; height: 20px; margin: 0 auto; display: block; cursor: pointer; accent-color: #00897b; }

    .results-panel { background: #e0f2f1; padding: 20px; border-radius: 10px; margin-top: 30px; display: none; border: 1px solid #004d40; }
    .score-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; }
    
    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .btn-pdf { background-color: #00897b; }
    .btn-back { background-color: #78909c; }
    .reset { background-color: #757575; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Escala de Motivaci√≥n (EBMA)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos del Estudiante</h2>
        <div class="input-group"><label>Nombre:</label><input type="text" id="nombre"></div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Grupo:</label><input type="text" id="grupo"></div>
            <div style="flex:1"><label>Semestre:</label><input type="text" id="semestre"></div>
        </div>
        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha"></div>

        <div style="background:#e0f2f1; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #004d40;">
            <strong>Instrucciones:</strong> Lee cada afirmaci√≥n y marca qu√© tan de acuerdo est√°s con ella. No hay respuestas correctas o incorrectas.
        </div>

        <form id="ebmaForm">
            <div id="sections-container"></div>
        </form>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="calcularEBMA()">üìä Calcular Perfil Motivacional</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar y Volver</button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="results-area" class="results-panel">
        <h3 style="color:#004d40; text-align:center;">Perfil Motivacional</h3>
        
        <div id="score-details" style="margin-bottom:15px;"></div>
        
        <div style="background:white; padding:15px; border-radius:8px; text-align:center; border:2px solid #00897b;">
            <div style="font-size:0.9rem; color:#666;">√çNDICE DE AUTODETERMINACI√ìN (IAR)</div>
            <div id="iar-score" style="font-size:1.8em; font-weight:bold; color:#004d40;"></div>
            <div id="iar-interp" style="font-weight:bold; margin-top:5px;"></div>
        </div>

        <div id="profile-desc" style="margin-top:15px; font-weight:bold; color:#d81b60; text-align:center;"></div>
        <div id="intervention-rec" style="margin-top:10px; font-size:0.9rem; font-style:italic; text-align:center;"></div>

        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="btn-pdf" onclick="generarPDFEBMA()">üìÑ Generar Reporte PDF</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar Resumen WhatsApp</button>
            <button type="button" class="reset" onclick="location.reload()">üîÑ Nueva Evaluaci√≥n</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Ir al Men√∫</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    // TEXTOS COMPLETOS Y PRECISOS
    const secciones = [
        { 
            id: 'A', title: 'A. MOTIVACI√ìN INTR√çNSECA', 
            items: [
                "1. Disfruto mucho aprendiendo cosas nuevas",
                "2. Me da satisfacci√≥n personal superar retos acad√©micos dif√≠ciles",
                "3. Me gusta lo que estudio, especialmente las materias de mi especialidad",
                "4. Siento curiosidad por conocer m√°s sobre los temas que vemos",
                "5. Me emociona descubrir cosas que no sab√≠a"
            ]
        },
        { 
            id: 'B', title: 'B. REGULACI√ìN IDENTIFICADA', 
            items: [
                "6. S√© que es importante para mi futuro profesional",
                "7. Me ayudar√° a conseguir el trabajo que quiero",
                "8. Quiero ser alguien preparado y con conocimientos",
                "9. Es el camino para lograr mis metas personales",
                "10. Me permitir√° ayudar mejor a mi familia y comunidad"
            ]
        },
        { 
            id: 'C', title: 'C. REGULACI√ìN INTROYECTADA', 
            items: [
                "11. Me sentir√≠a mal conmigo mismo si no lo hago",
                "12. No quiero decepcionar a mi familia",
                "13. Es lo que se espera de alguien de mi edad",
                "14. Me sentir√≠a culpable si desperdicio esta oportunidad",
                "15. Quiero que mis padres se sientan orgullosos de m√≠"
            ]
        },
        { 
            id: 'D', title: 'D. REGULACI√ìN EXTERNA', 
            items: [
                "16. Mis padres me obligan a venir",
                "17. Es obligatorio hasta los 18 a√±os",
                "18. Para evitar problemas o castigos en casa",
                "19. No tengo otra opci√≥n",
                "20. Me quitan privilegios si no vengo"
            ]
        },
        { 
            id: 'E', title: 'E. DESMOTIVACI√ìN', 
            items: [
                "21. Honestamente, no s√© para qu√© vengo",
                "22. Siento que pierdo el tiempo aqu√≠",
                "23. No le veo sentido a seguir estudiando",
                "24. Creo que la escuela no me sirve para nada",
                "25. Ya no me importa si termino o no"
            ]
        }
    ];

    const container = document.getElementById('sections-container');
    secciones.forEach(sec => {
        let html = `<div class="section-title">${sec.title}</div>
        <div class="table-container"><table><thead>
            <tr>
                <th>Afirmaci√≥n</th>
                <th>1<br>T.Desacuerdo</th>
                <th>2<br>Desacuerdo</th>
                <th>3<br>Neutral</th>
                <th>4<br>De acuerdo</th>
                <th>5<br>T.De acuerdo</th>
            </tr>
        </thead><tbody>`;
        
        sec.items.forEach(txt => {
            let id = parseInt(txt.split('.')[0]); 
            html += `<tr>
                <td>${txt}</td>
                ${[1,2,3,4,5].map(v => `<td><input type="radio" name="m${id}" value="${v}"></td>`).join('')}
            </tr>`;
        });
        html += `</tbody></table></div>`;
        container.innerHTML += html;
    });

    let resultados = null;

    function calcularEBMA() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Nombre requerido"); return; }

        let sums = { A:0, B:0, C:0, D:0, E:0 };
        let avgs = { A:0, B:0, C:0, D:0, E:0 };
        let count = 0;

        for(let i=1; i<=25; i++) {
            const el = document.querySelector(`input[name="m${i}"]:checked`);
            if(el) {
                let val = parseInt(el.value);
                if(i<=5) sums.A += val;
                else if(i<=10) sums.B += val;
                else if(i<=15) sums.C += val;
                else if(i<=20) sums.D += val;
                else sums.E += val;
                count++;
            }
        }

        if(count < 25) { alert(`Faltan preguntas (${count}/25)`); return; }

        // Promedios
        for(let k in sums) avgs[k] = sums[k] / 5;

        // IAR Calculation: (2*MI) + (1*RI) - (1*RIn) - (2*RE)
        // A=MI, B=RI, C=RIn, D=RE
        let iar = (2 * avgs.A) + (1 * avgs.B) - (1 * avgs.C) - (2 * avgs.D);
        iar = parseFloat(iar.toFixed(2));

        // Interpretaci√≥n IAR
        let iarInterp = "";
        if(iar > 10) iarInterp = "ALTAMENTE AUTODETERMINADO";
        else if(iar >= 5) iarInterp = "MODERADAMENTE AUTODETERMINADO";
        else if(iar >= 0) iarInterp = "MOTIVACI√ìN MIXTA";
        else if(iar >= -5) iarInterp = "MODERADAMENTE CONTROLADO";
        else iarInterp = "ALTAMENTE CONTROLADO (Riesgo Abandono)";

        // Perfil
        let perfil = "No definido";
        let interv = "Evaluaci√≥n general";
        
        if(avgs.A >= 4 && avgs.B >= 3.5 && avgs.D < 2.5 && avgs.E < 2) {
            perfil = "1. INTR√çNSECAMENTE MOTIVADO"; interv = "Mantener y potenciar";
        } else if(avgs.A < 3 && avgs.B >= 4 && avgs.D < 3 && avgs.E < 2) {
            perfil = "2. MOTIVADO POR METAS"; interv = "Conectar con futuro profesional";
        } else if(avgs.A < 3 && avgs.B < 3 && avgs.C >= 4 && avgs.D < 3) {
            perfil = "3. PRESI√ìN SOCIAL/CULPA"; interv = "Desarrollar autonom√≠a";
        } else if(avgs.A < 2.5 && avgs.B < 3 && avgs.D >= 4) {
            perfil = "4. EXTERNAMENTE CONTROLADO"; interv = "Trabajo en sentido";
        } else if(avgs.E >= 3.5) {
            perfil = "5. DESMOTIVADO (RIESGO)"; interv = "Intervenci√≥n Intensiva";
        } else {
            perfil = "Perfil Mixto / No Espec√≠fico";
        }

        resultados = { nombre, avgs, iar, iarInterp, perfil, interv };
        
        // Mostrar
        document.getElementById('test-form').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        
        let html = "";
        html += `<div class="score-row"><span>Intr√≠nseca (A):</span> <b>${avgs.A.toFixed(1)}</b></div>`;
        html += `<div class="score-row"><span>Identificada (B):</span> <b>${avgs.B.toFixed(1)}</b></div>`;
        html += `<div class="score-row"><span>Introyectada (C):</span> <b>${avgs.C.toFixed(1)}</b></div>`;
        html += `<div class="score-row"><span>Externa (D):</span> <b>${avgs.D.toFixed(1)}</b></div>`;
        html += `<div class="score-row" style="color:#c62828;"><span>Desmotivaci√≥n (E):</span> <b>${avgs.E.toFixed(1)}</b></div>`;
        
        document.getElementById('score-details').innerHTML = html;
        document.getElementById('iar-score').innerText = iar;
        document.getElementById('iar-interp').innerText = iarInterp;
        document.getElementById('profile-desc').innerText = perfil;
        document.getElementById('intervention-rec').innerText = `Recomendaci√≥n: ${interv}`;
        
        window.scrollTo(0,0);
    }

    function guardarLocalmente() {
        if(!resultados) return;
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let up = { 
            ...cur, 
            nombre: resultados.nombre,
            grupo: document.getElementById('grupo').value,
            ebmaIAR: resultados.iar,
            ebmaPerfil: resultados.perfil,
            ebmaDesmot: resultados.avgs.E
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up));
        alert("‚úÖ EBMA guardado en expediente.");
    }

    function generarPDFEBMA() {
        if(!resultados) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        doc.setFillColor(0, 77, 64); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("CBTa No. 130", 105, 20, null, null, "center");
        doc.setFontSize(14);
        doc.text("ESCALA DE MOTIVACI√ìN ACAD√âMICA (EBMA)", 105, 30, null, null, "center");
        
        doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Estudiante: ${resultados.nombre}`, 20, 50);
        doc.text(`Fecha: ${document.getElementById('fecha').value}`, 140, 50);
        doc.line(20, 55, 190, 55);

        y = 70;
        doc.setFont("helvetica", "bold"); doc.text("RESULTADOS POR DIMENSI√ìN (1-5)", 20, y); y+=10;
        
        const row = (lbl, val) => {
            doc.setFont("helvetica", "normal"); doc.text(lbl, 25, y);
            doc.setFont("helvetica", "bold"); doc.text(val.toFixed(1), 150, y);
            y+=8;
        };

        row("A. Motivaci√≥n Intr√≠nseca (Gusto)", resultados.avgs.A);
        row("B. Regulaci√≥n Identificada (Metas)", resultados.avgs.B);
        row("C. Regulaci√≥n Introyectada (Culpa)", resultados.avgs.C);
        row("D. Regulaci√≥n Externa (Obligaci√≥n)", resultados.avgs.D);
        doc.setTextColor(198, 40, 40);
        row("E. Desmotivaci√≥n (Riesgo)", resultados.avgs.E);
        doc.setTextColor(0);

        y+=10;
        doc.setFillColor(224, 242, 241); doc.rect(20, y, 170, 25, 'F');
        doc.setTextColor(0, 77, 64);
        doc.text(`√çNDICE DE AUTODETERMINACI√ìN (IAR): ${resultados.iar}`, 25, y+10);
        doc.setFont("helvetica", "normal");
        doc.text(`Interpretaci√≥n: ${resultados.iarInterp}`, 25, y+18);

        y+=35;
        doc.setTextColor(0);
        doc.setFont("helvetica", "bold"); doc.text("PERFIL IDENTIFICADO:", 20, y);
        doc.setFont("helvetica", "normal"); doc.text(resultados.perfil, 70, y);
        y+=10;
        doc.setFont("helvetica", "bold"); doc.text("INTERVENCI√ìN SUGERIDA:", 20, y);
        doc.setFont("helvetica", "normal"); doc.text(resultados.interv, 80, y);

        y+=30;
        doc.line(70, y, 140, y);
        doc.text("Firma del Evaluador", 105, y+5, null, null, "center");

        doc.save(`EBMA_${resultados.nombre}.pdf`);
    }

    function enviarWhatsApp() {
        if(!resultados) return;
        let m = `üéì *EBMA*%0Aüë§ ${resultados.nombre}%0Aüìä IAR: ${resultados.iar} (${resultados.iarInterp})%0Aüè∑Ô∏è Perfil: ${resultados.perfil}`;
        if(resultados.avgs.E >= 3.5) m += `%0A‚ö†Ô∏è ALTA DESMOTIVACI√ìN`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank');
    }
</script>
</body>
</html>


