<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluaci√≥n EBMA - CBTa 130</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; color: #1c1c1e; margin: 0; }
    header { background: linear-gradient(135deg, #00897b 0%, #004d40 100%); color: white; text-align: center; padding: 25px; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { color: #00695c; text-align: center; margin-top: 0; border-bottom: 2px solid #b2dfdb; padding-bottom: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: #333; }
    input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    .section-title { 
        background: #e0f2f1; color: #00695c; padding: 10px; font-weight: bold; 
        margin-top: 30px; border-left: 5px solid #00897b; border-radius: 4px;
    }
    
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 10px; 
        font-size: 0.85rem; 
        min-width: 900px; 
        table-layout: fixed; 
    }
    
    th, td { padding: 10px 5px; border-bottom: 1px solid #eee; vertical-align: middle; text-align: center; }
    th:first-child, td:first-child { width: 50%; text-align: left; padding-left: 10px; font-weight: 500; white-space: normal; line-height: 1.3; }
    th:not(:first-child), td:not(:first-child) { width: 10%; }
    
    th { background-color: #e0f2f1; color: #00695c; font-weight: bold; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    input[type="radio"] { width: 20px; height: 20px; margin: 0 auto; display: block; cursor: pointer; accent-color: #00897b; }

    .results-panel { background: #e0f2f1; padding: 25px; border-radius: 10px; margin-top: 30px; display: none; border: 1px solid #004d40; }
    
    .score-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #00897b; }
    .score-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; }
    .interpretation-box { background: #fffde7; padding: 15px; border-radius: 8px; border: 1px solid #fbc02d; margin-top: 15px; }
    .rec-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #1976d2; }

    .buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { padding: 16px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; color: white; cursor: pointer; width: 100%; }
    .whatsapp { background-color: #25D366; }
    .local-save { background-color: #1565C0; }
    .btn-pdf { background-color: #00897b; }
    .btn-back { background-color: #78909c; }
    .reset { background-color: #757575; }
</style>
</head>
<body>
<header>CBTa No.130<br><span style="font-size:0.8em; font-weight:normal">Escala de Motivaci√≥n (EBMA)</span></header>

<div class="container">
    <div id="test-form">
        <h2>Datos del Estudiante</h2>
        
        <!-- BLOQUE DE IDENTIFICACI√ìN COMPLETO -->
        <div class="input-group"><label>Nombre Completo:</label><input type="text" id="nombre"></div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Edad:</label><input type="number" id="edad"></div>
            <div style="flex:1">
                <label>Sexo:</label>
                <select id="sexo">
                    <option value="">-- Seleccione --</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                </select>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <div style="flex:1"><label>Semestre:</label><input type="number" id="semestre" placeholder="Ej: 2"></div>
            <div style="flex:1"><label>Grupo:</label><input type="text" id="grupo" placeholder="Ej: A"></div>
        </div>

        <div class="input-group" style="margin-top:10px;">
            <label>Especialidad:</label>
            <input type="text" id="especialidad" placeholder="Ej: Agropecuario, Administraci√≥n...">
        </div>

        <div class="input-group"><label>Fecha:</label><input type="date" id="fecha"></div>

        <div style="background:#e0f2f1; padding:15px; border-radius:8px; margin:20px 0; font-size:0.9em; border-left:5px solid #004d40;">
            <strong>Instrucciones:</strong> Marca qu√© tan de acuerdo est√°s con cada afirmaci√≥n (1=Totalmente en desacuerdo, 5=Totalmente de acuerdo).
        </div>

        <form id="ebmaForm">
            <div id="sections-container"></div>
        </form>

        <div class="buttons">
            <button type="button" class="whatsapp" onclick="calcularEBMA()">üìä Calcular Diagn√≥stico Motivacional</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Cancelar y Volver</button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="results-area" class="results-panel">
        <h3 style="color:#004d40; text-align:center; margin-top:0;">Diagn√≥stico EBMA</h3>
        
        <div class="score-card">
            <h4 style="margin:0 0 10px 0; color:#00695c;">Puntuaciones por Dimensi√≥n</h4>
            <div id="score-details"></div>
        </div>

        <div class="score-card" style="text-align:center; background:#f1f8e9; border-left-color:#33691e;">
            <div style="font-size:0.9rem; color:#558b2f; font-weight:bold;">√çNDICE DE AUTODETERMINACI√ìN (IAR)</div>
            <div id="iar-score" style="font-size:2em; font-weight:bold; color:#33691e;"></div>
            <div id="iar-interp" style="font-weight:bold; color:#558b2f;"></div>
            <div id="iar-desc" style="font-size:0.85rem; margin-top:5px; font-style:italic;"></div>
        </div>

        <div class="interpretation-box">
            <h4 style="margin:0 0 5px 0; color:#f57f17;">Perfil Motivacional</h4>
            <div id="profile-title" style="font-weight:bold; font-size:1.1em; color:#e65100;"></div>
            <div id="profile-desc" style="font-size:0.9rem; margin-top:5px;"></div>
            <div id="alerts-container" style="display:none; margin-top:15px; border-top:1px dashed #f9a825; padding-top:10px;">
                <span style="font-weight:bold; color:#c62828;">SE√ëALES DE ALERTA:</span>
                <ul id="alert-list" style="color:#c62828; margin:5px 0; padding-left:20px;"></ul>
            </div>
        </div>

        <div class="rec-box">
            <h4 style="margin:0 0 10px 0; color:#0d47a1;">Plan de Intervenci√≥n</h4>
            <div id="interv-main" style="font-weight:bold; color:#1565C0;"></div>
            <ul id="interv-list" style="margin:10px 0; padding-left:20px; font-size:0.9rem;"></ul>
            <div style="margin-top:15px; border-top:1px solid #90caf9; padding-top:10px;">
                <strong>Seguimiento:</strong> <span id="follow-up"></span>
            </div>
        </div>

        <div class="buttons">
            <button type="button" class="local-save" onclick="guardarLocalmente()">üíæ Guardar en Expediente</button>
            <button type="button" class="btn-pdf" onclick="generarPDFEBMA()">üìÑ Generar Reporte PDF</button>
            <button type="button" class="whatsapp" onclick="enviarWhatsApp()">üì≤ Enviar Resumen</button>
            <button type="button" class="reset" onclick="location.reload()">üîÑ Nueva Evaluaci√≥n</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">üè† Ir al Men√∫</button>
        </div>
    </div>
</div>

<script>
    const NUMERO_DESTINO = "523111477413"; 
    const STORAGE_KEY = "cbta_paciente_temp";
    document.getElementById('fecha').valueAsDate = new Date();

    const secciones = [
        { id: 'A', title: 'A. MOTIVACI√ìN INTR√çNSECA', items: ["1. Disfruto mucho aprendiendo cosas nuevas", "2. Me da satisfacci√≥n personal superar retos acad√©micos dif√≠ciles", "3. Me gusta lo que estudio, especialmente las materias de mi especialidad", "4. Siento curiosidad por conocer m√°s sobre los temas que vemos", "5. Me emociona descubrir cosas que no sab√≠a"] },
        { id: 'B', title: 'B. REGULACI√ìN IDENTIFICADA', items: ["6. S√© que es importante para mi futuro profesional", "7. Me ayudar√° a conseguir el trabajo que quiero", "8. Quiero ser alguien preparado y con conocimientos", "9. Es el camino para lograr mis metas personales", "10. Me permitir√° ayudar mejor a mi familia y comunidad"] },
        { id: 'C', title: 'C. REGULACI√ìN INTROYECTADA', items: ["11. Me sentir√≠a mal conmigo mismo si no lo hago", "12. No quiero decepcionar a mi familia", "13. Es lo que se espera de alguien de mi edad", "14. Me sentir√≠a culpable si desperdicio esta oportunidad", "15. Quiero que mis padres se sientan orgullosos de m√≠"] },
        { id: 'D', title: 'D. REGULACI√ìN EXTERNA', items: ["16. Mis padres me obligan a venir", "17. Es obligatorio hasta los 18 a√±os", "18. Para evitar problemas o castigos en casa", "19. No tengo otra opci√≥n", "20. Me quitan privilegios si no vengo"] },
        { id: 'E', title: 'E. DESMOTIVACI√ìN', items: ["21. Honestamente, no s√© para qu√© vengo", "22. Siento que pierdo el tiempo aqu√≠", "23. No le veo sentido a seguir estudiando", "24. Creo que la escuela no me sirve para nada", "25. Ya no me importa si termino o no"] }
    ];

    const container = document.getElementById('sections-container');
    secciones.forEach(sec => {
        let html = `<div class="section-title">${sec.title}</div>
        <div class="table-container"><table><thead><tr><th>Afirmaci√≥n</th><th>1<br>T.Des</th><th>2<br>Des</th><th>3<br>Neu</th><th>4<br>Acu</th><th>5<br>T.Acu</th></tr></thead><tbody>`;
        sec.items.forEach(txt => {
            let id = parseInt(txt.split('.')[0]); 
            html += `<tr><td>${txt}</td>${[1,2,3,4,5].map(v => `<td><input type="radio" name="m${id}" value="${v}"></td>`).join('')}</tr>`;
        });
        html += `</tbody></table></div>`;
        container.innerHTML += html;
    });

    let resultados = null;

    function calcularEBMA() {
        const nombre = document.getElementById('nombre').value;
        if(!nombre) { alert("Nombre requerido"); return; }

        let sums = { A:0, B:0, C:0, D:0, E:0 };
        let avgs = { A:0, B:0, C:0, D:0, E:0 };
        let count = 0;

        for(let i=1; i<=25; i++) {
            const el = document.querySelector(`input[name="m${i}"]:checked`);
            if(el) {
                let val = parseInt(el.value);
                if(i<=5) sums.A += val; else if(i<=10) sums.B += val; else if(i<=15) sums.C += val; else if(i<=20) sums.D += val; else sums.E += val;
                count++;
            }
        }

        if(count < 25) { alert(`Faltan preguntas (${count}/25)`); return; }
        for(let k in sums) avgs[k] = sums[k] / 5;

        let iar = (2 * avgs.A) + (1 * avgs.B) - (1 * avgs.C) - (2 * avgs.D);
        iar = parseFloat(iar.toFixed(2));

        let iarData = getIARInterpretation(iar);
        let profileData = getProfile(avgs);
        let alerts = getAlerts(avgs, iar);
        let interv = getInterventions(profileData.id);

        resultados = { 
            nombre, 
            edad: document.getElementById('edad').value,
            sexo: document.getElementById('sexo').value,
            semestre: document.getElementById('semestre').value,
            grupo: document.getElementById('grupo').value,
            especialidad: document.getElementById('especialidad').value,
            avgs, iar, iarData, profileData, alerts, interv 
        };
        
        mostrarResultados();
    }

    function getIARInterpretation(iar) {
        if(iar > 10) return { title: "ALTAMENTE AUTODETERMINADO", desc: "Motivaci√≥n intr√≠nseca. Pron√≥stico favorable." };
        if(iar >= 5) return { title: "MODERADAMENTE AUTODETERMINADO", desc: "Balance positivo. Metas futuras." };
        if(iar >= 0) return { title: "MOTIVACI√ìN MIXTA", desc: "Equilibrio aut√≥noma/controlada." };
        if(iar >= -5) return { title: "MODERADAMENTE CONTROLADO", desc: "Presi√≥n externa. Riesgo moderado." };
        return { title: "ALTAMENTE CONTROLADO", desc: "Motivaci√≥n externa/ausente. Alto riesgo." };
    }

    function getProfile(a) {
        if(a.A >= 4 && a.B >= 3.5 && a.D < 2.5 && a.E < 2) return { id: 1, title: "PERFIL 1: INTR√çNSECAMENTE MOTIVADO", desc: "Disfruta aprender, ve valor en educaci√≥n." };
        if(a.A < 3 && a.B >= 4 && a.D < 3 && a.E < 2) return { id: 2, title: "PERFIL 2: MOTIVADO POR METAS", desc: "Enfocado en utilidad pr√°ctica." };
        if(a.A < 3 && a.B < 3 && a.C >= 4 && a.D < 3) return { id: 3, title: "PERFIL 3: PRESI√ìN SOCIAL", desc: "Estudia por culpa o expectativas." };
        if(a.A < 2.5 && a.B < 3 && a.D >= 4 && a.E < 3) return { id: 4, title: "PERFIL 4: EXTERNAMENTE CONTROLADO", desc: "Estudia por obligaci√≥n." };
        if(a.E >= 3.5) return { id: 5, title: "PERFIL 5: DESMOTIVADO", desc: "Sin conexi√≥n. Riesgo cr√≠tico." };
        return { id: 0, title: "PERFIL MIXTO", desc: "Patr√≥n no espec√≠fico." };
    }

    function getAlerts(a, iar) {
        let list = [];
        if(a.E >= 4.0) list.push("Desmotivaci√≥n Alta");
        if(a.A < 2.0) list.push("Motivaci√≥n Intr√≠nseca Muy Baja");
        if(a.D >= 4.5) list.push("Regulaci√≥n Externa Excesiva");
        if(iar < 0) list.push("IAR Negativo");
        if(a.B < 2.5) list.push("Ausencia de Metas");
        return list;
    }

    function getInterventions(pid) {
        let main = [], freq = "";
        if(pid === 1) { main = ["Potenciar autonom√≠a", "Reconocimiento logros"]; freq = "Mensual"; }
        else if(pid === 2) { main = ["Mentor√≠a Egresados", "Conexi√≥n Metas-Estudio"]; freq = "Mensual"; }
        else if(pid === 3) { main = ["Entrevista Motivacional", "Trabajo Familia"]; freq = "Quincenal"; }
        else if(pid === 4) { main = ["Programa 'Reconecta'", "Explorar Valores"]; freq = "Semanal"; }
        else if(pid === 5) { main = ["Activaci√≥n Conductual", "Apoyo Acad√©mico Intensivo"]; freq = "Semanal"; }
        else { main = ["Exploraci√≥n Vocacional"]; freq = "Quincenal"; }
        return { main, freq };
    }

    function mostrarResultados() {
        document.getElementById('test-form').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        
        let av = resultados.avgs;
        let html = `
            <div class="score-row"><span>A. Intr√≠nseca:</span> <b>${av.A.toFixed(1)}</b></div>
            <div class="score-row"><span>B. Identificada:</span> <b>${av.B.toFixed(1)}</b></div>
            <div class="score-row"><span>C. Introyectada:</span> <b>${av.C.toFixed(1)}</b></div>
            <div class="score-row"><span>D. Externa:</span> <b>${av.D.toFixed(1)}</b></div>
            <div class="score-row" style="color:#c62828;"><span>E. Desmotivaci√≥n:</span> <b>${av.E.toFixed(1)}</b></div>
        `;
        document.getElementById('score-details').innerHTML = html;
        document.getElementById('iar-score').innerText = resultados.iar;
        document.getElementById('iar-interp').innerText = resultados.iarData.title;
        document.getElementById('iar-desc').innerText = resultados.iarData.desc;
        document.getElementById('profile-title').innerText = resultados.profileData.title;
        document.getElementById('profile-desc').innerText = resultados.profileData.desc;

        if(resultados.alerts.length > 0) {
            document.getElementById('alerts-container').style.display = 'block';
            document.getElementById('alert-list').innerHTML = resultados.alerts.map(a => `<li>${a}</li>`).join('');
        }
        document.getElementById('interv-main').innerText = "Acciones Recomendadas:";
        document.getElementById('interv-list').innerHTML = resultados.interv.main.map(i => `<li>${i}</li>`).join('');
        document.getElementById('follow-up').innerText = resultados.interv.freq;
        window.scrollTo(0,0);
    }

    function guardarLocalmente() {
        if(!resultados) return;
        let cur = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let up = { 
            ...cur, 
            nombre: resultados.nombre,
            edad: resultados.edad,
            sexo: resultados.sexo,
            ebmaIAR: resultados.iar,
            ebmaPerfil: resultados.profileData.title
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(up));
        alert("‚úÖ Datos guardados en el expediente.");
    }

    function generarPDFEBMA() {
        if(!resultados) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        doc.setFillColor(0, 77, 64); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("CBTa No. 130", 105, 20, null, null, "center");
        doc.setFontSize(14); doc.text("ESCALA DE MOTIVACI√ìN ACAD√âMICA (EBMA)", 105, 30, null, null, "center");
        
        doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Estudiante: ${resultados.nombre}`, 20, 50);
        doc.text(`Edad: ${resultados.edad} | Semestre: ${resultados.semestre} ${resultados.grupo}`, 20, 56);
        doc.text(`Especialidad: ${resultados.especialidad}`, 20, 62);
        doc.text(`Fecha: ${document.getElementById('fecha').value}`, 140, 50);
        doc.line(20, 65, 190, 65);

        y = 75;
        doc.setFont("helvetica", "bold"); doc.text("RESULTADOS (1-5)", 20, y); y+=10;
        const addS = (l, v) => {
            doc.setFont("helvetica", "normal"); doc.text(l, 25, y);
            doc.setFont("helvetica", "bold"); doc.text(v.toFixed(1), 160, y);
            y+=8;
        };
        addS("A. Intr√≠nseca (Gusto)", resultados.avgs.A);
        addS("B. Identificada (Metas)", resultados.avgs.B);
        addS("C. Introyectada (Culpa)", resultados.avgs.C);
        addS("D. Externa (Obligaci√≥n)", resultados.avgs.D);
        doc.setTextColor(198, 40, 40);
        addS("E. Desmotivaci√≥n", resultados.avgs.E);
        doc.setTextColor(0);

        y+=5;
        doc.setFillColor(224, 242, 241); doc.rect(20, y, 170, 25, 'F');
        doc.setTextColor(0, 77, 64);
        doc.text(`IAR: ${resultados.iar}`, 25, y+10);
        doc.setFont("helvetica", "normal");
        doc.text(resultados.iarData.title, 80, y+10);
        doc.setFontSize(9);
        doc.text(resultados.iarData.desc, 25, y+18);
        
        y+=35;
        doc.setTextColor(0); doc.setFontSize(11);
        doc.setFont("helvetica", "bold"); doc.text("PERFIL MOTIVACIONAL:", 20, y); y+=7;
        doc.setTextColor(230, 81, 0);
        doc.text(resultados.profileData.title, 25, y); y+=7;
        doc.setTextColor(0); doc.setFont("helvetica", "normal");
        doc.text(resultados.profileData.desc, 25, y); y+=10;

        if(resultados.alerts.length > 0) {
            doc.setTextColor(198, 40, 40); doc.setFont("helvetica", "bold");
            doc.text("ALERTAS:", 20, y); y+=7;
            doc.setFont("helvetica", "normal");
            resultados.alerts.forEach(a => { doc.text(`‚Ä¢ ${a}`, 25, y); y+=6; });
            y+=5;
        }

        doc.setTextColor(0); doc.setFont("helvetica", "bold");
        doc.text("INTERVENCIONES:", 20, y); y+=7;
        doc.setFont("helvetica", "normal");
        resultados.interv.main.forEach(i => { doc.text(`- ${i}`, 25, y); y+=6; });
        doc.text(`Seguimiento: ${resultados.interv.freq}`, 25, y+6);

        y+=25; doc.line(70, y, 140, y);
        doc.text("Firma del Evaluador", 105, y+5, null, null, "center");

        doc.save(`EBMA_${resultados.nombre}.pdf`);
    }

    function enviarWhatsApp() {
        if(!resultados) return;
        let m = `üéì *EBMA*%0Aüë§ ${resultados.nombre}%0Aüìä IAR: ${resultados.iar}%0Aüè∑Ô∏è Perfil: ${resultados.profileData.title}`;
        window.open(`https://wa.me/${NUMERO_DESTINO}?text=${m}`, '_blank');
    }
</script>
</body>
</html>


