        // Finalizar (guardando edad/sexo)
        function finalize(data) { /*...*/} // Simplified ref

        function finalizar() {
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('st-progress').innerText = '100%';
            
            const result = { 
                id: Date.now().toString(36), 
                alumno: sessionData.nombre, 
                grupo: sessionData.grupo,
                edad: sessionData.edad, // NEW
                sexo: sessionData.sexo, // NEW
                fecha: new Date().toLocaleDateString(), 
                resultados: {} 
            };
            
            sessionData.testsIds.forEach(tid => {
                const r = sessionData.respuestas[tid];
                let score = 0;
                let interpretacion = "Puntuación no procesada"; // Nuevo para la corrección
                
                // --- LOGICA DE CALIFICACIÓN ---
                if(tid === 'PHQ9') {
                    score = r.reduce((a,b)=>a+parseInt(b),0);
                    let nivel = score>=20?"Depresión Grave":score>=15?"Depresión Moderada":score>=10?"Depresión Leve":"Síntomas Depresivos Mínimos";
                    interpretacion = `${score} (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'GAD7') {
                    score = r.reduce((a,b)=>a+parseInt(b),0);
                    let nivel = score>=15?"Ansiedad Grave":score>=10?"Ansiedad Moderada":score>=5?"Ansiedad Leve":"Síntomas de Ansiedad Mínimos";
                    interpretacion = `${score} (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'HADS') {
                    // HADS: 14 items - Ansiedad (impares: 0,2,4,6,8,10,12,13), Depresión (pares: 1,3,5,7,9,11)
                    // Items invertidos: Depresión (1,3,5,7,9,11) se deben invertir (3-valor)
                    let ans = 0, dep = 0;
                    r.forEach((v, i) => {
                        const val = parseInt(v);
                        if([0,2,4,6,8,10,12,13].includes(i)) {
                            // Ansiedad - items impares en índice (0,2,4,6,8,10,12,13)
                            ans += val;
                        } else {
                            // Depresión - items pares en índice (1,3,5,7,9,11) - invertidos
                            dep += (3 - val);
                        }
                    });
                    let ansN = ans>11?"CASO CLÍNICO (Ans.)":ans>8?"BORDE (Ans.)":"Normal (Ans.)";
                    let depN = dep>11?"CASO CLÍNICO (Dep.)":dep>8?"BORDE (Dep.)":"Normal (Dep.)";
                    interpretacion = `A:${ans} (${ansN}) | D:${dep} (${depN})`; // Se guarda la interpretación
                } else if(tid === 'SSI') {
                    // SSI tiene solo 5 items de screening (max 10 puntos)
                    score = r.reduce((a,b)=>a+parseInt(b),0);
                    let nivel = score>=6?"RIESGO SUICIDA CRÍTICO":score>=3?"Riesgo Suicida Moderado":"Riesgo Suicida Bajo";
                    interpretacion = `${score} (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'PLUTCHIK') {
                    score = r.reduce((a,b)=>a+(b==='V'?1:0),0);
                    let nivel = score>=9?"Riesgo Suicida Alto":score>=5?"Riesgo Suicida Moderado":"Riesgo Suicida Bajo";
                    interpretacion = `${score}/15 (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'IPA') {
                    score = r.reduce((a,b)=>a+parseInt(b),0);
                    let nivel = score>=100?"Distorsión Cognitiva Severa":score>=50?"Distorsión Cognitiva Moderada":"Bajo Nivel de Distorsión";
                    interpretacion = `${score} (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'BAI') {
                    score = r.reduce((a,b)=>a+parseInt(b),0);
                    let nivel = score>=30?"Ansiedad Severa":score>=16?"Ansiedad Moderada":score>=8?"Ansiedad Leve":"Ansiedad Mínima";
                    interpretacion = `${score} (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'BHS') {
                    const key = [2,4,7,9,11,12,14,16,17,18,20];
                    score = r.reduce((acc,v,i) => acc + (key.includes(i+1)?(v==='V'?1:0):(v==='F'?1:0)), 0);
                    let nivel = score>=10?"Desesperanza Alta":score>=5?"Desesperanza Moderada":"Desesperanza Baja";
                    interpretacion = `${score}/20 (${nivel})`; // Se guarda la interpretación
                } else if(tid === 'CDFR') {
                    let sum = r.reduce((a,b)=>a+b,0); if(sum<0) sum=0;
                    let niv = sum>24?"Riesgo CRÍTICO":sum>16?"Riesgo Alto":sum>8?"Riesgo Moderado":"Riesgo Bajo";
                    interpretacion = `${sum} (${niv})`; // Se guarda la interpretación
                } else if(tid === 'CSSRS') {
                    // La lógica ya devuelve la interpretación
                    interpretacion = r[5]===1 ? "CRÍTICO (Conducta de Intento)" : r[4]===1 ? "ALTO (Plan Específico)" : r[1]===1 ? "Moderado (Ideación)" : "Bajo Riesgo";
                } else if (tid === 'BDI') {
                    let sum = r.reduce((a,b)=>a+b,0);
                    let niv = sum<=13?"Depresión Mínima":sum<=19?"Depresión Leve":sum<=28?"Depresión Moderada":"Depresión GRAVE";
                    if(r[8] > 0) niv += " ⚠️ Riesgo Suicida";
                    interpretacion = `${sum} (${niv})`; // Se guarda la interpretación
                } else if (tid === 'EBMA') {
                    const getAvg = (s,e) => { let x=0; for(let i=s;i<=e;i++) x+=r[i]; return x/5; };
                    let A=getAvg(0,4), B=getAvg(5,9), C=getAvg(10,14), D=getAvg(15,19), E=getAvg(20,24);
                    let iar = (2*A + 1*B - 1*C - 2*D).toFixed(1);
                    let p = "Motivación Mixta";
                    if(A>=4 && B>=3.5 && D<2.5) p="Motivación Intrínseca"; else if(A<2.5 && D>=4) p="Motivación Externa"; else if(E>=3.5) p="Desmotivado/Amotivación";
                    interpretacion = `IAR:${iar} (${p})`; // Se guarda la interpretación
                } else if (tid === 'IDARE') {
                    const invE = [0,1,4,7,9,10,14,15,18,19];
                    const invR = [20,25,26,29,32,35,38];
                    let sE = 0, sR = 0;
                    r.forEach((v, i) => {
                        const val = parseInt(v);
                        if(i<20) sE += invE.includes(i) ? (5-val) : val;
                        else sR += invR.includes(i-20) ? (5-val) : val; // i-20 porque invR usa índices de 0 a 19 para la segunda parte.
                    });
                    let nivE = sE>=44?"Elevada":sE>=38?"Moderada":"Baja";
                    let nivR = sR>=44?"Elevada":sR>=38?"Moderada":"Baja";
                    interpretacion = `E:${sE} (${nivE}) | R:${sR} (${nivR})`; // Se guarda la interpretación
                } else if (tid === 'VAK') {
                    // Contar votos por estilo
                    let v=0, a=0, k=0;
                    r.forEach((val, i) => {
                        if(String(val).includes('Visual')) v++;
                        else if(String(val).includes('Auditivo')) a++;
                        else if(String(val).includes('Kinestésico')) k++;
                    });
                    let max = Math.max(v,a,k);
                    let estilo = v===max?"Visual":a===max?"Auditivo":"Kinestésico";
                    interpretacion = `${estilo} (V:${v}, A:${a}, K:${k})`; // Se guarda la interpretación
                } else if (tid === 'GOCA') {
                    score = r.reduce((a,b)=>a+parseInt(b),0);
                    let nivel = score>=36?"Excelente":score>=24?"Bueno":score>=12?"Regular":"Requiere apoyo";
                    interpretacion = `${score}/45 (${nivel})`; // Se guarda la interpretación
                } else if (tid === 'LIRA') {
                    let sum = r.reduce((a,b)=>a+parseInt(b),0);
                    if(sum<0) sum = 0;
                    let niv = sum>20?"Riesgo CRÍTICO":sum>12?"Riesgo Alto":sum>5?"Riesgo Moderado":"Riesgo Bajo";
                    interpretacion = `${sum} (${niv})`; // Se guarda la interpretación
                } else {
                    interpretacion = r.join(',');
                }
                
                result.resultados[tid] = { score: interpretacion, raw: r }; // ¡CORRECCIÓN CLAVE!
            });

            const token = btoa(encodeURIComponent(JSON.stringify(result)));
            document.getElementById('step-questions').classList.add('hidden');
            document.getElementById('step-finish').classList.remove('hidden');
            document.getElementById('final-token-display').innerText = token;
        }
