<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite de Evaluación Psicopedagógica v3.1 (Estable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#fdf2f8', 100: '#fce7f3', 500: '#ec4899', 600: '#db2777', 800: '#9d174d', 900: '#831843' },
                        idare: { 50: '#eceff1', 100: '#cfd8dc', 600: '#546e7a', 800: '#37474f' }
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .columbia-btn input:checked + div { ring-width: 2px; ring-offset-width: 2px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 min-h-screen font-sans selection:bg-brand-100">

    <div id="view-admin" class="max-w-7xl mx-auto p-4 md:p-6 space-y-6 pb-20">
        
        <header class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <a href="index.html" class="bg-slate-100 hover:bg-slate-200 text-slate-600 p-3 rounded-xl transition-colors" title="Limpiar / Inicio">
                    <i class="ph-bold ph-arrows-clockwise text-xl"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-brand-800 to-brand-600 text-white p-3 rounded-xl shadow-lg shadow-brand-600/20">
                        <i class="ph-bold ph-stack text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl text-slate-800">Gestor de Evaluaciones</h1>
                        <p class="text-sm text-slate-500">Suite Integral v3.1 (Estable)</p>
                    </div>
                </div>
            </div>
            <button onclick="toggleModal('import-modal')" class="w-full md:w-auto bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-md transition-all active:scale-95">
                <i class="ph-bold ph-download-simple"></i> IMPORTAR CÓDIGO
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-6">
                <section class="bg-white rounded-2xl shadow-lg border-t-4 border-brand-600 overflow-hidden sticky top-6">
                    <div class="p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-1 flex items-center gap-2">
                            <i class="ph-duotone ph-paper-plane-tilt text-brand-600"></i> Nueva Batería
                        </h2>
                        <p class="text-xs text-slate-400 mb-6">Selecciona las pruebas para enviar.</p>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Nombre Alumno</label>
                                <input type="text" id="adm-nombre" placeholder="Ej. Juan Pérez" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-600 outline-none text-sm font-medium">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Grupo / Semestre</label>
                                <input type="text" id="adm-grupo" placeholder="Ej. 6A Programación" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-600 outline-none text-sm font-medium">
                            </div>
                        </div>

                        <div class="mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Pruebas Disponibles</div>
                        <div id="tests-checklist" class="space-y-2 mb-8 max-h-64 overflow-y-auto pr-1">
                            </div>

                        <button onclick="generarLinkBateria()" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-3.5 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg shadow-brand-600/30 transition-all active:scale-95">
                            <i class="ph-bold ph-link"></i> Generar Link Único
                        </button>

                        <div id="link-result-area" class="hidden mt-6 pt-6 border-t border-dashed border-slate-200 animate-fade-in">
                            <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                                <p class="text-xs text-green-800 font-bold mb-2"><i class="ph-fill ph-check-circle"></i> Link listo:</p>
                                <div class="flex gap-2 mb-3">
                                    <input type="text" id="final-link" readonly class="w-full text-[10px] font-mono bg-white border border-green-200 p-2 rounded text-slate-600">
                                    <button onclick="copiarLink()" class="bg-white border border-green-200 text-green-600 px-3 rounded hover:bg-green-100"><i class="ph-bold ph-copy"></i></button>
                                </div>
                                <button onclick="enviarWhatsAppLink()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-md">
                                    <i class="ph-bold ph-whatsapp-logo text-lg"></i> Enviar por WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-8">
                <section class="bg-white rounded-2xl shadow-sm border border-gray-200 h-full flex flex-col min-h-[500px]">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl">
                        <div>
                            <h3 class="font-bold text-slate-700 text-lg">Expedientes Activos</h3>
                            <p class="text-xs text-slate-400">Base de datos local</p>
                        </div>
                        <span id="db-count" class="bg-brand-100 text-brand-700 text-xs px-3 py-1 rounded-full font-bold border border-brand-200">0</span>
                    </div>
                    <div class="flex-1 overflow-auto p-0">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-6 py-4">Alumno / Grupo</th>
                                    <th class="px-6 py-4">Resultados</th>
                                    <th class="px-6 py-4 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="db-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                        <div id="empty-state" class="hidden flex flex-col items-center justify-center h-64 text-center p-8">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300"><i class="ph-duotone ph-folder-open text-3xl"></i></div>
                            <h4 class="text-slate-600 font-bold">Sin expedientes</h4>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="view-student" class="hidden min-h-screen bg-slate-50 flex flex-col">
        <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-50 shadow-sm">
            <div class="max-w-2xl mx-auto flex justify-between items-center mb-2">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-white"><i class="ph-bold ph-student"></i></div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Modo Evaluación</p>
                </div>
                <div class="text-right">
                    <p id="st-progress" class="text-brand-600 font-bold text-sm">0%</p>
                </div>
            </div>
            <div class="h-1 w-full bg-slate-100 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-brand-600 transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>

        <div class="flex-1 max-w-2xl mx-auto w-full p-4 md:p-6 pb-32">
            
            <div id="step-welcome" class="text-center py-8 fade-in">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Bienvenido/a, <span id="welcome-name" class="text-brand-600"></span></h2>
                <p class="text-slate-500 mb-8 text-sm">Antes de comenzar, por favor completa tu ficha de identificación.</p>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 max-w-sm mx-auto text-left space-y-4 mb-8">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                        <input type="text" id="read-name" readonly class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-500 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Grupo / Semestre</label>
                        <input type="text" id="read-group" readonly class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-500 text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Edad *</label>
                            <input type="number" id="st-age" placeholder="Años" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-600 outline-none text-sm font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Sexo *</label>
                            <select id="st-sex" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-600 outline-none text-sm">
                                <option value="">Elegir...</option>
                                <option value="H">Hombre</option>
                                <option value="M">Mujer</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <p class="text-xs text-slate-400 mb-4">Se aplicarán las siguientes pruebas:</p>
                <div id="test-list-preview" class="space-y-2 mb-8 text-left max-w-sm mx-auto"></div>

                <button onclick="iniciarSecuencia()" class="bg-brand-600 hover:bg-brand-700 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-brand-600/20 w-full md:w-auto">
                    Iniciar Evaluación <i class="ph-bold ph-arrow-right ml-2"></i>
                </button>
            </div>

            <div id="step-questions" class="hidden fade-in">
                
                <div class="bg-slate-800 text-white rounded-t-2xl p-4 shadow-md mb-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Ficha de Identificación</h3>
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm font-mono text-slate-200">
                                <span><i class="ph-fill ph-user"></i> <span id="ficha-nombre">...</span></span>
                                <span><i class="ph-fill ph-users-three"></i> <span id="ficha-grupo">...</span></span>
                                <span><i class="ph-fill ph-cake"></i> <span id="ficha-edad">--</span> años</span>
                                <span><i class="ph-fill ph-gender-intersex"></i> <span id="ficha-sexo">--</span></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="ficha-fecha" class="text-xs text-slate-400">00/00/0000</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white border-x border-b border-gray-200 p-6 rounded-b-2xl shadow-sm mb-8">
                    <div class="flex items-center gap-3 mb-4">
                        <div id="current-test-icon-box" class="p-3 rounded-lg bg-slate-100 text-slate-600">
                            <i id="current-test-icon" class="ph-fill ph-clipboard-text text-2xl"></i>
                        </div>
                        <div>
                            <h2 id="current-test-title" class="text-xl font-bold text-slate-800">Nombre de la Prueba</h2>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold uppercase">Psicometría</span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h4 class="text-xs font-bold text-blue-800 uppercase mb-1">Instrucciones:</h4>
                        <p id="current-test-desc" class="text-sm text-blue-900 leading-relaxed text-justify">...</p>
                    </div>
                </div>

                <div id="questions-container" class="space-y-6"></div>

                <button onclick="siguientePrueba()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-lg mt-10 hover:bg-slate-900 flex items-center justify-center gap-2">
                    Siguiente Sección <i class="ph-bold ph-caret-right"></i>
                </button>
            </div>

            <div id="step-finish" class="hidden text-center py-10 fade-in">
                <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce"><i class="ph-fill ph-check-circle text-5xl"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 mb-2">¡Evaluación Finalizada!</h2>
                <p class="text-slate-500 mb-8 max-w-xs mx-auto">Tus respuestas han sido encriptadas correctamente.</p>
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 max-w-sm mx-auto relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-green-500"></div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-3 tracking-widest">CÓDIGO DE RESULTADOS</p>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-5 font-mono text-xs break-all text-slate-600 text-left relative group">
                        <div id="final-token-display" class="max-h-32 overflow-y-auto pr-2">...</div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="enviarTokenWhatsapp()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-green-500/30 transition-all active:scale-95"><i class="ph-bold ph-whatsapp-logo text-xl"></i> Enviar a Evaluador</button>
                        <button onclick="copiarToken()" class="w-full bg-white text-slate-600 font-bold py-3.5 rounded-xl hover:bg-slate-50 border border-slate-200 transition-colors">Copiar Código</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="import-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-0 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">Importar Resultados</h3>
                <button onclick="toggleModal('import-modal')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-3">Pega aquí el código de texto del alumno.</p>
                <textarea id="import-token-input" rows="5" class="w-full bg-slate-50 border border-slate-300 rounded-xl p-4 font-mono text-xs focus:ring-2 focus:ring-brand-600 outline-none mb-6 resize-none"></textarea>
                <button onclick="procesarImportacion()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl transition-colors shadow-lg shadow-brand-600/20"><i class="ph-bold ph-check-circle"></i> Procesar</button>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full h-[90vh] flex flex-col overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-slate-800">Vista Previa: <span id="preview-title" class="text-brand-600"></span></h3>
                <button onclick="toggleModal('preview-modal')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="p-4 bg-blue-50 border-b border-blue-100 text-xs text-blue-800 px-6 italic" id="preview-instructions">
                </div>
            <div id="preview-content" class="p-6 overflow-y-auto bg-slate-50/50 space-y-6 flex-1"></div>
        </div>
    </div>

    <div id="detail-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full h-[90vh] flex flex-col overflow-hidden">
            <div class="bg-slate-800 text-white px-6 py-5 border-b border-slate-700 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg"><i class="ph-bold ph-folder-user text-2xl"></i></div>
                    <div>
                        <h3 id="detail-name" class="text-xl font-bold">Nombre Alumno</h3>
                        <p id="detail-meta" class="text-xs text-slate-400">Grupo: --</p>
                    </div>
                </div>
                <button onclick="toggleModal('detail-modal')" class="text-slate-400 hover:text-white transition-colors bg-slate-700 p-2 rounded-lg"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div id="detail-content" class="p-6 overflow-y-auto bg-slate-50 flex-1 space-y-4"></div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. CATÁLOGO CON INSTRUCCIONES FORMALES
        // ============================================
        const CATALOGO_PRUEBAS = {
            'PHQ9': { id: 'PHQ9', titulo: 'Cuestionario de Salud (PHQ-9)', icono: 'ph-heartbeat', tipo: 'likert_0_3', instrucciones: 'Durante las últimas 2 semanas, ¿qué tan seguido ha tenido molestias por los siguientes problemas?',
                items: [
                    "Poco interés o placer en hacer las cosas", "Se ha sentido decaído, deprimido o sin esperanza", "Ha tenido dificultad para conciliar o mantener el sueño",
                    "Se ha sentido cansado o con poca energía", "Ha tenido poco apetito o ha comido demasiado", "Se ha sentido mal consigo mismo o como un fracaso",
                    "Ha tenido dificultad para concentrarse", "Se ha movido o hablado lentamente o muy rápido", "Ha tenido pensamientos de que sería mejor estar muerto"
                ]
            },
            'GAD7': { id: 'GAD7', titulo: 'Escala de Ansiedad Generalizada (GAD-7)', icono: 'ph-waves', tipo: 'likert_0_3', instrucciones: 'Durante las últimas 2 semanas, ¿qué tan frecuentemente ha experimentado los siguientes síntomas?',
                items: [
                    "Nerviosismo o ansiedad", "No poder parar o controlar la preocupación", "Preocupación excesiva por diferentes cosas", "Dificultad para relajarse",
                    "Inquietud (dificultad para permanecer quieto)", "Irritabilidad", "Miedo a que algo malo pueda suceder"
                ]
            },
            'HADS': { id: 'HADS', titulo: 'Escala Hospitalaria de Ansiedad y Depresión (HADS)', icono: 'ph-hospital', tipo: 'likert_0_3', instrucciones: 'Lea cada frase y marque la respuesta que mejor corresponda a cómo se ha sentido durante la última semana.',
                items: [
                    "Me siento tenso/a o intranquilo/a", "Sigo disfrutando de las cosas como siempre", "Siento una sensación de miedo como si fuera a suceder algo horrible",
                    "Soy capaz de reírme y ver el lado cómico de las cosas", "Me siento preocupado/a", "Me siento optimista respecto del futuro", "Experimento sensaciones de pánico",
                    "Disfruto leyendo o viendo TV", "Me siento ansioso/a", "Me siento feliz", "Me siento confiado/a en mí mismo/a",
                    "Me siento tan inquieto/a que me resulta difícil estar quieto/a", "Espero algo con ilusión", "Experimento sensaciones súbitas de pánico"
                ]
            },
            'SSI': { id: 'SSI', titulo: 'Escala de Ideación Suicida de Beck (SSI)', icono: 'ph-warning-octagon', tipo: 'ssi_flow', instrucciones: 'Elija la opción que mejor describa su actitud actual o más reciente. Responda con sinceridad.',
                items: [
                    {t: "Deseo de vivir", o: [{v:0, t:"Moderado a Fuerte"}, {v:1, t:"Débil"}, {v:2, t:"Ninguno"}]},
                    {t: "Deseo de morir", o: [{v:0, t:"Ninguno"}, {v:1, t:"Débil"}, {v:2, t:"Moderado a Fuerte"}]},
                    {t: "Razones para vivir vs morir", o: [{v:0, t:"Vivir supera a Morir"}, {v:1, t:"Iguales"}, {v:2, t:"Morir supera a Vivir"}]},
                    {t: "Deseo de intento suicida activo", o: [{v:0, t:"Ninguno"}, {v:1, t:"Débil"}, {v:2, t:"Moderado a Fuerte"}]},
                    {t: "Deseo suicida pasivo", o: [{v:0, t:"Tomaría precauciones para vivir"}, {v:1, t:"Dejaría al azar"}, {v:2, t:"Evitaría pasos para vivir"}]}
                ]
            },
            'PLUTCHIK': { id: 'PLUTCHIK', titulo: 'Escala de Riesgo Suicida de Plutchik', icono: 'ph-shield-warning', tipo: 'verdadero_falso', instrucciones: 'Responda SÍ o NO a las siguientes preguntas sobre cómo se ha sentido o sus conductas recientes.',
                items: [
                    "Toma medicamentos habituales (aspirinas, píldoras para dormir)", "Tiene dificultad para conciliar el sueño", "Ha notado que podría perder el control sobre sí mismo",
                    "Tiene poco interés en relacionarse con la gente", "Ve el futuro con más pesimismo que optimismo", "Se ha sentido inútil o sin valor", "Ve su futuro sin ninguna esperanza",
                    "Se ha sentido tan fracasado que quería abandonar todo", "¿Está deprimido/a ahora?", "¿Está separado, divorciado o viudo?",
                    "¿Sabe si algún familiar ha intentado suicidarse?", "¿Ha estado tan enfadado que podría matar a alguien?", "¿Ha pensado alguna vez en suicidarse?",
                    "¿Ha comentado a alguien que quería suicidarse?", "¿Ha intentado alguna vez quitarse la vida?"
                ]
            },
            'IPA': { id: 'IPA', titulo: 'Inventario de Pensamientos Automáticos (IPA)', icono: 'ph-brain', tipo: 'likert_0_3', instrucciones: 'A continuación encontrará una lista de pensamientos que suele tener la gente. Lea cada uno de ellos y marque la frecuencia con la que ha tenido este pensamiento en la última semana. Asegúrese de responder a todos los ítems.',
                items: [
                    "No puedo soportar ciertas cosas.", "Solamente me pasan cosas malas.", "Todo lo que hago me sale mal.", "Sé que piensan mal de mí.", "¿Y si tengo alguna enfermedad grave?.",
                    "Soy inferior a la gente en casi todo.", "Si otros cambiaran su actitud yo me sentiría mejor.", "¡No hay derecho a que me traten así!.", "Si me siento triste es porque soy un enfermo mental.",
                    "Mis problemas dependen de los que me rodean.", "Soy un desastre como persona.", "Yo tengo la culpa de todo lo que me pasa.", "Debería de estar bien y no tener estos problemas.",
                    "Sé que tengo la razón y no me entienden.", "Aunque ahora sufra, algún día tendré mi recompensa.", "Es horrible que me pase esto.", "Mi vida es un continuo fracaso.",
                    "Siempre tendré este problema.", "Sé que me están mintiendo y engañando.", "¿Y si me vuelvo loco y pierdo la cabeza?.", "Soy superior a la gente en casi todo.",
                    "Yo soy responsable del sufrimiento de los que me rodean.", "Si me quisieran de verdad no me tratarían así.", "Me siento culpable, y es porque he hecho algo malo.",
                    "Si tuviera más apoyo no tendría estos problemas.", "Alguien que conozco es un imbécil.", "Otros tienen la culpa de lo que me pasa.", "No debería de cometer estos errores.",
                    "No quiere reconocer que estoy en lo cierto.", "Ya vendrán mejores tiempos.", "Es insoportable, no puedo aguantar más.", "Soy incompetente e inútil.", "Nunca podré salir de esta situación.",
                    "Quieren hacerme daño.", "¿Y si les pasa algo malo a las personas a quienes quiero?.", "La gente hace las cosas mejor que yo.", "Soy una víctima de mis circunstancias.",
                    "No me tratan como deberían hacerlo y me merezco.", "Si tengo estos síntomas es porque soy un enfermo.", "Si tuviera mejor situación económica no tendría estos problemas.",
                    "Soy un neurótico.", "Lo que me pasa es un castigo que merezco.", "Debería recibir más atención y cariño de otros.", "Tengo razón, y voy a hacer lo que me da la gana.", "Tarde o temprano me irán las cosas mejor."
                ]
            },
            'BAI': { id: 'BAI', titulo: 'Inventario de Ansiedad de Beck (BAI)', icono: 'ph-heartbeat', tipo: 'likert_0_3', instrucciones: 'Indique cuánto le ha molestado cada síntoma durante la última semana (incluyendo hoy). 0=Nada, 1=Leve, 2=Moderado, 3=Severo.',
                items: [
                    "Entumecimiento u hormigueo", "Sensación de calor", "Temblor en las piernas", "Incapacidad para relajarse", "Miedo a que suceda lo peor", 
                    "Mareo o aturdimiento", "Palpitaciones o taquicardia", "Sensación de inestabilidad", "Sensación de terror", "Nerviosismo", 
                    "Sensación de ahogo", "Temblor de manos", "Temblor generalizado", "Miedo a perder el control", "Dificultad para respirar", 
                    "Miedo a morir", "Asustado", "Indigestión o malestar abdominal", "Sensación de desmayo", "Rubor facial", 
                    "Sudoración (no debida al calor)"
                ]
            },
            'IDARE': { id: 'IDARE', titulo: 'Inventario de Ansiedad Rasgo-Estado (IDARE)', icono: 'ph-waves', tipo: 'likert_1_4', instrucciones: 'El inventario consta de dos partes. En la primera parte (ítems 1-20), indique cómo se siente AHORA MISMO, en este momento. En la segunda parte (ítems 21-40), indique cómo se siente GENERALMENTE. No hay respuestas correctas o incorrectas. No emplee mucho tiempo en cada frase.',
                items: [
                    "1. Me siento calmado", "2. Me siento seguro", "3. Estoy tenso", "4. Estoy contrariado", "5. Me siento a gusto", "6. Me siento alterado", "7. Estoy preocupado por posibles desgracias",
                    "8. Me siento descansado", "9. Me siento ansioso", "10. Me siento cómodo", "11. Me siento con confianza", "12. Me siento nervioso", "13. Estoy agitado",
                    "14. Me siento a punto de explotar", "15. Me siento relajado", "16. Me siento satisfecho", "17. Estoy preocupado", "18. Me siento aturdido", "19. Me siento alegre",
                    "20. Me siento bien", "21. Me siento bien", "22. Me canso rápidamente", "23. Siento ganas de llorar", "24. Quisiera ser tan feliz como otros",
                    "25. Pierdo oportunidades por no decidir", "26. Me siento descansado", "27. Soy una persona tranquila", "28. Siento que las dificultades se amontonan",
                    "29. Me preocupo demasiado por cosas sin importancia", "30. Soy feliz", "31. Tomo las cosas muy a pecho", "32. Me falta confianza en mí mismo",
                    "33. Me siento seguro", "34. Trato de evitar enfrentar crisis", "35. Me siento melancólico", "36. Me siento satisfecho",
                    "37. Ideas poco importantes me molestan", "38. Me afectan tanto los desengaños", "39. Soy una persona estable", "40. Me pongo tenso cuando pienso en mis asuntos"
                ]
            },
            'VAK': { id: 'VAK', titulo: 'Cuestionario de Estilos de Aprendizaje (VAK)', icono: 'ph-eye', tipo: 'opcion_multiple', instrucciones: 'Elige la opción que mejor represente tu comportamiento o preferencia en cada situación. Esto nos ayudará a identificar si tu estilo de aprendizaje es visual, auditivo o kinestésico.',
                items: [
                    { p: "¿Qué prefieres hacer en tu tiempo libre?", ops: ["Ver películas (Visual)", "Escuchar música (Auditivo)", "Hacer deporte (Kinestésico)"] },
                    { p: "¿Cómo aprendes mejor?", ops: ["Viendo diagramas o videos", "Escuchando explicaciones", "Haciendo prácticas o maquetas"] },
                    { p: "¿Qué te distrae más?", ops: ["El desorden visual", "Los ruidos", "La incomodidad física"] },
                    { p: "¿Cómo te orientas en una ciudad nueva?", ops: ["Uso un mapa o GPS", "Pregunto a alguien", "Camino hasta encontrar referencias"] },
                    { p: "Al comprar un coche te fijas en:", ops: ["El color y diseño", "El sonido del motor y equipo de audio", "La comodidad de los asientos"] }
                ]
            },
            'BHS': { id: 'BHS', titulo: 'Escala de Desesperanza de Beck (BHS)', icono: 'ph-circle-half', tipo: 'verdadero_falso', instrucciones: 'A continuación hay 20 afirmaciones sobre el futuro. Lea cada una y determine si aplica a usted. Si la afirmación describe su actitud la última semana, marque VERDADERO. Si no es así, marque FALSO.',
                items: [
                    "Veo el futuro con esperanza y entusiasmo.", "Tal vez debería abandonar todo, porque no puedo hacer que las cosas mejoren.", "Cuando las cosas van mal, me alivia saber que las cosas no pueden permanecer así siempre.",
                    "No puedo imaginar cómo será mi vida dentro de 10 años.", "Tengo tiempo suficiente para lograr las cosas que quiero hacer.", "En el futuro, espero conseguir lo que me pueda interesar.",
                    "Mi futuro me parece oscuro.", "Espero más cosas buenas de la vida que lo que la gente común espera.", "Simplemente no tengo buena suerte, y no hay razón para creer que la tendré en el futuro.",
                    "Mis experiencias pasadas me han preparado bien para mi futuro.", "Todo lo que puedo ver hacia adelante es más desagradable que agradable.", "No espero conseguir lo que realmente quiero.",
                    "Cuando miro hacia el futuro, espero que seré más feliz de lo que soy ahora.", "Las cosas simplemente no marcharán como yo quiero.", "Tengo gran fé en el futuro.",
                    "Nunca consigo lo que quiero, por lo que es absurdo querer cualquier cosa.", "Es muy improbable que pueda lograr alguna satisfacción real en el futuro.", "El futuro me parece vago e incierto.",
                    "Puedo esperar más épocas buenas que malas.", "No vale la pena tratar de conseguir algo que deseo, porque probablemente no lo lograré."
                ]
            },
            'CDFR': { id: 'CDFR', titulo: 'Cuestionario de Detección de Factores de Riesgo (CDFR)', icono: 'ph-shield-warning', tipo: 'opcion_multiple_valorada', instrucciones: 'Este cuestionario es confidencial y busca identificar factores que puedan afectar tu desempeño escolar o bienestar. Responde con total honestidad.',
                items: [
                    { p: "1. ¿Con quién vives?", ops: [{t:"Ambos padres", v:0}, {t:"Solo uno", v:1}, {t:"Familiares", v:1}, {t:"Solo/Amigos", v:3}] },
                    { p: "4. ¿Alguien más estudió bachillerato?", ops: [{t:"Sí", v:-1}, {t:"No, soy el primero", v:2}] },
                    { p: "5. ¿Aportas económicamente?", ops: [{t:"No", v:0}, {t:"Sí, ayuda", v:1}, {t:"Sí, dependen de mí", v:3}] },
                    { p: "6. ¿Tienes lugar para estudiar?", ops: [{t:"Sí", v:-1}, {t:"A veces", v:1}, {t:"No, nunca", v:3}] },
                    { p: "8. Situaciones difíciles recientes", ops: [{t:"Ninguna", v:0}, {t:"Sí, han pasado cosas", v:2}] },
                    { p: "10. ¿Trabajas?", ops: [{t:"No trabajo", v:0}, {t:"<10 horas", v:1}, {t:"10-20 horas", v:2}, {t:">20 horas", v:3}] },
                    { p: "13. Dificultad para materiales", ops: [{t:"Nunca", v:0}, {t:"A veces", v:1}, {t:"Frecuentemente", v:2}] },
                    { p: "15. Tiempo traslado", ops: [{t:"<30 min", v:0}, {t:"30-60 min", v:1}, {t:">1 hora", v:2}] },
                    { p: "16. ¿Dejar escuela por dinero?", ops: [{t:"No", v:0}, {t:"A veces", v:2}, {t:"Frecuente/Sí", v:3}] },
                    { p: "17. ¿Reprobado antes?", ops: [{t:"No", v:0}, {t:"Sí", v:2}] },
                    { p: "18. Promedio Secundaria", ops: [{t:"8.0 - 10", v:-1}, {t:"7.0 - 7.9", v:1}, {t:"< 7.0", v:3}] },
                    { p: "22. Horas estudio extra", ops: [{t:"0-2 horas", v:2}, {t:"3-10 horas", v:0}, {t:">10 horas", v:-1}] },
                    { p: "23. Internet/PC", ops: [{t:"Sí, ambos", v:-1}, {t:"Solo uno/A veces", v:1}, {t:"Ninguno", v:2}] },
                    { p: "29. Motivación", ops: [{t:"Superación/Familia", v:-1}, {t:"Trabajo", v:0}, {t:"No sé/Obligado", v:2}] },
                    { p: "30. Tristeza/Desesperanza", ops: [{t:"Nunca/Poco", v:0}, {t:"Varios días", v:1}, {t:"Casi todos los días", v:3}] },
                    { p: "34. Amigos en escuela", ops: [{t:"Sí tengo", v:-1}, {t:"Pocos", v:1}, {t:"Ninguno", v:2}] },
                    { p: "35. Bullying/Acoso", ops: [{t:"Nunca", v:0}, {t:"Alguna vez", v:1}, {t:"Frecuente", v:3}] },
                    { p: "36. Sustancias", ops: [{t:"No", v:0}, {t:"Ocasional", v:2}, {t:"Frecuente", v:3}] },
                    { p: "38. Autolesión/Muerte", ops: [{t:"Nunca", v:0}, {t:"Alguna vez", v:2}, {t:"Frecuente", v:3}] },
                    { p: "41. Actividades extra", ops: [{t:"Sí", v:-1}, {t:"No", v:1}] },
                    { p: "46. ¿Deseas cita?", ops: [{t:"No por ahora", v:0}, {t:"Sí, me gustaría", v:0}] }
                ]
            },
            'CSSRS': { id: 'CSSRS', titulo: 'Escala Columbia para Eval. del Riesgo Suicida (C-SSRS)', icono: 'ph-warning-octagon', tipo: 'columbia_flow', instrucciones: 'Deseamos saber cómo te has sentido el ÚLTIMO MES. Por favor, responde con sí o no a las siguientes preguntas sobre pensamientos y conductas.',
                items: [
                    { p: "1. ¿Ha deseado estar muerto?", id: "q1" },
                    { p: "2. ¿Ha tenido pensamientos de suicidio?", id: "q2", triggers: ["q3", "q4", "q5"] },
                    { p: "3. ¿Ha pensado en cómo hacerlo?", id: "q3", hidden: true },
                    { p: "4. ¿Ha tenido alguna intención de actuar?", id: "q4", hidden: true },
                    { p: "5. ¿Tiene un plan específico?", id: "q5", hidden: true },
                    { p: "6. CONDUCTA: ¿Ha hecho algo alguna vez?", id: "q6", triggers: ["q6b"] },
                    { p: "6b. ¿En los últimos 3 meses?", id: "q6b", hidden: true }
                ]
            },
            'BDI': { id: 'BDI', titulo: 'Inventario de Depresión de Beck (BDI-II)', icono: 'ph-cloud-rain', tipo: 'opcion_multiple_valorada', instrucciones: 'Este cuestionario consta de 21 grupos de afirmaciones. Lea con atención cada uno de ellos cuidadosamente y elija uno de cada grupo que mejor describa cómo se ha sentido DURANTE LAS DOS ÚLTIMAS SEMANAS.',
                items: [
                    { p: "1. Tristeza", ops: [{t:"No me siento triste.", v:0}, {t:"Me siento triste gran parte del tiempo.", v:1}, {t:"Me siento triste todo el tiempo.", v:2}, {t:"Me siento tan triste o desgraciado que no puedo soportarlo.", v:3}] },
                    { p: "2. Pesimismo", ops: [{t:"No estoy desalentado respecto a mi futuro.", v:0}, {t:"Me siento más desalentado respecto de mi futuro que lo habitual.", v:1}, {t:"No espero que las cosas funcionen para mi.", v:2}, {t:"Siento que no hay esperanza para mi futuro y que sólo puede empeorar.", v:3}] },
                    { p: "3. Fracaso", ops: [{t:"No me siento como un fracasado.", v:0}, {t:"He fracasado más de lo que hubiera debido.", v:1}, {t:"Cuando miro hacia atrás, veo muchos fracasos.", v:2}, {t:"Siento que como persona soy un fracaso total.", v:3}] },
                    { p: "4. Pérdida de Placer", ops: [{t:"Obtengo tanto placer como siempre por las cosas.", v:0}, {t:"No disfruto tanto de las cosas como solía hacerlo.", v:1}, {t:"Obtengo muy poco placer de las cosas que solía disfrutar.", v:2}, {t:"No puedo obtener ningún placer de las cosas.", v:3}] },
                    { p: "5. Sentimientos de Culpa", ops: [{t:"No me siento particularmente culpable.", v:0}, {t:"Me siento culpable respecto de varias cosas que he hecho.", v:1}, {t:"Me siento bastante culpable la mayor parte del tiempo.", v:2}, {t:"Me siento culpable todo el tiempo.", v:3}] },
                    { p: "6. Sentimientos de Castigo", ops: [{t:"No siento que este siendo castigado.", v:0}, {t:"Siento que tal vez pueda ser castigado.", v:1}, {t:"Espero ser castigado.", v:2}, {t:"Siento que estoy siendo castigado.", v:3}] },
                    { p: "7. Disconformidad con uno mismo", ops: [{t:"Siento lo mismo que siempre respecto a mi mismo.", v:0}, {t:"He perdido confianza en mí mismo.", v:1}, {t:"Estoy decepcionado conmigo mismo.", v:2}, {t:"No me gusto a mí mismo.", v:3}] },
                    { p: "8. Autocrítica", ops: [{t:"No me critico ni me culpo más de lo habitual.", v:0}, {t:"Soy más crítico conmigo mismo de lo que solía ser.", v:1}, {t:"Me critico a mí mismo por todos mis errores.", v:2}, {t:"Me culpo a mí mismo por todo lo malo que sucede.", v:3}] },
                    { p: "9. Pensamientos Suicidas", ops: [{t:"No tengo ningún pensamiento de matarme.", v:0}, {t:"He tenido pensamientos de matarme, pero no lo haría.", v:1}, {t:"Me gustaría matarme.", v:2}, {t:"Me mataría si tuviera la oportunidad.", v:3}] },
                    { p: "10. Llanto", ops: [{t:"No lloro más de lo que solía hacerlo.", v:0}, {t:"Lloro más de lo que solía hacerlo.", v:1}, {t:"Lloro por cualquier pequeñez.", v:2}, {t:"Siento ganas de llorar pero no puedo.", v:3}] },
                    { p: "11. Agitación", ops: [{t:"No estoy más inquieto o tenso que lo habitual.", v:0}, {t:"Me siento más inquieto o tenso que lo habitual.", v:1}, {t:"Estoy tan inquieto o agitado que me es difícil quedarme quieto.", v:2}, {t:"Estoy tan inquieto o agitado que tengo que estar moviéndome.", v:3}] },
                    { p: "12. Pérdida de Interés", ops: [{t:"No he perdido el interés en otras actividades o personas.", v:0}, {t:"Estoy menos interesado que antes en otras personas o cosas.", v:1}, {t:"He perdido casi todo el interés en otras personas o cosas.", v:2}, {t:"Me es difícil interesarme por cualquier cosa.", v:3}] },
                    { p: "13. Indecisión", ops: [{t:"Tomo mis decisiones tan bien como siempre.", v:0}, {t:"Me resulta más difícil que de costumbre tomar decisiones.", v:1}, {t:"Encuentro mucha más dificultad que antes para tomar decisiones.", v:2}, {t:"Tengo problemas para tomar cualquier decisión.", v:3}] },
                    { p: "14. Desvalorización", ops: [{t:"No siento que yo no sea valioso.", v:0}, {t:"No me considero tan valioso y útil como solía ser.", v:1}, {t:"Me siento menos valioso cuando me comparo con otros.", v:2}, {t:"Siento que no valgo nada.", v:3}] },
                    { p: "15. Pérdida de Energía", ops: [{t:"Tengo tanta energía como siempre.", v:0}, {t:"Tengo menos energía que la que solía tener.", v:1}, {t:"No tengo suficiente energía para hacer demasiado.", v:2}, {t:"No tengo energía suficiente para hacer nada.", v:3}] },
                    { p: "16. Cambios en el Sueño", ops: [{t:"No he experimentado ningún cambio en mis hábitos de sueño.", v:0}, {t:"Duermo un poco más/menos de lo habitual.", v:1}, {t:"Duermo mucho más/menos de lo habitual.", v:2}, {t:"Duermo la mayor parte del día / Me despierto muy temprano y no puedo volver a dormir.", v:3}] },
                    { p: "17. Irritabilidad", ops: [{t:"No estoy más irritable que lo habitual.", v:0}, {t:"Estoy más irritable que lo habitual.", v:1}, {t:"Estoy mucho más irritable que lo habitual.", v:2}, {t:"Estoy irritable todo el tiempo.", v:3}] },
                    { p: "18. Cambios en el Apetito", ops: [{t:"No he experimentado ningún cambio en mi apetito.", v:0}, {t:"Mi apetito es un poco menor/mayor que lo habitual.", v:1}, {t:"Mi apetito es mucho menor/mayor que lo habitual.", v:2}, {t:"No tengo apetito en absoluto / Quiero comer todo el tiempo.", v:3}] },
                    { p: "19. Dificultad de Concentración", ops: [{t:"Puedo concentrarme tan bien como siempre.", v:0}, {t:"No puedo concentrarme tan bien como habitualmente.", v:1}, {t:"Me es difícil mantener la mente en algo por mucho tiempo.", v:2}, {t:"Encuentro que no puedo concentrarme en nada.", v:3}] },
                    { p: "20. Cansancio o Fatiga", ops: [{t:"No estoy más cansado o fatigado que lo habitual.", v:0}, {t:"Me fatigo o canso más fácilmente que lo habitual.", v:1}, {t:"Estoy demasiado fatigado o cansado para hacer muchas cosas.", v:2}, {t:"Estoy demasiado fatigado o cansado para hacer la mayoría de las cosas.", v:3}] },
                    { p: "21. Pérdida de Interés en el Sexo", ops: [{t:"No he notado ningún cambio reciente en mi interés por el sexo.", v:0}, {t:"Estoy menos interesado en el sexo de lo que solía estar.", v:1}, {t:"Estoy mucho menos interesado en el sexo ahora.", v:2}, {t:"He perdido completamente el interés en el sexo.", v:3}] }
                ]
            },
            'EBMA': { id: 'EBMA', titulo: 'Escala de Motivación Académica (EBMA)', icono: 'ph-lightning', tipo: 'likert_1_5', instrucciones: 'A continuación hay 25 afirmaciones sobre tu motivación hacia la escuela. Indica qué tan de acuerdo estás con cada una (1=Totalmente en Desacuerdo, 5=Totalmente de Acuerdo).',
                items: [
                    "Disfruto mucho aprendiendo cosas nuevas", "Me da satisfacción personal superar retos académicos difíciles", "Me gusta lo que estudio, especialmente las materias de mi especialidad", "Siento curiosidad por conocer más sobre los temas que vemos", "Me emociona descubrir cosas que no sabía",
                    "Sé que es importante para mi futuro profesional", "Me ayudará a conseguir el trabajo que quiero", "Quiero ser alguien preparado y con conocimientos", "Es el camino para lograr mis metas personales", "Me permitirá ayudar mejor a mi familia y comunidad",
                    "Me sentiría mal conmigo mismo si no lo hago", "No quiero decepcionar a mi familia", "Es lo que se espera de alguien de mi edad", "Me sentiría culpable si desperdicio esta oportunidad", "Quiero que mis padres se sientan orgullosos de mí",
                    "Mis padres me obligan a venir", "Es obligatorio hasta los 18 años", "Para evitar problemas o castigos en casa", "No tengo otra opción", "Me quitan privilegios si no vengo",
                    "Honestamente, no sé para qué vengo", "Siento que pierdo el tiempo aquí", "No le veo sentido a seguir estudiando", "Creo que la escuela no me sirve para nada", "Ya no me importa si termino o no"
                ]
            },
            'GOCA': { id: 'GOCA', titulo: 'Guía de Observación Conductual (GOCA - Docente)', icono: 'ph-binoculars', tipo: 'likert_0_3', instrucciones: 'Instrumento para que docentes evalúen conductas observadas en el estudiante. Escala: 0=No observado, 1=Raramente, 2=Frecuentemente, 3=Constantemente.',
                items: [
                    "Participa activamente en clase", "Completa tareas y trabajos asignados", "Sigue instrucciones del docente", "Se relaciona positivamente con compañeros", "Respeta las normas de convivencia",
                    "Muestra interés en los temas", "Tiene dificultad para concentrarse", "Presenta conductas disruptivas", "Falta frecuentemente a clase", "Presenta trabajos de calidad",
                    "Demuestra esfuerzo en sus actividades", "Solicita ayuda cuando la necesita", "Es responsable con sus compromisos", "Muestra respeto hacia la autoridad", "Colabora en trabajo grupal"
                ]
            },
            'LIRA': { id: 'LIRA', titulo: 'Lista de Riesgo Académico (LIRA)', icono: 'ph-triangle-warning', tipo: 'opcion_multiple_valorada', instrucciones: 'Cuestionario para identificar factores que puedan afectar el desempeño académico del estudiante.',
                items: [
                    {t: "1. Situación económica familiar", o: [{v:-1, t:"Estable"}, {v:0, t:"Regular"}, {v:2, t:"Inestable"}, {v:3, t:"Crítica"}]},
                    {t: "2. Apoyo familiar para estudios", o: [{v:-1, t:"Fuerte"}, {v:0, t:"Moderado"}, {v:2, t:"Débil"}, {v:3, t:"Nulo"}]},
                    {t: "3. Desempeño académico previo", o: [{v:-1, t:"Excelente"}, {v:0, t:"Bueno"}, {v:2, t:"Regular"}, {v:3, t:"Deficiente"}]},
                    {t: "4. Horas dedicadas a estudio extraclase", o: [{v:-1, t:">10 horas/semana"}, {v:0, t:"5-10 horas"}, {v:2, t:"1-5 horas"}, {v:3, t:"Ninguna"}]},
                    {t: "5. Acceso a tecnología/internet", o: [{v:-1, t:"Sí, ambos"}, {v:0, t:"Solo uno"}, {v:2, t:"Acceso limitado"}, {v:3, t:"Ninguno"}]},
                    {t: "6. Situaciones estresantes recientes", o: [{v:0, t:"Ninguna"}, {v:1, t:"Leve"}, {v:2, t:"Moderada"}, {v:3, t:"Severa"}]},
                    {t: "7. Conductas de riesgo (sustancias, etc.)", o: [{v:0, t:"Ninguna"}, {v:2, t:"Ocasional"}, {v:3, t:"Frecuente"}]},
                    {t: "8. Ideación o conducta suicida", o: [{v:0, t:"No"}, {v:2, t:"Alguna vez"}, {v:3, t:"Frecuente"}]}
                ]
            }
        };

        // ============================================
        // 1.1. MAPEO CENTRALIZADO DE ESTILOS DE PRUEBA
        // ============================================
        const COLOR_MAP = {
            'CSSRS': { icon: 'bg-red-100 text-red-700', text: 'text-red-600', hover: 'hover:bg-red-50' },
            'SSI': { icon: 'bg-red-100 text-red-700', text: 'text-red-600', hover: 'hover:bg-red-50' },
            'PLUTCHIK': { icon: 'bg-red-100 text-red-700', text: 'text-red-600', hover: 'hover:bg-red-50' },
            'BDI': { icon: 'bg-blue-100 text-blue-700', text: 'text-blue-600', hover: 'hover:bg-blue-50' },
            'PHQ9': { icon: 'bg-blue-100 text-blue-700', text: 'text-blue-600', hover: 'hover:bg-blue-50' },
            'GAD7': { icon: 'bg-blue-100 text-blue-700', text: 'text-blue-600', hover: 'hover:bg-blue-50' },
            'HADS': { icon: 'bg-blue-100 text-blue-700', text: 'text-blue-600', hover: 'hover:bg-blue-50' },
            'EBMA': { icon: 'bg-teal-100 text-teal-700', text: 'text-teal-600', hover: 'hover:bg-teal-50' },
            'IDARE': { icon: 'bg-idare-800 text-white', text: 'text-idare-800', hover: 'hover:bg-idare-50' },
            'BAI': { icon: 'bg-yellow-100 text-yellow-700', text: 'text-yellow-600', hover: 'hover:bg-yellow-50' },
            'IPA': { icon: 'bg-yellow-100 text-yellow-700', text: 'text-yellow-600', hover: 'hover:bg-yellow-50' },
            'default': { icon: 'bg-slate-100 text-slate-600', text: 'text-brand-600', hover: 'hover:bg-brand-50' }
        };

        // ============================================
        // 2. CONTROLADOR GENERAL (AJUSTADO)
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const configHash = params.get('config');

            if (configHash) {
                // Si hay config, ocultamos el admin y mostramos el alumno
                document.getElementById('view-admin').classList.add('hidden'); 
                iniciarModoAlumno(configHash);
            }
            else {
                // Si NO hay config, aseguramos que el alumno esté oculto y mostramos el admin
                document.getElementById('view-student').classList.add('hidden'); 
                iniciarModoAdmin();
            }
        });

        // ============================================
        // 3. LOGICA ADMIN (AJUSTADA)
        // ============================================
        function iniciarModoAdmin() {
            // El elemento 'view-admin' ya es visible por defecto en el HTML (la corrección del bug)
            
            const container = document.getElementById('tests-checklist');
            let html = '';
            for (const key in CATALOGO_PRUEBAS) {
                const t = CATALOGO_PRUEBAS[key];
                const styles = COLOR_MAP[key] || COLOR_MAP.default;
                html += `
                <div class="flex items-center gap-2 p-3 border border-slate-200 rounded-xl ${styles.hover} transition-all bg-white shadow-sm">
                    <label class="flex-1 flex items-center cursor-pointer">
                        <input type="checkbox" value="${key}" class="w-5 h-5 ${styles.text.replace('text-', 'text-')} rounded border-gray-300 admin-test-check">
                        <div class="ml-3 flex-1">
                            <span class="block text-sm font-bold text-slate-700">${t.titulo}</span>
                            <span class="block text-[10px] text-slate-400">${t.items.length} preguntas</span>
                        </div>
                        <i class="ph-bold ${t.icono} text-xl ${styles.text} mr-2"></i>
                    </label>
                    <button onclick="previewTest('${key}')" class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors" title="Ver Prueba">
                        <i class="ph-bold ph-eye text-lg"></i>
                    </button>
                </div>`;
            }
            container.innerHTML = html;
            renderizarTablaExpedientes();
        }

        // --- PREVIEW LOGIC (Inalterada) ---
        function previewTest(tid) {
            const test = CATALOGO_PRUEBAS[tid];
            document.getElementById('preview-title').innerText = test.titulo;
            document.getElementById('preview-instructions').innerText = test.instrucciones;
            const container = document.getElementById('preview-content');
            container.innerHTML = '';
            
            const styles = COLOR_MAP[tid] || COLOR_MAP.default;
            
            test.items.forEach((item, idx) => {
                const num = idx + 1;
                if(tid === 'IDARE' && idx === 20) container.innerHTML += `<div class="py-4 text-center"><span class="bg-idare-800 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest">Parte 2: Generalmente</span></div>`;

                if (test.tipo === 'columbia_flow') {
                    container.innerHTML += `
                    <div id="${item.id}_block" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-sm font-bold text-slate-800 mb-2">${item.p}</p>
                        <div class="flex gap-4">
                            <div class="w-full h-10 rounded border border-slate-200 bg-red-50 text-red-700 font-bold flex items-center justify-center text-xs">SI</div>
                            <div class="w-full h-10 rounded border border-slate-200 bg-green-50 text-green-700 font-bold flex items-center justify-center text-xs">NO</div>
                        </div>
                        ${item.hidden ? '<p class="text-[10px] text-red-400 mt-2 italic">* Pregunta condicional (oculta por defecto)</p>' : ''}
                    </div>`;
                } else {
                    let optsHTML = '';
                    if(test.tipo.includes('likert') || test.tipo === 'verdadero_falso') {
                        let scale = test.tipo==='likert_1_5'?[1,2,3,4,5] : test.tipo==='likert_1_4'?[1,2,3,4] : test.tipo==='verdadero_falso'?['V','F'] : [0,1,2,3];
                        optsHTML = `<div class="grid grid-cols-${scale.length} gap-1 mt-2">${scale.map(v=>`<div class="h-8 border rounded flex items-center justify-center text-xs text-slate-400 font-bold">${v}</div>`).join('')}</div>`;
                    } else if (test.tipo === 'opcion_multiple' || test.tipo === 'opcion_multiple_valorada' || test.tipo === 'ssi_flow') {
                        const ops = (test.tipo === 'ssi_flow') ? item.o : (item.ops || item.o) ;
                        optsHTML = `<div class="mt-2 space-y-1">${ops.map(o => `<div class="p-2 border rounded bg-slate-50 text-xs text-slate-500">${o.t || o}</div>`).join('')}</div>`;
                    }
                    const qTxt = item.p || item.t || item;
                    container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <p class="text-xs font-bold text-slate-700"><span class="${styles.text}">${num}.</span> ${qTxt}</p>
                        ${optsHTML}
                    </div>`;
                }
            });
            toggleModal('preview-modal');
        }

        // --- EXPEDIENTES LOGIC (Inalterada) ---
        function renderizarTablaExpedientes() {
            const db = getDB();
            const tbody = document.getElementById('db-body');
            document.getElementById('db-count').innerText = db.length;
            tbody.innerHTML = '';
            
            if(db.length===0) return document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            db.forEach((exp, i) => {
                let tags = '';
                for(const [tid, res] of Object.entries(exp.resultados)) {
                    let color = 'bg-slate-100 text-slate-600';
                    let txt = `${tid}: ${res.score}`; 
                    
                    // Colores de Tags basados en Diagnóstico (Texto en res.score)
                    if(String(res.score).includes("CRÍTICO") || String(res.score).includes("SUICIDA")) color = 'bg-red-600 text-white font-bold';
                    else if(String(res.score).includes("GRAVE") || String(res.score).includes("Severa")) color = 'bg-blue-600 text-white font-bold';
                    else if(String(res.score).includes("Alto")) color = 'bg-orange-100 text-orange-800';
                    else if(tid==='IDARE') color = 'bg-idare-100 text-idare-800 border border-idare-600';
                    else if(String(res.score).includes("Moderada") || String(res.score).includes("Leve") || String(res.score).includes("BORDE")) color = 'bg-yellow-100 text-yellow-800';
                    else if(String(res.score).includes("Intrínseca")) color = 'bg-green-100 text-green-800';
                    
                    tags += `<span class="inline-block px-2 py-0.5 rounded text-[10px] ${color} mr-1 mb-1 border border-transparent">${txt}</span>`;
                }
                tbody.innerHTML += `
                <tr class="hover:bg-slate-50 border-b border-slate-50 transition-colors">
                    <td class="px-6 py-4">
                        <p class="font-bold text-slate-800 text-sm">${exp.nombre}</p>
                        <p class="text-xs text-slate-400">${exp.grupo} • ${exp.edad || '?'} años (${exp.sexo || '?'})</p>
                    </td>
                    <td class="px-6 py-4">${tags}</td>
                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                        <button onclick="verExpediente(${i})" class="bg-white border border-slate-200 text-slate-600 hover:text-brand-600 hover:border-brand-200 p-2 rounded-lg transition-all shadow-sm" title="Ver Detalles"><i class="ph-bold ph-folder-open text-lg"></i></button>
                        <button onclick="if(confirm('¿Borrar expediente permanentemente?')) { let d=getDB(); d.splice(${i},1); saveDB(d); renderizarTablaExpedientes(); }" class="bg-white border border-slate-200 text-slate-400 hover:text-red-500 hover:border-red-200 p-2 rounded-lg transition-all shadow-sm"><i class="ph-bold ph-trash text-lg"></i></button>
                    </td>
                </tr>`;
            });
        }

        function verExpediente(idx) {
            const db = getDB();
            const exp = db[idx];
            document.getElementById('detail-name').innerText = exp.nombre;
            document.getElementById('detail-meta').innerText = `Grupo: ${exp.grupo} | Edad: ${exp.edad||'--'} | Sexo: ${exp.sexo||'--'} | Fecha: ${exp.ultimaFecha}`;
            
            const content = document.getElementById('detail-content');
            content.innerHTML = '';
            
            for(const [tid, res] of Object.entries(exp.resultados)) {
                const tMeta = CATALOGO_PRUEBAS[tid];
                const styles = COLOR_MAP[tid] || COLOR_MAP.default;
                
                let cardClass = "bg-white border-l-4 border-slate-400";
                
                const baseColor = styles.text.replace('text-', '').split('-')[0];
                const lightBg = `${baseColor}-50`;
                const darkBorder = `${baseColor}-500`;
                
                cardClass = `bg-${lightBg} border-l-4 border-${darkBorder}`;
                if(tid==='IDARE') cardClass = "bg-idare-50 border-l-4 border-idare-800";
                if(tid==='BHS' || tid==='PLUTCHIK' || tid==='SSI' || tid==='CSSRS') {
                    if (String(res.score).includes("CRÍTICO") || String(res.score).includes("Alto")) {
                        cardClass = "bg-red-50 border-l-4 border-red-500";
                    }
                }

                content.innerHTML += `
                <div class="${cardClass} p-5 rounded-r-xl shadow-sm border-y border-r border-slate-100">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <i class="ph-fill ${tMeta.icono} text-xl opacity-70"></i>
                            <h4 class="font-bold text-slate-700">${tMeta.titulo}</h4>
                        </div>
                        <span class="bg-white px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-slate-100">${res.score}</span>
                    </div>
                    <div class="bg-white/50 p-3 rounded-lg border border-slate-200/50">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Respuestas Crudas:</p>
                        <p class="font-mono text-xs text-slate-600 break-all leading-relaxed tracking-wide">${Array.isArray(res.raw) ? res.raw.join(' · ') : res.raw}</p>
                    </div>
                </div>`;
            }
            toggleModal('detail-modal');
        }

        // --- COMMON UTILS (Inalteradas) ---
        function toggleModal(id) {
            const m = document.getElementById(id);
            if(m.classList.contains('hidden')) {
                m.classList.remove('hidden');
            } else {
                m.classList.add('hidden');
            }
        }

        function generarLinkBateria() {
            const n = document.getElementById('adm-nombre').value.trim();
            const g = document.getElementById('adm-grupo').value.trim();
            const ts = Array.from(document.querySelectorAll('.admin-test-check:checked')).map(cb => cb.value);
            if (!n || !g || ts.length === 0) return alert("Faltan datos");
            
            const hash = btoa(encodeURIComponent(JSON.stringify({ n, g, ts })));
            document.getElementById('link-result-area').classList.remove('hidden');
            document.getElementById('final-link').value = `${window.location.href.split('?')[0]}?config=${hash}`;
        }

        function copiarLink() {
            const t = document.getElementById("final-link"); t.select(); document.execCommand("copy");
        }
        function enviarWhatsAppLink() {
            const link = document.getElementById("final-link").value;
            const nom = document.getElementById('adm-nombre').value;
            window.open(`https://wa.me/?text=${encodeURIComponent(`Hola ${nom}, link de evaluación: ${link}`)}`, '_blank');
        }

        // ============================================
        // 4. LOGICA ALUMNO ACTUALIZADA (FLUJO)
        // ============================================
        let sessionData = { nombre: '', grupo: '', edad: '', sexo: '', testsIds: [], respuestas: {} };
        let currentTestIndex = 0;

        function iniciarModoAlumno(hash) {
            try {
                const c = JSON.parse(decodeURIComponent(atob(hash)));
                sessionData = { ...sessionData, nombre: c.n, grupo: c.g, testsIds: c.ts };
                
                // Mostramos la vista del estudiante
                document.getElementById('view-student').classList.remove('hidden');
                
                document.getElementById('read-name').value = c.n;
                document.getElementById('read-group').value = c.g;
                document.getElementById('welcome-name').innerText = c.n.split(' ')[0];
                
                const list = document.getElementById('test-list-preview');
                list.innerHTML = '';
                c.ts.forEach(tid => {
                    const t = CATALOGO_PRUEBAS[tid];
                    const styles = COLOR_MAP[tid] || COLOR_MAP.default;
                    list.innerHTML += `<div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><i class="ph-bold ${t.icono} ${styles.text}"></i><span class="text-sm font-bold text-slate-700">${t.titulo}</span></div>`;
                });
            } catch (e) { 
                alert("Link de configuración inválido o incompleto. Volviendo al gestor."); 
                // Usamos location.href para recargar la página sin el parámetro 'config'
                window.location.href = window.location.href.split('?')[0];
            }
        }

        function iniciarSecuencia() {
            const age = document.getElementById('st-age').value;
            const sex = document.getElementById('st-sex').value;
            
            if(!age || !sex) return alert("Por favor completa tu Edad y Sexo.");
            
            sessionData.edad = age;
            sessionData.sexo = sex;

            document.getElementById('ficha-nombre').innerText = sessionData.nombre;
            document.getElementById('ficha-grupo').innerText = sessionData.grupo;
            document.getElementById('ficha-edad').innerText = age;
            document.getElementById('ficha-sexo').innerText = sex;
            document.getElementById('ficha-fecha').innerText = new Date().toLocaleDateString();

            document.getElementById('step-welcome').classList.add('hidden');
            document.getElementById('step-questions').classList.remove('hidden');
            cargarPruebaActual();
        }

        function cargarPruebaActual() {
            const testId = sessionData.testsIds[currentTestIndex];
            const test = CATALOGO_PRUEBAS[testId];
            const styles = COLOR_MAP[testId] || COLOR_MAP.default;
            
            document.getElementById('current-test-icon-box').className = `p-3 rounded-lg ${styles.icon}`;
            document.getElementById('current-test-title').innerText = test.titulo;
            document.getElementById('current-test-desc').innerText = test.instrucciones;
            document.getElementById('current-test-icon').className = `ph-fill ${test.icono} text-2xl`;

            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            const pct = Math.round((currentTestIndex / sessionData.testsIds.length) * 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('st-progress').innerText = `${pct}%`;
            
            const mainColor = styles.text.replace('text-', '');
            
            test.items.forEach((item, idx) => {
                const num = idx + 1;
                
                if(testId === 'IDARE' && idx === 20) {
                     container.innerHTML += `<div class="py-4 text-center"><span class="bg-idare-800 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest">Parte 2: Generalmente</span></div>`;
                }

                if (test.tipo === 'columbia_flow') {
                    const hidden = item.hidden ? 'hidden' : '';
                    const trig = item.triggers ? JSON.stringify(item.triggers) : '[]';
                    container.innerHTML += `
                    <div id="${item.id}_block" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm ${hidden}">
                        <p class="text-lg font-bold text-slate-800 mb-4">${item.p}</p>
                        <div class="flex gap-4">
                            <label class="columbia-btn flex-1 cursor-pointer"><input type="radio" name="${item.id}" value="1" class="peer sr-only" onchange='columbiaLogic(this, ${trig})'><div class="h-14 rounded-xl border-2 border-slate-100 bg-red-50 text-red-700 font-bold flex items-center justify-center peer-checked:bg-red-600 peer-checked:text-white transition-colors">SI</div></label>
                            <label class="columbia-btn flex-1 cursor-pointer"><input type="radio" name="${item.id}" value="0" class="peer sr-only" onchange='columbiaLogic(this, ${trig})'><div class="h-14 rounded-xl border-2 border-slate-100 bg-green-50 text-green-700 font-bold flex items-center justify-center peer-checked:bg-green-600 peer-checked:text-white transition-colors">NO</div></label>
                        </div>
                    </div>`;
                } else if (test.tipo === 'ssi_flow') {
                    const opts = item.o || [];
                    let html = `<div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-sm font-semibold text-slate-800 mb-4 flex gap-2"><span class="text-red-600 font-bold">${num}.</span> ${item.t}</p>
                        <div class="space-y-2">`;
                    opts.forEach((opt, opIdx) => {
                        html += `<label class="flex items-start gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-red-50 transition-all bg-slate-50/50">
                            <div class="relative flex items-center justify-center w-5 h-5 mt-0.5 rounded-full border border-slate-300 bg-white shrink-0"><input type="radio" name="q_${testId}_${idx}" value="${opt.v}" class="peer appearance-none w-full h-full cursor-pointer absolute z-10 opacity-0"><div class="w-3 h-3 rounded-full bg-red-600 opacity-0 peer-checked:opacity-100 transition-opacity"></div></div>
                            <span class="text-xs font-medium text-slate-600">${opt.t}</span>
                        </label>`;
                    });
                    html += `</div></div>`;
                    container.innerHTML += html;
                } else if (test.tipo === 'likert_0_3') {
                    container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-sm font-semibold text-slate-800 mb-4 flex gap-2"><span class="${mainColor} font-bold">${num}.</span> ${item}</p>
                        <div class="grid grid-cols-4 gap-2 bg-slate-50 p-2 rounded-xl">
                            ${[0,1,2,3].map(v => `<label class="cursor-pointer relative group"><input type="radio" name="q_${testId}_${idx}" value="${v}" class="peer sr-only"><div class="h-10 w-full rounded-lg border border-slate-200 bg-white text-slate-400 font-bold text-sm flex items-center justify-center peer-checked:bg-${mainColor} peer-checked:text-white transition-all shadow-sm">${v}</div></label>`).join('')}
                        </div>
                    </div>`;
                } else if (test.tipo === 'likert_1_4') { 
                    const colors = "peer-checked:bg-idare-800 peer-checked:text-white";
                    container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-sm font-semibold text-slate-800 mb-4 flex gap-2"><span class="text-idare-800 font-bold">${num}.</span> ${item}</p>
                        <div class="grid grid-cols-4 gap-2 bg-slate-50 p-2 rounded-xl">
                            ${[1,2,3,4].map(v => `<label class="cursor-pointer relative group"><input type="radio" name="q_${testId}_${idx}" value="${v}" class="peer sr-only"><div class="h-10 w-full rounded-lg border border-slate-200 bg-white text-slate-400 font-bold text-sm flex items-center justify-center ${colors} transition-all shadow-sm">${v}</div></label>`).join('')}
                        </div>
                         <div class="flex justify-between px-2 mt-1 text-[9px] text-gray-400 font-medium"><span>No / Casi Nunca</span><span>Mucho / Casi Siempre</span></div>
                    </div>`;
                } else if (test.tipo === 'likert_1_5') { 
                    const tealColor = COLOR_MAP.EBMA.text.replace('text-', '');
                    container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-sm font-semibold text-slate-800 mb-4 flex gap-2"><span class="${tealColor} font-bold">${num}.</span> ${item}</p>
                        <div class="grid grid-cols-5 gap-2 bg-slate-50 p-2 rounded-xl">
                            ${[1,2,3,4,5].map(v => `<label class="cursor-pointer relative group"><input type="radio" name="q_${testId}_${idx}" value="${v}" class="peer sr-only"><div class="h-10 w-full rounded-lg border border-slate-200 bg-white text-slate-400 font-bold text-sm flex items-center justify-center peer-checked:bg-${tealColor} peer-checked:text-white transition-all shadow-sm">${v}</div></label>`).join('')}
                        </div>
                        <div class="flex justify-between px-2 mt-1 text-[9px] text-gray-400 font-medium"><span>T.Desacuerdo</span><span>T.Acuerdo</span></div>
                    </div>`;
                } else if (test.tipo === 'verdadero_falso') {
                    container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-sm font-semibold text-slate-800 mb-4 flex gap-2"><span class="${mainColor} font-bold">${num}.</span> ${item}</p>
                        <div class="flex gap-4 bg-slate-50 p-3 rounded-xl">
                            <label class="cursor-pointer flex-1"><input type="radio" name="q_${testId}_${idx}" value="V" class="peer sr-only"><div class="h-12 rounded-xl border border-slate-300 bg-white text-slate-500 font-bold flex items-center justify-center gap-2 peer-checked:bg-green-600 peer-checked:text-white transition-colors">SÍ</div></label>
                            <label class="cursor-pointer flex-1"><input type="radio" name="q_${testId}_${idx}" value="F" class="peer sr-only"><div class="h-12 rounded-xl border border-slate-300 bg-white text-slate-500 font-bold flex items-center justify-center gap-2 peer-checked:bg-red-500 peer-checked:text-white transition-colors">NO</div></label>
                        </div>
                    </div>`;
                } else if (test.tipo === 'opcion_multiple_valorada' || test.tipo === 'opcion_multiple') {
                    const qTxt = item.t || item.p || item;
                    const ops = item.o || item.ops || [];
                    let html = `<div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-sm font-semibold text-slate-800 mb-4 flex gap-2"><span class="${mainColor} font-bold">${num}.</span> ${qTxt}</p>
                        <div class="space-y-2">`;
                    ops.forEach((opt, opIdx) => {
                        const txt = opt.t || opt;
                        const val = opt.v !== undefined ? opt.v : opIdx;
                        html += `<label class="flex items-start gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer ${styles.hover} transition-all bg-slate-50/50">
                            <div class="relative flex items-center justify-center w-5 h-5 mt-0.5 rounded-full border border-slate-300 bg-white shrink-0"><input type="radio" name="q_${testId}_${idx}" value="${val}" class="peer appearance-none w-full h-full cursor-pointer absolute z-10 opacity-0"><div class="w-3 h-3 rounded-full bg-${mainColor} opacity-0 peer-checked:opacity-100 transition-opacity"></div></div>
                            <span class="text-xs font-medium text-slate-600">${txt}</span>
                        </label>`;
                    });
                    html += `</div></div>`;
                    container.innerHTML += html;
                }
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // Función para pasar a siguiente prueba (Inalterada)
        // ============================================
        function siguientePrueba() {
            const testId = sessionData.testsIds[currentTestIndex];
            const test = CATALOGO_PRUEBAS[testId];
            
            let respuestas = [];
            let todoResponder = true;
            
            test.items.forEach((item, idx) => {
                let respondido = false;
                let el;

                if(test.tipo === 'columbia_flow') {
                    const block = document.getElementById(`${item.id}_block`);
                    if (!block || !block.classList.contains('hidden')) {
                        el = document.querySelector(`input[name="${item.id}"]:checked`);
                        if(el) { respuestas.push(parseInt(el.value)); respondido = true; }
                        else { todoResponder = false; }
                    } else {
                        respuestas.push(0); 
                        respondido = true;
                    }
                } else {
                    el = document.querySelector(`input[name="q_${testId}_${idx}"]:checked`);
                    if(el) { 
                        if (['likert_0_3', 'likert_1_4', 'likert_1_5', 'ssi_flow', 'opcion_multiple_valorada'].includes(test.tipo)) {
                            respuestas.push(parseInt(el.value)); 
                        } else {
                            respuestas.push(el.value); 
                        }
                        respondido = true; 
                    } else { 
                        todoResponder = false; 
                    }
                }
            });
            
            if(!todoResponder) {
                alert(`Por favor responde todas las preguntas de ${test.titulo}`);
                return;
            }
            
            sessionData.respuestas[testId] = respuestas;
            currentTestIndex++;
            
            if(currentTestIndex < sessionData.testsIds.length) {
                cargarPruebaActual();
            } else {
                finalizar();
            }
        }

        // ============================================
        // Columbia Logic for CSSRS (Inalterada)
        // ============================================
        function columbiaLogic(input, triggers) {
            const triggerIds = Array.isArray(triggers) ? triggers : JSON.parse(triggers);
            
            if (input.value === '1' && triggerIds.length > 0) {
                triggerIds.forEach(tid => {
                    const block = document.getElementById(tid + '_block');
                    if (block) block.classList.remove('hidden');
                });
            } else if (input.value === '0' && triggerIds.length > 0) {
                triggerIds.forEach(tid => {
                    const block = document.getElementById(tid + '_block');
                    if (block) {
                        block.classList.add('hidden');
                        document.querySelectorAll(`input[name="${tid}"]:checked`).forEach(el => el.checked = false);
                    }
                });
            }
        }

        // ============================================
        // 5. FINALIZACIÓN Y CÁLCULO DE DIAGNÓSTICOS (Inalterada)
        // ============================================
        function enviarTokenWhatsapp() {
            const token = document.getElementById("final-token-display").innerText;
            window.open(`https://wa.me/?text=${encodeURIComponent(`Mis resultados de evaluación (código): ${token}`)}`, '_blank');
        }

        function copiarToken() {
            const t = document.getElementById("final-token-display"); 
            navigator.clipboard.writeText(t.innerText);
        }

        function finalizar() {
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('st-progress').innerText = '100%';
            
            const result = { 
                id: Date.now().toString(36), 
                alumno: sessionData.nombre, 
                grupo: sessionData.grupo,
                edad: sessionData.edad, 
                sexo: sessionData.sexo, 
                fecha: new Date().toLocaleDateString(), 
                resultados: {} 
            };
            
            sessionData.testsIds.forEach(tid => {
                const r = sessionData.respuestas[tid];
                let score = 0;
                let interpretacion = "Puntuación no procesada";
                
                if(tid === 'PHQ9') {
                    score = r.reduce((a,b)=>a+b,0);
                    let nivel = score>=20?"Depresión Grave":score>=15?"Depresión Moderada":score>=10?"Depresión Leve":"Síntomas Depresivos Mínimos";
                    interpretacion = `${score} (${nivel})`; 
                } else if(tid === 'GAD7') {
                    score = r.reduce((a,b)=>a+b,0);
                    let nivel = score>=15?"Ansiedad Grave":score>=10?"Ansiedad Moderada":score>=5?"Ansiedad Leve":"Síntomas de Ansiedad Mínimos";
                    interpretacion = `${score} (${nivel})`; 
                } else if(tid === 'HADS') {
                    let ans = 0, dep = 0;
                    r.forEach((v, i) => {
                        const val = v;
                        if([0,2,4,6,8,10,12,13].includes(i)) {
                            ans += val;
                        } else {
                            dep += (3 - val);
                        }
                    });
                    let ansN = ans>10?"CASO CLÍNICO (Ans.)":ans>7?"BORDE (Ans.)":"Normal (Ans.)";
                    let depN = dep>10?"CASO CLÍNICO (Dep.)":dep>7?"BORDE (Dep.)":"Normal (Dep.)";
                    interpretacion = `A:${ans} (${ansN}) | D:${dep} (${depN})`; 
                } else if(tid === 'SSI') {
                    score = r.reduce((a,b)=>a+b,0);
                    let nivel = score>=6?"RIESGO SUICIDA CRÍTICO":score>=3?"Riesgo Suicida Moderado":"Riesgo Suicida Bajo";
                    interpretacion = `${score} (${nivel})`; 
                } else if(tid === 'PLUTCHIK') {
                    score = r.reduce((a,b)=>a+(b==='V'?1:0),0);
                    let nivel = score>=9?"Riesgo Suicida Alto":score>=5?"Riesgo Suicida Moderado":"Riesgo Suicida Bajo";
                    interpretacion = `${score}/15 (${nivel})`; 
                } else if(tid === 'IPA') {
                    score = r.reduce((a,b)=>a+b,0);
                    let nivel = score>=100?"Distorsión Cognitiva Severa":score>=50?"Distorsión Cognitiva Moderada":"Bajo Nivel de Distorsión";
                    interpretacion = `${score} (${nivel})`; 
                } else if(tid === 'BAI') {
                    score = r.reduce((a,b)=>a+b,0);
                    let nivel = score>=30?"Ansiedad Severa":score>=16?"Ansiedad Moderada":score>=8?"Ansiedad Leve":"Ansiedad Mínima";
                    interpretacion = `${score} (${nivel})`; 
                } else if(tid === 'BHS') {
                    const directos = [2, 4, 7, 9, 11, 12, 14, 16, 17, 18, 20];
                    score = r.reduce((acc, v, i) => {
                        const qNum = i + 1;
                        if (directos.includes(qNum)) {
                            return acc + (v === 'F' ? 1 : 0);
                        } else {
                            return acc + (v === 'V' ? 1 : 0);
                        }
                    }, 0);
                    let nivel = score>=10?"Desesperanza Alta":score>=5?"Desesperanza Moderada":"Desesperanza Baja";
                    interpretacion = `${score}/20 (${nivel})`; 
                } else if(tid === 'CDFR') {
                    let sum = r.reduce((a,b)=>a+b,0); if(sum<0) sum=0;
                    let niv = sum>24?"Riesgo CRÍTICO":sum>16?"Riesgo Alto":sum>8?"Riesgo Moderado":"Riesgo Bajo";
                    interpretacion = `${sum} (${niv})`; 
                } else if(tid === 'CSSRS') {
                    interpretacion = r[5]===1 ? "RIESGO CRÍTICO (Conducta de Intento)" : r[4]===1 ? "RIESGO ALTO (Plan Específico)" : r[1]===1 ? "Riesgo Moderado (Ideación)" : "Bajo Riesgo";
                } else if (tid === 'BDI') {
                    let sum = r.reduce((a,b)=>a+b,0);
                    let niv = sum<=13?"Depresión Mínima":sum<=19?"Depresión Leve":sum<=28?"Depresión Moderada":"Depresión GRAVE";
                    if(r[8] > 0) niv += " ⚠️ Riesgo Suicida";
                    interpretacion = `${sum} (${niv})`; 
                } else if (tid === 'EBMA') {
                    const getAvg = (s,e) => { let x=0; for(let i=s;i<=e;i++) x+=r[i]; return x/5; };
                    let A=getAvg(0,4), B=getAvg(5,9), C=getAvg(10,14), D=getAvg(15,19), E=getAvg(20,24);
                    let iar = (2*A + 1*B - 1*C - 2*D).toFixed(1);
                    let p = "Motivación Mixta";
                    if(A>=4 && B>=3.5 && D<2.5) p="Motivación Intrínseca"; else if(A<2.5 && D>=4) p="Motivación Externa"; else if(E>=3.5) p="Desmotivado/Amotivación";
                    interpretacion = `IAR: ${iar} (${p})`; 
                } else if (tid === 'IDARE') {
                    const invE = [0,1,4,7,9,10,14,15,18,19]; 
                    const invR = [20,25,26,29,32,35,38];
                    let sE = 0, sR = 0;
                    r.forEach((v, i) => {
                        const val = v;
                        if(i<20) sE += invE.includes(i) ? (5-val) : val;
                        else sR += invR.includes(i-20) ? (5-val) : val;
                    });
                    let nivE = sE>=44?"Elevada":sE>=38?"Moderada":"Baja";
                    let nivR = sR>=44?"Elevada":sR>=38?"Moderada":"Baja";
                    interpretacion = `E:${sE} (${nivE}) | R:${sR} (${nivR})`; 
                } else if (tid === 'VAK') {
                    let v=0, a=0, k=0;
                    r.forEach((val) => {
                        if(String(val).includes('Visual')) v++;
                        else if(String(val).includes('Auditivo')) a++;
                        else if(String(val).includes('Kinestésico')) k++;
                    });
                    let max = Math.max(v,a,k);
                    let estilo = v===max?"Visual":a===max?"Auditivo":"Kinestésico";
                    interpretacion = `${estilo} (V:${v}, A:${a}, K:${k})`; 
                } else if (tid === 'GOCA') {
                    score = r.reduce((a,b)=>a+b,0);
                    let nivel = score>=36?"Excelente":score>=24?"Bueno":score>=12?"Regular":"Requiere apoyo";
                    interpretacion = `${score}/45 (${nivel})`; 
                } else if (tid === 'LIRA') {
                    let sum = r.reduce((a,b)=>a+b,0);
                    if(sum<0) sum = 0;
                    let niv = sum>20?"Riesgo CRÍTICO":sum>12?"Riesgo Alto":sum>5?"Riesgo Moderado":"Riesgo Bajo";
                    interpretacion = `${sum} (${niv})`; 
                } else interpretacion = r.join(',');
                
                result.resultados[tid] = { score: interpretacion, raw: r }; 
            });

            const token = btoa(encodeURIComponent(JSON.stringify(result)));
            document.getElementById('step-questions').classList.add('hidden');
            document.getElementById('step-finish').classList.remove('hidden');
            document.getElementById('final-token-display').innerText = token;
        }

        // ============================================
        // 6. IMPORTACION Y ALMACENAMIENTO LOCAL (Inalterada)
        // ============================================
        function getDB() { return JSON.parse(localStorage.getItem('cbta_suite_db') || '[]'); }
        function saveDB(d) { localStorage.setItem('cbta_suite_db', JSON.stringify(d)); }

        function procesarImportacion() {
            try {
                const token = document.getElementById('import-token-input').value.trim();
                if (!token) return alert("Por favor, pega el código completo de resultados.");
                
                const d = JSON.parse(decodeURIComponent(atob(token)));
                let db = getDB();
                
                let idx = db.findIndex(e => e.nombre === d.alumno && e.grupo === d.grupo);
                
                if(idx >= 0) { 
                    db[idx].resultados = { ...db[idx].resultados, ...d.resultados }; 
                    db[idx].ultimaFecha = d.fecha;
                    db[idx].edad = d.edad; 
                    db[idx].sexo = d.sexo; 
                } else {
                    db.push({ 
                        nombre: d.alumno, 
                        grupo: d.grupo, 
                        edad: d.edad, 
                        sexo: d.sexo, 
                        resultados: d.resultados, 
                        ultimaFecha: d.fecha 
                    });
                }
                
                saveDB(db); 
                renderizarTablaExpedientes(); 
                toggleModal('import-modal'); 
                document.getElementById('import-token-input').value = "";
                alert("✅ Datos guardados. Verifica la tabla de expedientes.");
            } catch (e) { 
                alert("Código inválido. Asegúrate de pegar el código completo generado al finalizar la evaluación."); 
                console.error("Error al procesar importación:", e); 
            }
        }
    </script>
</body>
</html>
