<script>
    // ... (CATÁLOGOS, CONSTANTES, y el resto del código hasta aquí) ...

    let currentExpedientIndex = -1; 

    // ... (Funciones de Control y Lógica Admin) ...
    
    // ============================================
    // 7. GESTIÓN DE EXPEDIENTE CLÍNICO Y CREACIÓN
    // ============================================
    
    // Función central para abrir el escritorio del expediente
    function abrirEscritorioExpediente(idx) {
        const db = getDB();
        const exp = db[idx];
        
        // CRÍTICO: Establecer el índice global inmediatamente
        currentExpedientIndex = idx;
        
        document.getElementById('detail-name').innerText = exp.nombre;
        document.getElementById('detail-meta').innerText = `Grupo: ${exp.grupo} | Edad: ${exp.edad||'--'} | Sexo: ${exp.sexo||'--'} | Última Actualización: ${exp.ultimaFecha}`;
        
        // Aseguramos que se abra el modal
        document.getElementById('detail-modal').classList.remove('hidden');
        
        // Cargar la vista de resultados por defecto
        cargarInstrumento('cuantitativo');
    }

    /**
     * Abre el Modal de Documento (Entrevista o Consentimiento)
     * @param {string} instId - ID del instrumento ('ENTREVISTA' o 'CONSENTIMIENTO').
     */
    function abrirModalCaptura(instId) {
        // Solo abrimos si ya tenemos un expediente activo
        if (currentExpedientIndex === -1) {
            alert("Error: Por favor, selecciona un expediente primero.");
            return;
        }

        // 1. Cierra el escritorio (detail-modal) si está abierto
        document.getElementById('detail-modal').classList.add('hidden');
        
        const exp = getDB()[currentExpedientIndex];
        const docMeta = CATALOGO_CLINICO[instId];
        
        document.getElementById('doc-title').innerText = docMeta.titulo;
        document.getElementById('doc-icon').className = `ph-bold ${docMeta.icono}`;
        
        // 2. Control de botones de Guardado
        document.getElementById('btn-save-ENTREVISTA').classList.add('hidden');
        document.getElementById('btn-save-CONSENTIMIENTO').classList.add('hidden');
        document.getElementById(`btn-save-${instId}`).classList.remove('hidden');

        const contentArea = document.getElementById('document-content-area');
        const data = exp.dataClinica[instId] || {};
        
        // 3. Renderizado del documento
        if (instId === 'ENTREVISTA') {
            contentArea.innerHTML = renderEntrevista(exp, data);
        } else if (instId === 'CONSENTIMIENTO') {
            contentArea.innerHTML = renderConsentimiento(exp, data);
        }
        
        // 4. Muestra el modal de documento
        document.getElementById('document-modal').classList.remove('hidden');
    }


    /**
     * Lógica para guardar los datos de un documento estructurado.
     */
    function guardarDocumento(instId) {
        const db = getDB();
        const idx = currentExpedientIndex;
        if (idx === -1 || !db[idx]) return alert("Error: Expediente no identificado.");

        const docMeta = CATALOGO_CLINICO[instId];
        let dataRecogida = {};
        let formularioCompleto = true;
        
        // 1. Recoger datos de los campos definidos en el catálogo
        docMeta.campos.forEach(campoId => {
            let valor = '';
            const inputEl = document.getElementById(campoId);
            
            if (inputEl) {
                if (inputEl.type === 'checkbox' || inputEl.type === 'radio') {
                    // Manejo de Checkboxes y Radio Buttons
                    valor = inputEl.checked ? 'true' : '';
                } else if (inputEl.tagName === 'SELECT') {
                    valor = inputEl.value;
                } else {
                    // Campos de texto, número, fecha, textarea
                    valor = inputEl.value.trim();
                }
            } else if (campoId === 'ci_autorizacion_si' || campoId === 'ci_autorizacion_no') {
                 // Manejo del grupo de Radio Buttons de autorización
                const radioGroup = 'ci_autorizacion';
                const checkedEl = document.querySelector(`input[name="${radioGroup}"]:checked`);
                dataRecogida[radioGroup] = checkedEl ? checkedEl.value : '';
                return; // Saltar el resto del bucle si es un radio button individual ya manejado por grupo
            } else if (campoId === 'ci_motivo_Rendimiento Académico' || campoId === 'ci_motivo_Orientación Vocacional' /*... otros motivos ...*/) {
                // Manejo de Checkboxes fuera del bucle de campos, ya que pueden tener el mismo name
                const groupName = 'ci_motivo'; // Nombre del grupo
                const checkedElements = document.querySelectorAll(`input[name="${groupName}"]:checked`);
                
                // Si el campo es parte de un grupo de checkboxes, ya fue recogido, simplemente pasamos
                // Esta parte requiere refactorizar el CATALOGO_CLINICO para evitar la duplicación de IDs en el loop.
                
            }
            
            // 2. Guardar valor y verificar si es requerido (si hubiéramos definido la propiedad required)
            dataRecogida[campoId] = valor;
        });

        // 3. Validación y Guardado (Simplificada por la estructura del CATALOGO_CLINICO)

        // Asumiendo que el campo 'ci_autorizacion' se recolecta correctamente como un valor único ('SI AUTORIZO' / 'NO AUTORIZO')
        const autorizacion = document.querySelector('input[name="ci_autorizacion"]:checked')?.value || '';

        if (instId === 'CONSENTIMIENTO' && autorizacion !== 'SI AUTORIZO') {
            if (!confirm("ADVERTENCIA: El consentimiento no ha sido autorizado. ¿Desea guardar el documento en este estado?")) {
                 return;
            }
        }
        
        // RECOLECCIÓN FINAL DE CHECKBOXES/RADIOS DE GRUPO
        // Recoger Checkboxes de Motivos y Procedimientos
        const motivos = document.querySelectorAll('input[name="ci_motivo"]');
        motivos.forEach(input => {
            const id = `ci_motivo_${input.value.replace(/ /g, '_')}`; // Normalizar el ID
            dataRecogida[id] = input.checked ? 'true' : '';
        });
        
        const procedimientos = document.querySelectorAll('input[name="ci_proc"]');
        procedimientos.forEach(input => {
            const id = `ci_proc_${input.value.replace(/ /g, '_')}`; // Normalizar el ID
            dataRecogida[id] = input.checked ? 'true' : '';
        });
        
        dataRecogida['ci_autorizacion'] = autorizacion; // Asegurar que la autorización esté guardada


        db[idx].dataClinica[instId] = dataRecogida;
        db[idx].ultimaFecha = new Date().toLocaleDateString();
        
        saveDB(db);
        
        document.getElementById('document-modal').classList.add('hidden'); // Ocultar modal de documento
        abrirEscritorioExpediente(idx); // Regresar al escritorio del expediente
        alert(`✅ ${docMeta.titulo} guardado exitosamente en el expediente de ${db[idx].nombre}.`);
    }
</script>
